<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>内隐联想测验 - 心社区</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 引入Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- Tailwind CSS配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#00B42A',
                        warning: '#FF7D00',
                        danger: '#F53F3F',
                        info: '#86909C',
                        light: '#F2F3F5',
                        dark: '#4E5969',
                        self: '#165DFF',
                        other: '#FF7D00',
                        positive: '#00B42A',
                        negative: '#F53F3F'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- 自定义样式 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .iat-container {
                background-color: white;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            }
            .category-box {
                transition: all 0.2s ease;
                min-height: 100px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }
            .category-box:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }
            .target-word {
                font-size: 2.5rem;
                transition: all 0.2s ease;
            }
            .key-prompt {
                font-family: monospace;
                background-color: #E5E6EB;
                padding: 0.25rem 0.5rem;
                border-radius: 4px;
                font-weight: bold;
            }
            .fade-in {
                animation: fadeIn 0.3s ease-out;
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            .word-animation {
                animation: wordPop 0.3s ease-out;
            }
            @keyframes wordPop {
                0% { transform: scale(0.9); opacity: 0; }
                70% { transform: scale(1.05); }
                100% { transform: scale(1); opacity: 1; }
            }
            .correct-feedback {
                animation: correctFlash 0.3s ease-out;
            }
            @keyframes correctFlash {
                0% { background-color: rgba(0, 180, 42, 0.2); }
                100% { background-color: transparent; }
            }
            .error-feedback {
                animation: errorFlash 0.3s ease-out;
            }
            @keyframes errorFlash {
                0% { background-color: rgba(245, 63, 63, 0.2); }
                100% { background-color: transparent; }
            }
            .progress-indicator {
                transition: width 0.1s ease;
            }
            .block-indicator {
                transition: all 0.3s ease;
            }
            .block-indicator.active {
                background-color: #165DFF;
                color: white;
            }
            .block-indicator.completed {
                background-color: #00B42A;
                color: white;
            }
        }
    </style>
<link rel="stylesheet" href="experiments-responsive.css">
</head>
<body class="bg-light min-h-screen flex flex-col">
    <!-- 导航栏组件 -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <nav id="main-nav"></nav>
    </header>

    <!-- 主要内容区域 -->
    <main class="flex-grow container mx-auto px-4 py-8">
        <!-- 页面标题 -->
        <div class="text-center mb-8">
            <h1 class="text-[clamp(1.5rem,3vw,2rem)] font-bold text-primary mb-2">内隐联想测验</h1>
            <p class="text-dark text-base">探索你的潜意识态度</p>
        </div>

        <!-- 实验容器 -->
        <div class="bg-white rounded-xl shadow-md p-6 md:p-8 max-w-4xl mx-auto">
            <!-- 准备阶段 -->
            <div id="preparation-stage" class="space-y-6">
                <div class="bg-light rounded-lg p-6">
                    <h2 class="text-xl font-bold text-dark mb-4">什么是内隐联想测验？</h2>
                    <p class="text-dark mb-4">内隐联想测验(Implicit Association Test, IAT)是一种心理学工具，用于测量概念之间的内隐关联强度，帮助揭示人们可能没有意识到或不愿承认的潜在态度。</p>
                    <p class="text-dark">本测验将测量你对积极/消极词汇与自我/他人概念之间的联想强度，通过你的反应时间差异来反映内隐态度。</p>
                </div>

                <div class="bg-light rounded-lg p-6">
                    <h2 class="text-xl font-bold text-dark mb-4">测验流程</h2>
                    <div class="space-y-4">
                        <div class="flex items-start">
                            <div class="bg-primary text-white rounded-full w-6 h-6 flex items-center justify-center mr-3 mt-0.5 flex-shrink-0">1</div>
                            <p class="text-dark">学习阶段：认识"自我"和"他人"相关词汇</p>
                        </div>
                        <div class="flex items-start">
                            <div class="bg-primary text-white rounded-full w-6 h-6 flex items-center justify-center mr-3 mt-0.5 flex-shrink-0">2</div>
                            <p class="text-dark">学习阶段：认识"积极"和"消极"相关词汇</p>
                        </div>
                        <div class="flex items-start">
                            <div class="bg-primary text-white rounded-full w-6 h-6 flex items-center justify-center mr-3 mt-0.5 flex-shrink-0">3</div>
                            <p class="text-dark">练习阶段：将词汇快速分类到对应的类别中</p>
                        </div>
                        <div class="flex items-start">
                            <div class="bg-primary text-white rounded-full w-6 h-6 flex items-center justify-center mr-3 mt-0.5 flex-shrink-0">4</div>
                            <p class="text-dark">测试阶段一：将"自我"与"积极"配对，"他人"与"消极"配对</p>
                        </div>
                        <div class="flex items-start">
                            <div class="bg-primary text-white rounded-full w-6 h-6 flex items-center justify-center mr-3 mt-0.5 flex-shrink-0">5</div>
                            <p class="text-dark">测试阶段二：将"自我"与"消极"配对，"他人"与"积极"配对</p>
                        </div>
                    </div>
                </div>

                <div class="bg-light rounded-lg p-6">
                    <h2 class="text-xl font-bold text-dark mb-4">注意事项</h2>
                    <ul class="list-disc list-inside text-dark space-y-2">
                        <li>请尽可能快速准确地作答</li>
                        <li>测试大约需要5-10分钟完成</li>
                        <li>反应时间是重要的测量指标，请专注作答</li>
                        <li>如果回答错误，会有提示，请快速改正</li>
                    </ul>
                </div>

                <div class="flex justify-center">
                    <button id="start-tutorial" class="bg-primary hover:bg-primary/90 text-white py-3 px-8 rounded-lg font-medium transition-all transform hover:scale-105">
                        开始教程
                    </button>
                </div>
            </div>

            <!-- 教程阶段 -->
            <div id="tutorial-stage" class="hidden space-y-6 fade-in">
                <div class="text-center">
                    <h2 class="text-xl font-bold text-dark mb-4">如何参加测验</h2>
                    <p class="text-dark">请仔细阅读以下说明</p>
                </div>

                <div class="iat-container p-6">
                    <div class="grid grid-cols-2 gap-6 mb-8">
                        <div class="category-box bg-primary/10 border-2 border-primary rounded-lg p-4">
                            <p class="font-bold text-primary">自我</p>
                            <div class="flex flex-wrap justify-center gap-2 mt-2">
                                <span class="bg-white px-2 py-1 rounded text-sm">我</span>
                                <span class="bg-white px-2 py-1 rounded text-sm">我的</span>
                                <span class="bg-white px-2 py-1 rounded text-sm">自己</span>
                            </div>
                            <p class="mt-3 text-dark text-sm">按 <span class="key-prompt">E</span> 键</p>
                        </div>
                        <div class="category-box bg-warning/10 border-2 border-warning rounded-lg p-4">
                            <p class="font-bold text-warning">他人</p>
                            <div class="flex flex-wrap justify-center gap-2 mt-2">
                                <span class="bg-white px-2 py-1 rounded text-sm">他们</span>
                                <span class="bg-white px-2 py-1 rounded text-sm">他的</span>
                                <span class="bg-white px-2 py-1 rounded text-sm">别人</span>
                            </div>
                            <p class="mt-3 text-dark text-sm">按 <span class="key-prompt">I</span> 键</p>
                        </div>
                    </div>

                    <div class="flex justify-center">
                        <div class="w-48 h-48 flex items-center justify-center border-2 border-gray-300 rounded-lg bg-light">
                            <p class="text-2xl text-dark">我</p>
                        </div>
                    </div>

                    <div class="text-center mt-8">
                        <p class="text-dark mb-4">示例：看到"我"时，请按 <span class="key-prompt">E</span> 键（因为属于"自我"类别）</p>
                        <p class="text-dark">在测验中，请尽可能快速准确地按键分类！</p>
                    </div>
                </div>

                <div class="bg-light rounded-lg p-4">
                    <p class="text-dark text-sm">
                        <i class="fa fa-lightbulb-o text-warning mr-2"></i>
                        记住：反应速度越快，说明概念之间的内隐联想越强。请在确保准确的前提下尽量快速反应。
                    </p>
                </div>

                <div class="flex justify-center">
                    <button id="start-experiment" class="bg-primary hover:bg-primary/90 text-white py-2 px-6 rounded-lg font-medium transition-all transform hover:scale-105">
                        开始测验
                    </button>
                </div>
            </div>

            <!-- 实验阶段 -->
            <div id="experiment-stage" class="hidden space-y-6">
                <!-- 进度信息 -->
                <div>
                    <div class="text-center mb-2">
                        <p class="text-dark font-medium" id="block-title">区块 1/5：认识自我类别</p>
                    </div>
                    <div class="w-full bg-light rounded-full h-2.5 mb-2">
                        <div id="overall-progress" class="bg-primary h-2.5 rounded-full progress-indicator" style="width: 0%"></div>
                    </div>
                    <div class="w-full bg-light rounded-full h-2.5">
                        <div id="block-progress" class="bg-secondary h-2.5 rounded-full progress-indicator" style="width: 0%"></div>
                    </div>
                </div>

                <!-- 区块指示器 -->
                <div class="flex justify-between max-w-md mx-auto">
                    <div class="block-indicator w-8 h-8 flex items-center justify-center rounded-full border-2 border-gray-300" data-block="1">1</div>
                    <div class="block-indicator w-8 h-8 flex items-center justify-center rounded-full border-2 border-gray-300" data-block="2">2</div>
                    <div class="block-indicator w-8 h-8 flex items-center justify-center rounded-full border-2 border-gray-300" data-block="3">3</div>
                    <div class="block-indicator w-8 h-8 flex items-center justify-center rounded-full border-2 border-gray-300" data-block="4">4</div>
                    <div class="block-indicator w-8 h-8 flex items-center justify-center rounded-full border-2 border-gray-300" data-block="5">5</div>
                </div>

                <!-- 类别标签 -->
                <div class="grid grid-cols-2 gap-6 mb-8">
                    <div id="left-category" class="category-box bg-primary/10 border-2 border-primary rounded-lg p-4">
                        <p id="left-category-title" class="font-bold text-primary">自我</p>
                        <div id="left-category-examples" class="flex flex-wrap justify-center gap-2 mt-2">
                            <!-- 示例将动态填充 -->
                        </div>
                        <p class="mt-3 text-dark text-sm">按 <span class="key-prompt">E</span> 键</p>
                    </div>
                    <div id="right-category" class="category-box bg-warning/10 border-2 border-warning rounded-lg p-4">
                        <p id="right-category-title" class="font-bold text-warning">他人</p>
                        <div id="right-category-examples" class="flex flex-wrap justify-center gap-2 mt-2">
                            <!-- 示例将动态填充 -->
                        </div>
                        <p class="mt-3 text-dark text-sm">按 <span class="key-prompt">I</span> 键</p>
                    </div>
                </div>

                <!-- 目标词语显示区域 -->
                <div class="flex justify-center mb-8">
                    <div id="target-container" class="w-64 h-64 flex items-center justify-center border-2 border-gray-300 rounded-lg bg-white">
                        <p id="target-word" class="target-word text-dark"></p>
                    </div>
                </div>

                <!-- 反馈区域 -->
                <div id="feedback-container" class="hidden text-center mb-4">
                    <p id="feedback-text" class="text-dark font-medium"></p>
                </div>

                <!-- 按键提示 -->
                <div class="grid grid-cols-2 gap-6 max-w-md mx-auto">
                    <div class="flex justify-center">
                        <button id="key-e" class="bg-white border-2 border-gray-300 hover:border-primary rounded-lg w-16 h-16 flex items-center justify-center text-2xl font-bold text-dark">E</button>
                    </div>
                    <div class="flex justify-center">
                        <button id="key-i" class="bg-white border-2 border-gray-300 hover:border-warning rounded-lg w-16 h-16 flex items-center justify-center text-2xl font-bold text-dark">I</button>
                    </div>
                </div>

                <!-- 休息提示 -->
                <div id="break-message" class="hidden text-center p-6 bg-light rounded-lg">
                    <p class="text-dark text-lg mb-4">休息一下！</p>
                    <p class="text-dark mb-6">准备好后点击继续</p>
                    <button id="continue-button" class="bg-primary hover:bg-primary/90 text-white py-2 px-6 rounded-lg font-medium transition-all">
                        继续测验
                    </button>
                </div>
            </div>

            <!-- 结果阶段 -->
            <div id="result-stage" class="hidden space-y-6 fade-in">
                <div class="text-center">
                    <h2 class="text-xl font-bold text-dark mb-2">测验完成！</h2>
                    <p class="text-dark">你的内隐联想分析</p>
                </div>

                <!-- 结果概览 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-light rounded-lg p-6">
                        <h3 class="text-lg font-bold text-dark mb-3">D分数 (内隐联想强度)</h3>
                        <div class="flex items-center justify-center">
                            <div id="d-score-display" class="text-4xl font-bold text-primary">0.00</div>
                        </div>
                        <div class="text-center mt-3">
                            <p id="score-category" class="text-dark font-medium">无明显内隐偏好</p>
                        </div>
                    </div>
                    <div class="bg-light rounded-lg p-6">
                        <h3 class="text-lg font-bold text-dark mb-3">反应准确率</h3>
                        <div class="flex items-center justify-center">
                            <div id="accuracy-display" class="text-4xl font-bold text-secondary">0%</div>
                        </div>
                        <div class="text-center mt-3">
                            <p class="text-dark">共 <span id="total-trials">0</span> 次测试，<span id="correct-trials">0</span> 次正确</p>
                        </div>
                    </div>
                </div>

                <!-- 图表分析 -->
                <div class="bg-light rounded-lg p-6">
                    <h3 class="text-lg font-bold text-dark mb-4">反应时对比</h3>
                    <div class="w-full h-64">
                        <canvas id="reaction-time-chart"></canvas>
                    </div>
                </div>

                <!-- 内隐联想程度 -->
                <div class="bg-light rounded-lg p-6">
                    <h3 class="text-lg font-bold text-dark mb-4">内隐联想强度</h3>
                    <div class="w-full bg-white rounded-full h-8 mb-4">
                        <div id="association-bar" class="h-8 rounded-full" style="width: 50%; background: linear-gradient(to right, #F53F3F, #86909C, #00B42A);"></div>
                        <div class="relative" style="margin-top: -2.5rem;">
                            <div class="absolute left-0 text-dark font-medium">自我-消极</div>
                            <div class="absolute left-1/2 transform -translate-x-1/2 text-dark font-medium">无偏好</div>
                            <div class="absolute right-0 text-dark font-medium">自我-积极</div>
                        </div>
                    </div>
                    <div class="flex justify-center mt-8">
                        <div id="association-pointer" class="w-4 h-4 bg-primary border-2 border-white rounded-full transform -translate-x-1/2" style="position: relative; left: 50%;"></div>
                    </div>
                </div>

                <!-- 详细分析 -->
                <div class="bg-light rounded-lg p-6">
                    <h3 class="text-lg font-bold text-dark mb-3">详细分析</h3>
                    <div class="space-y-4">
                        <div>
                            <p class="text-dark font-medium mb-1">测试结果解读：</p>
                            <p id="result-interpretation" class="text-dark">
                                根据你的反应时间差异，我们分析了你的内隐态度...
                            </p>
                        </div>
                        <div>
                            <p class="text-dark font-medium mb-1">平均反应时：</p>
                            <p id="avg-rts" class="text-dark">
                                相容配对: <span id="avg-rt-compatible">0</span>ms / 不相容配对: <span id="avg-rt-incompatible">0</span>ms
                            </p>
                        </div>
                    </div>
                </div>

                <!-- 心理学解释 -->
                <div class="bg-light rounded-lg p-6">
                    <h3 class="text-lg font-bold text-dark mb-3">结果解释</h3>
                    <p class="text-dark mb-3">
                        内隐联想测验测量的是概念之间的关联强度，而这种关联可能与我们有意识表达的态度有所不同。
                    </p>
                    <p id="psychology-explanation" class="text-dark">
                        你的测验结果表明...
                    </p>
                    <p class="text-info text-sm mt-3">*实验结果仅作科普参考，不构成心理诊断</p>
                </div>

                <!-- 操作按钮 -->
                <div class="flex flex-wrap justify-center gap-4">
                    <button id="save-result" class="bg-primary hover:bg-primary/90 text-white py-2 px-6 rounded-lg font-medium transition-all">
                        <i class="fa fa-save mr-2"></i> 保存结果
                    </button>
                    <button id="restart-experiment" class="bg-info hover:bg-info/90 text-white py-2 px-6 rounded-lg font-medium transition-all">
                        <i class="fa fa-refresh mr-2"></i> 重新测验
                    </button>
                    <button id="back-to-hall" class="bg-dark hover:bg-dark/90 text-white py-2 px-6 rounded-lg font-medium transition-all">
                        <i class="fa fa-arrow-left mr-2"></i> 返回大厅
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚组件 -->
    <footer id="main-footer"></footer>

    <!-- 引入公共脚本 -->
    <script src="common.js"></script>
    <!-- 引入API模块 -->
    <script type="module">
      // 导入API函数
      import { 
        isAuthenticated, 
        saveExperimentResult, 
        saveExperimentResultToLocal,
        getExperimentStats 
      } from './api.js';
      
      // 将API函数暴露给全局作用域，供后续脚本使用
      window.API = {
        isAuthenticated,
        saveExperimentResult,
        saveExperimentResultToLocal,
        getExperimentStats
      };
    </script>
    <!-- 实验脚本 -->
    <script>
        // 测验配置
        const config = {
            // 词库定义
            wordCategories: {
                self: ['我', '我的', '自己', '本人', '咱们', '我们', '我方', '自身'],
                other: ['他们', '他的', '别人', '外人', '他们的', '他人', '对方', '别人的'],
                positive: ['成功', '快乐', '优秀', '美好', '智慧', '友好', '善良', '自信'],
                negative: ['失败', '痛苦', '糟糕', '丑陋', '愚蠢', '敌意', '邪恶', '自卑']
            },
            // 区块配置
            blocks: [
                {
                    id: 1,
                    title: '区块 1/5：认识自我类别',
                    leftCategory: 'self',
                    rightCategory: 'other',
                    stimuli: ['self', 'other'], // 只使用自我和他人类别
                    trials: 10, // 10次练习
                    isPractice: true
                },
                {
                    id: 2,
                    title: '区块 2/5：认识积极消极词语',
                    leftCategory: 'positive',
                    rightCategory: 'negative',
                    stimuli: ['positive', 'negative'], // 只使用积极和消极类别
                    trials: 10, // 10次练习
                    isPractice: true
                },
                {
                    id: 3,
                    title: '区块 3/5：练习配对',
                    leftCategory: ['self', 'positive'], // 自我和积极放在左边
                    rightCategory: ['other', 'negative'], // 他人和消极放在右边
                    stimuli: ['self', 'other', 'positive', 'negative'], // 所有类别
                    trials: 20, // 20次练习
                    isPractice: true
                },
                {
                    id: 4,
                    title: '区块 4/5：相容配对测试',
                    leftCategory: ['self', 'positive'], // 自我和积极放在左边（相容）
                    rightCategory: ['other', 'negative'], // 他人和消极放在右边（相容）
                    stimuli: ['self', 'other', 'positive', 'negative'], // 所有类别
                    trials: 30, // 30次测试
                    isPractice: false
                },
                {
                    id: 5,
                    title: '区块 5/5：不相容配对测试',
                    leftCategory: ['self', 'negative'], // 自我和消极放在左边（不相容）
                    rightCategory: ['other', 'positive'], // 他人和积极放在右边（不相容）
                    stimuli: ['self', 'other', 'positive', 'negative'], // 所有类别
                    trials: 30, // 30次测试
                    isPractice: false
                }
            ],
            // 计时配置
            timing: {
                wordDisplayDelay: 200, // 词语显示延迟
                feedbackDisplayTime: 500, // 反馈显示时间
                errorCorrectionDelay: 300 // 错误纠正延迟
            },
            // 错误处理
            error: {
                timeoutMs: 3000, // 3秒无反应视为超时
                penaltyMs: 600 // 错误回答的时间惩罚
            }
        };

        // DOM元素
        const elements = {
            preparation: document.getElementById('preparation-stage'),
            tutorial: document.getElementById('tutorial-stage'),
            experiment: document.getElementById('experiment-stage'),
            result: document.getElementById('result-stage'),
            startTutorial: document.getElementById('start-tutorial'),
            startExperiment: document.getElementById('start-experiment'),
            // 实验元素
            blockTitle: document.getElementById('block-title'),
            overallProgress: document.getElementById('overall-progress'),
            blockProgress: document.getElementById('block-progress'),
            leftCategory: document.getElementById('left-category'),
            rightCategory: document.getElementById('right-category'),
            leftCategoryTitle: document.getElementById('left-category-title'),
            rightCategoryTitle: document.getElementById('right-category-title'),
            leftCategoryExamples: document.getElementById('left-category-examples'),
            rightCategoryExamples: document.getElementById('right-category-examples'),
            targetContainer: document.getElementById('target-container'),
            targetWord: document.getElementById('target-word'),
            feedbackContainer: document.getElementById('feedback-container'),
            feedbackText: document.getElementById('feedback-text'),
            keyE: document.getElementById('key-e'),
            keyI: document.getElementById('key-i'),
            breakMessage: document.getElementById('break-message'),
            continueButton: document.getElementById('continue-button'),
            // 结果元素
            dScoreDisplay: document.getElementById('d-score-display'),
            scoreCategory: document.getElementById('score-category'),
            accuracyDisplay: document.getElementById('accuracy-display'),
            totalTrials: document.getElementById('total-trials'),
            correctTrials: document.getElementById('correct-trials'),
            avgRtCompatible: document.getElementById('avg-rt-compatible'),
            avgRtIncompatible: document.getElementById('avg-rt-incompatible'),
            resultInterpretation: document.getElementById('result-interpretation'),
            psychologyExplanation: document.getElementById('psychology-explanation'),
            associationBar: document.getElementById('association-bar'),
            associationPointer: document.getElementById('association-pointer'),
            saveResult: document.getElementById('save-result'),
            restartExperiment: document.getElementById('restart-experiment'),
            backToHall: document.getElementById('back-to-hall')
        };

        // 测验数据
        let iatData = {
            currentBlock: 0,
            currentTrial: 0,
            trials: [],
            blockTrials: [],
            compatibleReactionTimes: [], // 相容配对的反应时
            incompatibleReactionTimes: [], // 不相容配对的反应时
            compatibleErrors: 0,
            incompatibleErrors: 0,
            wordStartTime: 0,
            isCorrect: true,
            currentWord: '',
            currentWordCategory: '',
            timeoutTimer: null
        };

        // 绑定事件
        function bindEvents() {
            elements.startTutorial.addEventListener('click', startTutorial);
            elements.startExperiment.addEventListener('click', startExperiment);
            elements.restartExperiment.addEventListener('click', restartExperiment);
            elements.saveResult.addEventListener('click', saveIATResult);
            elements.backToHall.addEventListener('click', () => {
                window.location.href = 'psychology_experiments.html';
            });
            elements.continueButton.addEventListener('click', continueToNextBlock);
            elements.keyE.addEventListener('click', () => handleKeyPress('e'));
            elements.keyI.addEventListener('click', () => handleKeyPress('i'));
            
            // 监听键盘事件
            document.addEventListener('keydown', (event) => {
                if (event.key.toLowerCase() === 'e' || event.key.toLowerCase() === 'i') {
                    handleKeyPress(event.key.toLowerCase());
                }
            });
        }

        // 开始教程
        function startTutorial() {
            elements.preparation.classList.add('hidden');
            elements.tutorial.classList.remove('hidden');
            elements.experiment.classList.add('hidden');
            elements.result.classList.add('hidden');
        }

        // 开始测验
        function startExperiment() {
            elements.tutorial.classList.add('hidden');
            elements.experiment.classList.remove('hidden');
            elements.result.classList.add('hidden');
            
            // 重置测验数据
            resetIATData();
            
            // 初始化区块指示器
            updateBlockIndicators();
            
            // 开始第一个区块
            startNextBlock();
        }

        // 重置测验数据
        function resetIATData() {
            iatData = {
                currentBlock: 0,
                currentTrial: 0,
                trials: [],
                blockTrials: [],
                compatibleReactionTimes: [],
                incompatibleReactionTimes: [],
                compatibleErrors: 0,
                incompatibleErrors: 0,
                wordStartTime: 0,
                isCorrect: true,
                currentWord: '',
                currentWordCategory: '',
                timeoutTimer: null
            };
            
            // 更新进度
            elements.overallProgress.style.width = '0%';
            elements.blockProgress.style.width = '0%';
        }

        // 更新区块指示器
        function updateBlockIndicators() {
            const indicators = document.querySelectorAll('.block-indicator');
            
            indicators.forEach((indicator, index) => {
                const blockNum = index + 1;
                
                if (blockNum < iatData.currentBlock) {
                    // 已完成的区块
                    indicator.classList.remove('bg-white', 'border-gray-300', 'active');
                    indicator.classList.add('completed');
                } else if (blockNum === iatData.currentBlock) {
                    // 当前区块
                    indicator.classList.remove('bg-white', 'border-gray-300', 'completed');
                    indicator.classList.add('active');
                } else {
                    // 未完成的区块
                    indicator.classList.remove('active', 'completed');
                    indicator.classList.add('bg-white', 'border-gray-300');
                }
            });
        }

        // 开始下一个区块
        function startNextBlock() {
            // 清除之前的超时计时器
            if (iatData.timeoutTimer) {
                clearTimeout(iatData.timeoutTimer);
            }
            
            // 增加当前区块
            iatData.currentBlock++;
            
            // 检查是否已完成所有区块
            if (iatData.currentBlock > config.blocks.length) {
                showResults();
                return;
            }
            
            // 获取当前区块配置
            const currentBlock = config.blocks[iatData.currentBlock - 1];
            
            // 更新区块标题
            elements.blockTitle.textContent = currentBlock.title;
            
            // 更新类别显示
            updateCategoryDisplay(currentBlock);
            
            // 重置当前区块的试验次数
            iatData.currentTrial = 0;
            iatData.blockTrials = [];
            
            // 生成当前区块的试验序列
            generateBlockTrials(currentBlock);
            
            // 更新区块指示器
            updateBlockIndicators();
            
            // 更新进度条
            updateProgressBars();
            
            // 显示休息信息（如果是第4个区块）
            if (iatData.currentBlock === 4) {
                showBreakMessage();
            } else {
                // 开始第一个试验
                setTimeout(() => {
                    startNextTrial();
                }, 1000);
            }
        }

        // 显示休息信息
        function showBreakMessage() {
            elements.breakMessage.classList.remove('hidden');
            elements.targetContainer.classList.add('hidden');
            elements.keyE.classList.add('hidden');
            elements.keyI.classList.add('hidden');
        }

        // 继续到下一个区块
        function continueToNextBlock() {
            elements.breakMessage.classList.add('hidden');
            elements.targetContainer.classList.remove('hidden');
            elements.keyE.classList.remove('hidden');
            elements.keyI.classList.remove('hidden');
            
            // 开始第一个试验
            startNextTrial();
        }

        // 更新类别显示
        function updateCategoryDisplay(block) {
            // 更新左侧类别
            updateCategorySide('left', block.leftCategory);
            // 更新右侧类别
            updateCategorySide('right', block.rightCategory);
        }

        // 更新单侧类别显示
        function updateCategorySide(side, category) {
            const titleElement = side === 'left' ? elements.leftCategoryTitle : elements.rightCategoryTitle;
            const examplesElement = side === 'left' ? elements.leftCategoryExamples : elements.rightCategoryExamples;
            const categoryElement = side === 'left' ? elements.leftCategory : elements.rightCategory;
            
            // 清空示例
            examplesElement.innerHTML = '';
            
            if (Array.isArray(category)) {
                // 混合类别
                let combinedTitles = [];
                let allExamples = [];
                
                category.forEach(cat => {
                    // 获取类别标题和颜色
                    const { title, color, bgColor } = getCategoryInfo(cat);
                    combinedTitles.push(title);
                    
                    // 获取示例词
                    const words = config.wordCategories[cat].slice(0, 3); // 取前3个作为示例
                    allExamples = [...allExamples, ...words];
                    
                    // 添加类别标签
                    const label = document.createElement('span');
                    label.className = `bg-white px-2 py-1 rounded text-sm ${color}`;
                    label.textContent = title;
                    examplesElement.appendChild(label);
                });
                
                // 设置标题
                titleElement.textContent = combinedTitles.join(' / ');
                
                // 设置颜色（使用第一个类别的颜色）
                const { color, bgColor } = getCategoryInfo(category[0]);
                titleElement.className = `font-bold ${color}`;
                categoryElement.className = `category-box ${bgColor} border-2 ${color} rounded-lg p-4`;
            } else {
                // 单一类别
                const { title, color, bgColor } = getCategoryInfo(category);
                
                // 设置标题
                titleElement.textContent = title;
                titleElement.className = `font-bold ${color}`;
                
                // 设置背景和边框颜色
                categoryElement.className = `category-box ${bgColor} border-2 ${color} rounded-lg p-4`;
                
                // 添加示例词
                config.wordCategories[category].slice(0, 4).forEach(word => {
                    const example = document.createElement('span');
                    example.className = 'bg-white px-2 py-1 rounded text-sm';
                    example.textContent = word;
                    examplesElement.appendChild(example);
                });
            }
        }

        // 获取类别信息
        function getCategoryInfo(category) {
            switch(category) {
                case 'self':
                    return { title: '自我', color: 'text-self', bgColor: 'bg-self/10' };
                case 'other':
                    return { title: '他人', color: 'text-other', bgColor: 'bg-other/10' };
                case 'positive':
                    return { title: '积极', color: 'text-positive', bgColor: 'bg-positive/10' };
                case 'negative':
                    return { title: '消极', color: 'text-negative', bgColor: 'bg-negative/10' };
                default:
                    return { title: '未知', color: 'text-dark', bgColor: 'bg-gray-100' };
            }
        }

        // 生成区块试验序列
        function generateBlockTrials(block) {
            const trials = [];
            const stimuliCounts = {};
            
            // 初始化各类别计数
            block.stimuli.forEach(stimulus => {
                stimuliCounts[stimulus] = 0;
            });
            
            // 确定每个类别的试验次数
            const trialsPerCategory = Math.floor(block.trials / block.stimuli.length);
            let remainingTrials = block.trials % block.stimuli.length;
            
            // 生成试验
            for (let i = 0; i < block.trials; i++) {
                // 随机选择一个类别
                let category;
                do {
                    category = block.stimuli[Math.floor(Math.random() * block.stimuli.length)];
                } while (stimuliCounts[category] >= trialsPerCategory + (remainingTrials > 0 && Math.random() > 0.5 ? 1 : 0));
                
                // 增加计数
                stimuliCounts[category]++;
                if (stimuliCounts[category] > trialsPerCategory) {
                    remainingTrials--;
                }
                
                // 从该类别中随机选择一个词
                const words = config.wordCategories[category];
                const word = words[Math.floor(Math.random() * words.length)];
                
                // 添加到试验序列
                trials.push({ word, category });
            }
            
            // 保存到区块试验
            iatData.blockTrials = trials;
        }

        // 更新进度条
        function updateProgressBars() {
            // 计算总体进度
            const totalTrials = config.blocks.reduce((sum, block) => sum + block.trials, 0);
            const completedTrials = iatData.trials.length;
            const overallProgress = (completedTrials / totalTrials) * 100;
            
            // 计算当前区块进度
            const currentBlock = config.blocks[iatData.currentBlock - 1];
            const blockProgress = (iatData.currentTrial / currentBlock.trials) * 100;
            
            // 更新进度条
            elements.overallProgress.style.width = `${overallProgress}%`;
            elements.blockProgress.style.width = `${blockProgress}%`;
        }

        // 开始下一个试验
        function startNextTrial() {
            // 清除之前的超时计时器
            if (iatData.timeoutTimer) {
                clearTimeout(iatData.timeoutTimer);
            }
            
            // 增加当前试验次数
            iatData.currentTrial++;
            
            // 检查是否已完成当前区块
            if (iatData.currentTrial > iatData.blockTrials.length) {
                // 保存当前区块数据
                saveBlockData();
                
                // 开始下一个区块
                setTimeout(() => {
                    startNextBlock();
                }, 500);
                return;
            }
            
            // 更新进度条
            updateProgressBars();
            
            // 隐藏反馈
            elements.feedbackContainer.classList.add('hidden');
            
            // 获取当前试验
            const trial = iatData.blockTrials[iatData.currentTrial - 1];
            iatData.currentWord = trial.word;
            iatData.currentWordCategory = trial.category;
            
            // 显示词语
            elements.targetWord.textContent = trial.word;
            elements.targetWord.classList.add('word-animation');
            
            // 记录开始时间
            iatData.wordStartTime = Date.now();
            
            // 设置超时计时器
            iatData.timeoutTimer = setTimeout(() => handleTimeout(), config.error.timeoutMs);
            
            // 清除动画类，以便下次使用
            setTimeout(() => {
                elements.targetWord.classList.remove('word-animation');
            }, 300);
        }

        // 处理按键事件
        function handleKeyPress(key) {
            // 清除超时计时器
            if (iatData.timeoutTimer) {
                clearTimeout(iatData.timeoutTimer);
            }
            
            // 计算反应时间
            const reactionTime = Date.now() - iatData.wordStartTime;
            
            // 获取当前区块配置
            const currentBlock = config.blocks[iatData.currentBlock - 1];
            
            // 判断按键是否正确
            const isCorrect = checkAnswer(key, currentBlock);
            iatData.isCorrect = isCorrect;
            
            // 显示反馈
            showFeedback(isCorrect);
            
            // 记录试验结果（仅记录非练习区块或练习区块的正确回答）
            if (!currentBlock.isPractice || isCorrect) {
                const trialResult = {
                    blockId: currentBlock.id,
                    word: iatData.currentWord,
                    category: iatData.currentWordCategory,
                    isCompatible: iatData.currentBlock === 4, // 区块4是相容配对
                    reactionTime: isCorrect ? reactionTime : reactionTime + config.error.penaltyMs,
                    isCorrect: isCorrect
                };
                
                iatData.trials.push(trialResult);
                
                // 如果是相容或不相容配对测试，保存相应数据
                if (!currentBlock.isPractice) {
                    if (iatData.currentBlock === 4) { // 相容配对
                        iatData.compatibleReactionTimes.push(trialResult.reactionTime);
                        if (!isCorrect) {
                            iatData.compatibleErrors++;
                        }
                    } else if (iatData.currentBlock === 5) { // 不相容配对
                        iatData.incompatibleReactionTimes.push(trialResult.reactionTime);
                        if (!isCorrect) {
                            iatData.incompatibleErrors++;
                        }
                    }
                }
            }
            
            // 如果回答错误，需要等待用户再次按键
            if (!isCorrect) {
                // 不自动进入下一个试验，等待用户重新按键
                iatData.wordStartTime = Date.now(); // 重置开始时间
                iatData.timeoutTimer = setTimeout(() => handleTimeout(), config.error.timeoutMs);
            } else {
                // 回答正确，延迟进入下一个试验
                setTimeout(() => {
                    startNextTrial();
                }, config.timing.wordDisplayDelay);
            }
        }

        // 判断回答是否正确
        function checkAnswer(key, block) {
            // 获取当前词的正确分类（左或右）
            const correctSide = getCorrectSide(block);
            
            // 判断按键是否对应正确的分类
            return (key === 'e' && correctSide === 'left') || (key === 'i' && correctSide === 'right');
        }

        // 获取当前词应该属于哪一侧
        function getCorrectSide(block) {
            const category = iatData.currentWordCategory;
            
            if (Array.isArray(block.leftCategory)) {
                // 左侧是混合类别
                return block.leftCategory.includes(category) ? 'left' : 'right';
            } else {
                // 左侧是单一类别
                return block.leftCategory === category ? 'left' : 'right';
            }
        }

        // 显示反馈
        function showFeedback(isCorrect) {
            // 清除之前的反馈样式
            elements.targetContainer.classList.remove('correct-feedback', 'error-feedback');
            
            if (isCorrect) {
                // 显示正确反馈
                elements.feedbackContainer.classList.remove('hidden');
                elements.feedbackText.textContent = '正确！';
                elements.feedbackText.className = 'text-positive font-medium';
                elements.targetContainer.classList.add('correct-feedback');
            } else {
                // 显示错误反馈
                elements.feedbackContainer.classList.remove('hidden');
                elements.feedbackText.textContent = '错误，请重新选择！';
                elements.feedbackText.className = 'text-negative font-medium';
                elements.targetContainer.classList.add('error-feedback');
            }
        }

        // 处理超时
        function handleTimeout() {
            // 显示超时反馈
            elements.feedbackContainer.classList.remove('hidden');
            elements.feedbackText.textContent = '请尽快反应！';
            elements.feedbackText.className = 'text-warning font-medium';
            
            // 重置开始时间
            iatData.wordStartTime = Date.now();
            
            // 设置新的超时计时器
            iatData.timeoutTimer = setTimeout(() => handleTimeout(), config.error.timeoutMs);
        }

        // 保存区块数据
        function saveBlockData() {
            // 这里可以添加保存区块数据的逻辑
            // 例如保存区块的平均反应时间、错误率等
        }

        // 显示结果
        function showResults() {
            // 隐藏实验阶段，显示结果阶段
            elements.experiment.classList.add('hidden');
            elements.result.classList.remove('hidden');
            
            // 计算统计数据
            const stats = calculateStatistics();
            
            // 更新分析信息
            updateAnalysis(stats);
            
            // 绘制图表
            drawCharts(stats);
            
            // 设置关联指针位置
            setAssociationPointer(stats);
            
            // 保存到localStorage（即使未登录）
            if (window.API && window.API.saveExperimentResultToLocal) {
                window.API.saveExperimentResultToLocal('iat', {
                    dScore: stats.dScore,
                    statistics: stats,
                    trials: iatData.trials,
                    timestamp: new Date().toISOString()
                });
            } else {
                // 降级到本地函数
                saveToLocalStorage({
                    dScore: stats.dScore,
                    statistics: stats,
                    trials: iatData.trials,
                    timestamp: new Date().toISOString()
                });
            }
        }

        // 计算统计数据
        function calculateStatistics() {
            // 过滤出相容和不相容配对的反应时
            const compatibleRTs = iatData.compatibleReactionTimes;
            const incompatibleRTs = iatData.incompatibleReactionTimes;
            
            // 计算相容和不相容配对的平均反应时
            const avgCompatibleRT = compatibleRTs.length > 0 ? 
                compatibleRTs.reduce((sum, rt) => sum + rt, 0) / compatibleRTs.length : 0;
            
            const avgIncompatibleRT = incompatibleRTs.length > 0 ? 
                incompatibleRTs.reduce((sum, rt) => sum + rt, 0) / incompatibleRTs.length : 0;
            
            // 计算所有有效试验的反应时标准差
            const allRTs = [...compatibleRTs, ...incompatibleRTs];
            const overallMean = allRTs.length > 0 ? 
                allRTs.reduce((sum, rt) => sum + rt, 0) / allRTs.length : 0;
            
            const squaredDiffs = allRTs.map(rt => Math.pow(rt - overallMean, 2));
            const variance = squaredDiffs.length > 0 ? 
                squaredDiffs.reduce((sum, diff) => sum + diff, 0) / squaredDiffs.length : 0;
            const standardDeviation = Math.sqrt(variance);
            
            // 计算D分数 (Greenwald, Nosek & Banaji, 2003的改进算法)
            // D = (不相容平均反应时 - 相容平均反应时) / 所有反应时的标准差
            const dScore = standardDeviation > 0 ? 
                (avgIncompatibleRT - avgCompatibleRT) / standardDeviation : 0;
            
            // 计算准确率
            const totalTestTrials = compatibleRTs.length + incompatibleRTs.length;
            const correctTestTrials = totalTestTrials - (iatData.compatibleErrors + iatData.incompatibleErrors);
            const accuracy = totalTestTrials > 0 ? 
                Math.round((correctTestTrials / totalTestTrials) * 100) : 0;
            
            // 确定D分数类别
            let scoreCategory = '';
            let scoreDescription = '';
            
            if (dScore >= 0.65) {
                scoreCategory = '强自我-积极联想';
                scoreDescription = '你表现出强烈的自我-积极内隐关联，这表明你可能对自己持有积极的内隐态度。';
            } else if (dScore >= 0.35) {
                scoreCategory = '中等自我-积极联想';
                scoreDescription = '你表现出中等程度的自我-积极内隐关联，这表明你可能对自己持有较为积极的内隐态度。';
            } else if (dScore > -0.35) {
                scoreCategory = '无明显内隐偏好';
                scoreDescription = '你的内隐联想较弱，没有表现出明显的自我-积极或自我-消极偏好。';
            } else if (dScore > -0.65) {
                scoreCategory = '中等自我-消极联想';
                scoreDescription = '你表现出中等程度的自我-消极内隐关联，这可能表明你对自己持有一些消极的内隐态度。';
            } else {
                scoreCategory = '强自我-消极联想';
                scoreDescription = '你表现出强烈的自我-消极内隐关联，这可能表明你对自己持有消极的内隐态度。';
            }
            
            return {
                dScore: parseFloat(dScore.toFixed(2)),
                scoreCategory,
                scoreDescription,
                avgCompatibleRT: Math.round(avgCompatibleRT),
                avgIncompatibleRT: Math.round(avgIncompatibleRT),
                reactionTimeDifference: Math.round(avgIncompatibleRT - avgCompatibleRT),
                accuracy,
                totalTestTrials,
                correctTestTrials,
                compatibleRTs,
                incompatibleRTs
            };
        }

        // 更新分析信息
        function updateAnalysis(stats) {
            elements.dScoreDisplay.textContent = stats.dScore;
            elements.scoreCategory.textContent = stats.scoreCategory;
            elements.accuracyDisplay.textContent = `${stats.accuracy}%`;
            elements.totalTrials.textContent = stats.totalTestTrials;
            elements.correctTrials.textContent = stats.correctTestTrials;
            elements.avgRtCompatible.textContent = stats.avgCompatibleRT;
            elements.avgRtIncompatible.textContent = stats.avgIncompatibleRT;
            
            // 更新解释文本
            elements.resultInterpretation.textContent = stats.scoreDescription;
            
            // 生成心理学解释
            generatePsychologyExplanation(stats);
        }

        // 生成心理学解释
        function generatePsychologyExplanation(stats) {
            let explanation = '';
            
            explanation += '内隐联想测验测量的是概念之间的自动化关联强度，这种关联通常是无意识的，可能与我们有意识表达的态度不一致。';
            explanation += ' 在本测验中，我们测量了你对"自我"与"积极"、"自我"与"消极"概念之间的关联强度。';
            
            if (stats.dScore > 0) {
                explanation += ' 你的D分数为正值，表明你在将"自我"与"积极"概念配对时反应更快，这通常反映了一种积极的自我概念。';
            } else if (stats.dScore < 0) {
                explanation += ' 你的D分数为负值，表明你在将"自我"与"消极"概念配对时反应更快，这可能反映了某种程度的消极自我概念。';
            } else {
                explanation += ' 你的D分数接近零，表明你对"自我"与"积极"或"自我"与"消极"概念的关联强度相当。';
            }
            
            explanation += ' 需要注意的是，内隐态度并不一定代表你的真实信念或行为倾向，它只是反映了在特定文化和社会环境中形成的自动化联想。';
            explanation += ' 这些自动化联想可能受到多种因素的影响，包括个人经历、社会文化环境和媒体影响等。';
            
            if (stats.accuracy < 80) {
                explanation += ' 你的测验准确率相对较低，这可能会影响结果的准确性。建议在状态更好时重新进行测验。';
            }
            
            elements.psychologyExplanation.textContent = explanation;
        }

        // 绘制图表
        function drawCharts(stats) {
            // 绘制反应时对比图
            drawReactionTimeChart(stats);
        }

        // 绘制反应时对比图
        function drawReactionTimeChart(stats) {
            const ctx = document.getElementById('reaction-time-chart').getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['相容配对\n(自我+积极)', '不相容配对\n(自我+消极)'],
                    datasets: [{
                        label: '平均反应时 (毫秒)',
                        data: [stats.avgCompatibleRT, stats.avgIncompatibleRT],
                        backgroundColor: [
                            'rgba(22, 93, 255, 0.7)',
                            'rgba(245, 63, 63, 0.7)'
                        ],
                        borderColor: [
                            'rgba(22, 93, 255, 1)',
                            'rgba(245, 63, 63, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '反应时间 (毫秒)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y} 毫秒`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 设置关联指针位置
        function setAssociationPointer(stats) {
            // 确定指针位置 (D分数范围通常在-2到2之间，映射到0-100%)
            let position = 50; // 默认中间
            
            if (stats.dScore > 0) {
                // 正向分数，向右移动
                position = 50 + Math.min(stats.dScore / 2 * 50, 50); // 最大右移50%
            } else {
                // 负向分数，向左移动
                position = 50 + Math.max(stats.dScore / 2 * 50, -50); // 最大左移50%
            }
            
            // 设置位置
            elements.associationPointer.style.left = `${position}%`;
        }

        // 保存到localStorage（降级方案）
        function saveToLocalStorage(results) {
            try {
                // 获取现有记录
                let experimentRecords = JSON.parse(localStorage.getItem('experimentRecords') || '[]');
                
                // 添加新记录
                experimentRecords.push({
                    type: 'iat',
                    results: results,
                    timestamp: new Date().toISOString()
                });
                
                // 只保留最近20条记录
                if (experimentRecords.length > 20) {
                    experimentRecords = experimentRecords.slice(-20);
                }
                
                // 保存回localStorage
                localStorage.setItem('experimentRecords', JSON.stringify(experimentRecords));
            } catch (error) {
                console.error('保存实验结果到localStorage失败:', error);
            }
        }

        // 保存测验结果到服务器
        async function saveIATResult() {
            // 检查用户是否登录
            if (window.API && window.API.isAuthenticated) {
                if (!window.API.isAuthenticated()) {
                    // 显示登录提示
                    if (confirm('登录后可保存实验记录，是否立即登录？')) {
                        window.location.href = 'login.html';
                    }
                    return;
                }
            } else {
                // 降级检查
                const token = localStorage.getItem('token');
                if (!token) {
                    if (confirm('登录后可保存实验记录，是否立即登录？')) {
                        window.location.href = 'login.html';
                    }
                    return;
                }
            }
            
            // 获取最新的结果（从localStorage）
            try {
                let experimentRecords = JSON.parse(localStorage.getItem('experimentRecords') || '[]');
                const latestResult = experimentRecords
                    .filter(record => record.type === 'iat')
                    .pop();
                
                if (latestResult && window.API && window.API.saveExperimentResult) {
                    // 调用API保存结果
                    await window.API.saveExperimentResult('iat', latestResult.results);
                    
                    // 显示成功提示
                    alert('测验结果保存成功！');
                    
                    // 禁用保存按钮
                    elements.saveResult.disabled = true;
                    elements.saveResult.classList.add('opacity-50');
                    elements.saveResult.textContent = '已保存';
                } else {
                    alert('保存失败，请稍后重试');
                }
            } catch (error) {
                console.error('保存测验结果失败:', error);
                alert('保存失败，请稍后重试');
            }
        }

        // 重新开始测验
        function restartExperiment() {
            // 重置测验数据
            resetIATData();
            
            // 隐藏结果阶段，显示实验阶段
            elements.result.classList.add('hidden');
            elements.experiment.classList.remove('hidden');
            
            // 初始化区块指示器
            updateBlockIndicators();
            
            // 重新启用保存按钮
            elements.saveResult.disabled = false;
            elements.saveResult.classList.remove('opacity-50');
            elements.saveResult.textContent = '保存结果';
            
            // 开始第一个区块
            startNextBlock();
        }

        // 初始化
        function init() {
            bindEvents();
            
            // 加载导航栏和页脚
            if (typeof loadNavbar === 'function') {
                loadNavbar();
            }
            if (typeof loadFooter === 'function') {
                loadFooter();
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
<script src="update_experiment_navigation.js"></script>
    </body>
</html>