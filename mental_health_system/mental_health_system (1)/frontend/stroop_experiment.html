<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>心社区 - 心理健康支持平台</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 引入Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- 引入公共样式 -->
    <link rel="stylesheet" href="common.css">
    <!-- 引入增强UI样式 -->
    <link rel="stylesheet" href="enhanced_ui.css">
    
    <!-- Tailwind配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#00B42A',
                        warning: '#FF7D00',
                        danger: '#F53F3F',
                        neutral: '#4E5969',
                        light: '#F2F3F5',
                        dark: '#1D2129',
                        // 斯特鲁普任务专用颜色
                        'stroop-red': '#F53F3F',
                        'stroop-yellow': '#FF7D00',
                        'stroop-blue': '#165DFF',
                        'stroop-green': '#00B42A'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <!-- 自定义样式 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .color-button {
                width: 60px;
                height: 60px;
                border-radius: 50%;
                transition: all 0.1s ease;
            }
            .color-button:active {
                transform: scale(0.95);
            }
            .instruction-text {
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0%, 100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.5;
                }
            }
            .progress-bar {
                transition: width 0.3s ease;
            }
            .correct-feedback {
                animation: correct-flash 0.3s ease;
            }
            .error-feedback {
                animation: error-flash 0.3s ease;
            }
            @keyframes correct-flash {
                0% { background-color: transparent; }
                50% { background-color: rgba(0, 180, 42, 0.2); }
                100% { background-color: transparent; }
            }
            @keyframes error-flash {
                0% { background-color: transparent; }
                50% { background-color: rgba(245, 63, 63, 0.2); }
                100% { background-color: transparent; }
            }
        }
    </style>
<link rel="stylesheet" href="experiments-responsive.css">
<style>

    /* 全局样式重置 */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    /* 全局颜色变量 */
    :root {
        --primary-color: #6366f1;
        --secondary-color: #8b5cf6;
        --text-primary: #1e293b;
        --text-secondary: #475569;
        --bg-primary: #ffffff;
        --bg-secondary: #f8fafc;
        --border-color: #e2e8f0;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        line-height: 1.6;
        color: var(--text-primary);
        background-color: var(--bg-primary);
    }
    
    /* 统一按钮样式 */
    button {
        font-family: inherit;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        outline: none;
    }
    
    /* 主按钮样式 - 注册按钮 */
    .btn-primary {
        background-color: var(--secondary-color);
        color: white;
        border-radius: 8px;
        padding: 8px 16px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }
    
    .btn-primary:hover {
        background-color: #7c3aed;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(139, 92, 246, 0.2);
    }
    
    /* 次要按钮样式 - 登录按钮 */
    .btn-secondary {
        background-color: transparent;
        color: var(--primary-color);
        border: 1px solid var(--primary-color);
        border-radius: 8px;
        padding: 8px 16px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }
    
    .btn-secondary:hover {
        background-color: rgba(99, 102, 241, 0.05);
        transform: translateY(-1px);
    }
    
    /* 导航栏样式 */
    nav {
        background-color: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--border-color);
    }
    
    /* 响应式设计 */
    @media (max-width: 768px) {
        .btn-primary,
        .btn-secondary {
            padding: 6px 12px;
            font-size: 0.875rem;
        }
    }
    
    /* 卡片样式 */
    .card {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        padding: 1.5rem;
    }
    
    /* 输入框样式 */
    input,
    textarea,
    select {
        font-family: inherit;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 8px 12px;
        transition: border-color 0.3s ease;
    }
    
    input:focus,
    textarea:focus,
    select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

</style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 导航栏 -->
    <div id="navbar-placeholder"></div>
    
    <!-- 主内容区 -->
    <main class="container mx-auto px-4 pt-20 pb-20">
        <!-- 顶部信息 -->
        <div class="mb-8">
            <div class="flex items-center mb-4">
                <button id="back-button" class="mr-4 text-gray-500 hover:text-primary transition-colors">
                    <i class="fa fa-arrow-left"></i>
                </button>
                <h1 class="text-2xl font-bold text-primary">斯特鲁普任务</h1>
            </div>
            <p class="text-neutral">测量注意力在冲突信息中的反应速度，检验自动化加工对注意力的干扰</p>
        </div>
        
        <!-- 准备阶段 -->
        <div id="preparation-stage" class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <h2 class="text-xl font-semibold mb-6 text-center">实验准备</h2>
            
            <div class="flex flex-col items-center mb-8">
                <div class="bg-light w-full max-w-md h-28 rounded-lg flex items-center justify-center mb-6">
                    <div id="instruction-word" class="text-4xl font-bold stroop-blue">蓝</div>
                </div>
                <p class="text-lg text-center mb-4 instruction-text">请点击字体的颜色，而非文字含义</p>
                <p class="text-center text-sm text-gray-500">例如：上方文字是"蓝"，但字体颜色是蓝色，请点击蓝色按钮</p>
            </div>
            
            <!-- 示例按钮 -->
            <div class="flex justify-center gap-5 mb-8">
                <button class="color-button bg-stroop-red" data-color="red">
                    <span class="text-white font-bold">红</span>
                </button>
                <button class="color-button bg-stroop-yellow" data-color="yellow">
                    <span class="text-white font-bold">黄</span>
                </button>
                <button class="color-button bg-stroop-blue" data-color="blue">
                    <span class="text-white font-bold">蓝</span>
                </button>
                <button class="color-button bg-stroop-green" data-color="green">
                    <span class="text-white font-bold">绿</span>
                </button>
            </div>
            
            <!-- 控制按钮 -->
            <div class="flex justify-center gap-4">
                <button id="replay-instruction" class="px-6 py-2 border border-primary text-primary rounded-lg hover:bg-primary/5 transition-colors">
                    重新观看
                </button>
                <button id="start-experiment" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                    开始实验
                </button>
            </div>
        </div>
        
        <!-- 实验阶段 -->
        <div id="experiment-stage" class="bg-white rounded-xl shadow-sm p-6 mb-6 hidden">
            <!-- 进度信息 -->
            <div class="mb-6">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm text-gray-500">进度</span>
                    <span id="progress-text" class="text-sm font-medium">1/32</span>
                </div>
                <div class="h-2 bg-gray-100 rounded-full">
                    <div id="progress-bar" class="progress-bar h-full bg-primary rounded-full" style="width: 3%"></div>
                </div>
            </div>
            
            <!-- 实验区域 -->
            <div id="experiment-area" class="bg-light w-full max-w-md h-32 mx-auto rounded-lg flex items-center justify-center mb-10">
                <!-- 这里会显示+号或颜色词 -->
                <div id="display-content" class="text-4xl font-bold">+</div>
            </div>
            
            <!-- 颜色按钮区域 -->
            <div id="color-buttons" class="flex justify-center gap-5">
                <!-- 按钮会动态生成 -->
            </div>
        </div>
        
        <!-- 结果阶段 -->
        <div id="result-stage" class="bg-white rounded-xl shadow-sm p-6 mb-6 hidden">
            <h2 class="text-xl font-semibold mb-6 text-center">实验结果</h2>
            
            <!-- 核心数据 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="bg-light p-4 rounded-lg text-center">
                    <p class="text-sm text-gray-500 mb-1">一致反应时</p>
                    <p id="congruent-time" class="text-2xl font-bold text-primary">520ms</p>
                </div>
                <div class="bg-light p-4 rounded-lg text-center">
                    <p class="text-sm text-gray-500 mb-1">冲突反应时</p>
                    <p id="incongruent-time" class="text-2xl font-bold text-warning">680ms</p>
                </div>
                <div class="bg-light p-4 rounded-lg text-center">
                    <p class="text-sm text-gray-500 mb-1">冲突效应值</p>
                    <p id="conflict-effect" class="text-2xl font-bold text-danger">160ms</p>
                </div>
            </div>
            
            <!-- 图表 -->
            <div class="mb-8">
                <h3 class="text-center text-lg font-medium mb-4">你的数据 vs 群体平均</h3>
                <div class="w-full h-64">
                    <canvas id="result-chart"></canvas>
                </div>
            </div>
            
            <!-- 结果解读 -->
            <div class="bg-primary/5 p-4 rounded-lg mb-8 border border-primary/20">
                <h3 class="text-lg font-medium text-primary mb-2">结果解读</h3>
                <p id="result-interpretation" class="text-gray-700">
                    你的冲突效应值低于平均水平，说明你的注意力抑制能力较强 —— 大脑能更快抑制无关信息（文字含义），专注于目标任务（颜色识别）。
                </p>
            </div>
            
            <!-- 操作按钮 -->
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button id="back-to-hall" class="px-6 py-2 border border-primary text-primary rounded-lg hover:bg-primary/5 transition-colors">
                    返回大厅
                </button>
                <button id="save-result" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                    保存结果
                </button>
                <button id="view-records" class="px-6 py-2 bg-secondary text-white rounded-lg hover:bg-secondary/90 transition-colors">
                    查看我的记录
                </button>
            </div>
        </div>
    </main>
    
    <!-- 引入公共脚本 -->
    <script src="common.js"></script>
    <!-- 引入API模块 -->
    <script type="module">
      // 导入API函数
      import { 
        isAuthenticated, 
        saveExperimentResult, 
        saveExperimentResultToLocal,
        getExperimentStats 
      } from './api.js';
      
      // 将API函数暴露给全局作用域，供后续脚本使用
      window.API = {
        isAuthenticated,
        saveExperimentResult,
        saveExperimentResultToLocal,
        getExperimentStats
      };
    </script>
    <!-- 实验脚本 -->
    <script>
        // 实验配置
        const EXPERIMENT_CONFIG = {
            totalTrials: 32,
            congruentTrials: 16,
            incongruentTrials: 16,
            fixationTime: 500,    // +号显示时间（毫秒）
            responseTimeout: 3000, // 反应超时时间（毫秒）
            feedbackTime: 100      // 反馈显示时间（毫秒）
        };
        
        // 颜色配置
        const COLOR_CONFIG = {
            red: {
                text: '红',
                cssClass: 'stroop-red',
                bgClass: 'bg-stroop-red'
            },
            yellow: {
                text: '黄',
                cssClass: 'stroop-yellow',
                bgClass: 'bg-stroop-yellow'
            },
            blue: {
                text: '蓝',
                cssClass: 'stroop-blue',
                bgClass: 'bg-stroop-blue'
            },
            green: {
                text: '绿',
                cssClass: 'stroop-green',
                bgClass: 'bg-stroop-green'
            }
        };
        
        // 实验数据
        let experimentData = {
            trials: [],
            currentTrial: 0,
            startTime: 0,
            congruentTimes: [],
            incongruentTimes: [],
            congruentCorrect: 0,
            incongruentCorrect: 0
        };
        
        // DOM元素
        let elements = {};
        
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 加载导航栏
            const navbarPlaceholder = document.getElementById('navbar-placeholder');
            fetch('components/navbar.html')
                .then(response => response.text())
                .then(html => {
                    navbarPlaceholder.innerHTML = html;
                    // 初始化导航栏
                    initNavbar();
                });
            
            // 获取DOM元素
            elements = {
                preparationStage: document.getElementById('preparation-stage'),
                experimentStage: document.getElementById('experiment-stage'),
                resultStage: document.getElementById('result-stage'),
                backButton: document.getElementById('back-button'),
                replayInstruction: document.getElementById('replay-instruction'),
                startExperiment: document.getElementById('start-experiment'),
                progressText: document.getElementById('progress-text'),
                progressBar: document.getElementById('progress-bar'),
                experimentArea: document.getElementById('experiment-area'),
                displayContent: document.getElementById('display-content'),
                colorButtons: document.getElementById('color-buttons'),
                congruentTime: document.getElementById('congruent-time'),
                incongruentTime: document.getElementById('incongruent-time'),
                conflictEffect: document.getElementById('conflict-effect'),
                resultInterpretation: document.getElementById('result-interpretation'),
                backToHall: document.getElementById('back-to-hall'),
                saveResult: document.getElementById('save-result'),
                viewRecords: document.getElementById('view-records'),
                instructionWord: document.getElementById('instruction-word')
            };
            
            // 绑定事件
            bindEvents();
            
            // 初始化教程动画
            initInstructionAnimation();
        });
        
        // 绑定事件
        function bindEvents() {
            // 返回按钮
            elements.backButton.addEventListener('click', function() {
                window.location.href = 'psychology_experiments.html';
            });
            
            // 重新观看按钮
            elements.replayInstruction.addEventListener('click', function() {
                initInstructionAnimation();
            });
            
            // 开始实验按钮
            elements.startExperiment.addEventListener('click', function() {
                startExperiment();
            });
            
            // 返回大厅按钮
            elements.backToHall.addEventListener('click', function() {
                window.location.href = 'psychology_experiments.html';
            });
            
            // 保存结果按钮
            elements.saveResult.addEventListener('click', function() {
                saveExperimentResult();
            });
            
            // 查看记录按钮
            elements.viewRecords.addEventListener('click', function() {
                window.location.href = 'user_profile.html#experiment-records';
            });
            
            // 教程阶段的颜色按钮
            const tutorialButtons = document.querySelectorAll('#preparation-stage .color-button');
            tutorialButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 检查是否点击了正确的颜色（蓝色）
                    const color = this.getAttribute('data-color');
                    if (color === 'blue') {
                        this.classList.add('correct-feedback');
                        setTimeout(() => {
                            this.classList.remove('correct-feedback');
                        }, 300);
                    } else {
                        this.classList.add('error-feedback');
                        setTimeout(() => {
                            this.classList.remove('error-feedback');
                        }, 300);
                    }
                });
            });
        }
        
        // 初始化教程动画
        function initInstructionAnimation() {
            // 创建教程序列
            const instructions = [
                { word: '蓝', color: 'blue' },
                { word: '红', color: 'yellow' },
                { word: '绿', color: 'red' },
                { word: '黄', color: 'green' }
            ];
            
            let current = 0;
            
            // 重置文字
            updateInstructionWord(instructions[current].word, instructions[current].color);
            
            // 每3秒切换一个示例
            const interval = setInterval(() => {
                current = (current + 1) % instructions.length;
                updateInstructionWord(instructions[current].word, instructions[current].color);
            }, 3000);
            
            // 存储interval引用以便后续清除
            elements.instructionInterval = interval;
        }
        
        // 更新教程文字
        function updateInstructionWord(word, color) {
            // 移除所有颜色类
            elements.instructionWord.className = 'text-4xl font-bold';
            // 添加新的颜色类
            elements.instructionWord.classList.add(COLOR_CONFIG[color].cssClass);
            // 设置文字内容
            elements.instructionWord.textContent = word;
        }
        
        // 开始实验
        function startExperiment() {
            // 清除教程动画
            if (elements.instructionInterval) {
                clearInterval(elements.instructionInterval);
            }
            
            // 隐藏准备阶段，显示实验阶段
            elements.preparationStage.classList.add('hidden');
            elements.experimentStage.classList.remove('hidden');
            
            // 生成实验序列
            generateExperimentTrials();
            
            // 开始第一个试次
            experimentData.currentTrial = 0;
            startNextTrial();
        }
        
        // 生成实验序列
        function generateExperimentTrials() {
            experimentData.trials = [];
            
            // 生成一致试次
            for (let i = 0; i < EXPERIMENT_CONFIG.congruentTrials; i++) {
                const colorKeys = Object.keys(COLOR_CONFIG);
                const randomColor = colorKeys[Math.floor(Math.random() * colorKeys.length)];
                experimentData.trials.push({
                    type: 'congruent',
                    word: COLOR_CONFIG[randomColor].text,
                    color: randomColor
                });
            }
            
            // 生成不一致试次
            for (let i = 0; i < EXPERIMENT_CONFIG.incongruentTrials; i++) {
                const colorKeys = Object.keys(COLOR_CONFIG);
                let wordColor, textColor;
                
                // 确保文字颜色和文字含义不同
                do {
                    wordColor = colorKeys[Math.floor(Math.random() * colorKeys.length)];
                    textColor = colorKeys[Math.floor(Math.random() * colorKeys.length)];
                } while (wordColor === textColor);
                
                experimentData.trials.push({
                    type: 'incongruent',
                    word: COLOR_CONFIG[wordColor].text,
                    color: textColor
                });
            }
            
            // 随机打乱试次顺序
            experimentData.trials.sort(() => Math.random() - 0.5);
        }
        
        // 开始下一个试次
        function startNextTrial() {
            // 检查是否完成所有试次
            if (experimentData.currentTrial >= EXPERIMENT_CONFIG.totalTrials) {
                endExperiment();
                return;
            }
            
            // 更新进度
            updateProgress();
            
            // 获取当前试次
            const trial = experimentData.trials[experimentData.currentTrial];
            
            // 显示注视点
            elements.displayContent.textContent = '+';
            elements.displayContent.className = 'text-4xl font-bold';
            
            // 移除之前的按钮
            elements.colorButtons.innerHTML = '';
            
            // 隐藏颜色按钮
            elements.colorButtons.classList.add('hidden');
            
            // 延时后显示刺激
            setTimeout(() => {
                // 显示颜色词
                elements.displayContent.textContent = trial.word;
                elements.displayContent.className = 'text-4xl font-bold';
                elements.displayContent.classList.add(COLOR_CONFIG[trial.color].cssClass);
                
                // 生成打乱顺序的颜色按钮
                generateColorButtons();
                
                // 显示颜色按钮
                elements.colorButtons.classList.remove('hidden');
                
                // 记录开始时间
                experimentData.startTime = Date.now();
                
                // 设置超时
                experimentData.timeoutId = setTimeout(() => {
                    handleTimeout(trial);
                }, EXPERIMENT_CONFIG.responseTimeout);
            }, EXPERIMENT_CONFIG.fixationTime);
        }
        
        // 生成打乱顺序的颜色按钮
        function generateColorButtons() {
            const colors = ['red', 'yellow', 'blue', 'green'];
            
            // 打乱颜色顺序
            colors.sort(() => Math.random() - 0.5);
            
            // 创建按钮
            colors.forEach(color => {
                const button = document.createElement('button');
                button.className = `color-button ${COLOR_CONFIG[color].bgClass}`;
                button.setAttribute('data-color', color);
                button.innerHTML = `<span class="text-white font-bold">${COLOR_CONFIG[color].text}</span>`;
                
                // 添加点击事件
                button.addEventListener('click', function() {
                    handleResponse(color, button);
                });
                
                elements.colorButtons.appendChild(button);
            });
        }
        
        // 处理用户响应
        function handleResponse(selectedColor, button) {
            // 清除超时
            clearTimeout(experimentData.timeoutId);
            
            // 计算反应时
            const reactionTime = Date.now() - experimentData.startTime;
            
            // 获取当前试次
            const trial = experimentData.trials[experimentData.currentTrial];
            
            // 判断是否正确
            const isCorrect = selectedColor === trial.color;
            
            // 记录数据
            recordTrialData(trial, reactionTime, isCorrect);
            
            // 显示反馈
            if (isCorrect) {
                button.classList.add('correct-feedback');
            } else {
                button.classList.add('error-feedback');
            }
            
            // 延时后开始下一个试次
            setTimeout(() => {
                experimentData.currentTrial++;
                startNextTrial();
            }, EXPERIMENT_CONFIG.feedbackTime);
        }
        
        // 处理超时
        function handleTimeout(trial) {
            // 记录超时数据
            recordTrialData(trial, EXPERIMENT_CONFIG.responseTimeout, false);
            
            // 显示错误反馈
            elements.experimentArea.classList.add('error-feedback');
            
            // 延时后清除反馈并开始下一个试次
            setTimeout(() => {
                elements.experimentArea.classList.remove('error-feedback');
                experimentData.currentTrial++;
                startNextTrial();
            }, EXPERIMENT_CONFIG.feedbackTime);
        }
        
        // 记录试次数据
        function recordTrialData(trial, reactionTime, isCorrect) {
            // 记录到试次数组
            experimentData.trials[experimentData.currentTrial].reactionTime = reactionTime;
            experimentData.trials[experimentData.currentTrial].correct = isCorrect;
            
            // 更新统计数据
            if (trial.type === 'congruent') {
                experimentData.congruentTimes.push(reactionTime);
                if (isCorrect) experimentData.congruentCorrect++;
            } else {
                experimentData.incongruentTimes.push(reactionTime);
                if (isCorrect) experimentData.incongruentCorrect++;
            }
        }
        
        // 更新进度
        function updateProgress() {
            const progress = experimentData.currentTrial + 1;
            elements.progressText.textContent = `${progress}/${EXPERIMENT_CONFIG.totalTrials}`;
            elements.progressBar.style.width = `${(progress / EXPERIMENT_CONFIG.totalTrials) * 100}%`;
        }
        
        // 结束实验
        function endExperiment() {
            // 计算结果
            const results = calculateResults();
            
            // 显示结果
            displayResults(results);
            
            // 隐藏实验阶段，显示结果阶段
            elements.experimentStage.classList.add('hidden');
            elements.resultStage.classList.remove('hidden');
            
            // 保存到localStorage（即使未登录）
        if (window.API && window.API.saveExperimentResultToLocal) {
          window.API.saveExperimentResultToLocal('stroop', results);
        } else {
          // 降级到本地函数
          saveToLocalStorage(results);
        }
        }
        
        // 计算结果
        function calculateResults() {
            // 计算平均反应时
            const congruentAvg = experimentData.congruentTimes.reduce((sum, time) => sum + time, 0) / experimentData.congruentTimes.length;
            const incongruentAvg = experimentData.incongruentTimes.reduce((sum, time) => sum + time, 0) / experimentData.incongruentTimes.length;
            
            // 计算冲突效应
            const conflictEffect = incongruentAvg - congruentAvg;
            
            // 计算正确率
            const congruentAccuracy = (experimentData.congruentCorrect / experimentData.congruentTimes.length) * 100;
            const incongruentAccuracy = (experimentData.incongruentCorrect / experimentData.incongruentTimes.length) * 100;
            
            return {
                congruentAvg: Math.round(congruentAvg),
                incongruentAvg: Math.round(incongruentAvg),
                conflictEffect: Math.round(conflictEffect),
                congruentAccuracy: Math.round(congruentAccuracy),
                incongruentAccuracy: Math.round(incongruentAccuracy),
                timestamp: new Date().toISOString(),
                trials: experimentData.trials
            };
        }
        
        // 显示结果
        function displayResults(results) {
            // 更新数值显示
            elements.congruentTime.textContent = `${results.congruentAvg}ms`;
            elements.incongruentTime.textContent = `${results.incongruentAvg}ms`;
            elements.conflictEffect.textContent = `${results.conflictEffect}ms`;
            
            // 生成解释
            generateInterpretation(results.conflictEffect);
            
            // 绘制图表
            drawResultChart(results);
        }
        
        // 生成结果解释
        function generateInterpretation(conflictEffect) {
            let interpretation = '';
            
            if (conflictEffect < 100) {
                interpretation = '你的冲突效应值远低于平均水平，说明你的注意力抑制能力非常强 —— 大脑能高效抑制无关信息（文字含义）的干扰，专注于目标任务（颜色识别）。这是一种优秀的执行控制能力表现。';
            } else if (conflictEffect < 150) {
                interpretation = '你的冲突效应值低于平均水平，说明你的注意力抑制能力较强 —— 大脑能较快抑制无关信息（文字含义），专注于目标任务（颜色识别）。';
            } else if (conflictEffect < 200) {
                interpretation = '你的冲突效应值在正常范围内，表明你具有典型的注意力控制能力。在日常任务中，你能够较好地处理信息冲突，但仍有提升空间。';
            } else if (conflictEffect < 300) {
                interpretation = '你的冲突效应值略高于平均水平，说明在处理冲突信息时需要更多的认知资源。这可能意味着你在面对干扰时需要更多的努力来保持专注。';
            } else {
                interpretation = '你的冲突效应值明显高于平均水平，表明在处理冲突信息时存在较大的干扰效应。这可能与注意力分散、认知疲劳或其他因素有关。建议在需要高度专注的任务中，尝试减少干扰因素。';
            }
            
            elements.resultInterpretation.textContent = interpretation;
        }
        
        // 绘制结果图表
        async function drawResultChart(results) {
            const ctx = document.getElementById('result-chart').getContext('2d');
            
            // 获取群体平均数据
            let groupAvgCongruent = 550;
            let groupAvgIncongruent = 720;
            
            // 尝试从API获取统计数据
            if (window.API && window.API.getExperimentStats) {
                try {
                    const stats = await window.API.getExperimentStats('stroop');
                    if (stats && stats.congruentAvg && stats.incongruentAvg) {
                        groupAvgCongruent = stats.congruentAvg;
                        groupAvgIncongruent = stats.incongruentAvg;
                    }
                } catch (error) {
                    console.error('获取统计数据失败，使用默认值:', error);
                }
            }
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['一致条件', '冲突条件'],
                    datasets: [
                        {
                            label: '你的数据',
                            data: [results.congruentAvg, results.incongruentAvg],
                            backgroundColor: '#165DFF',
                            borderColor: '#165DFF',
                            borderWidth: 1
                        },
                        {
                            label: '群体平均',
                            data: [groupAvgCongruent, groupAvgIncongruent],
                            backgroundColor: '#D9D9D9',
                            borderColor: '#D9D9D9',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '反应时 (毫秒)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw}ms`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 保存到localStorage（降级方案）
        function saveToLocalStorage(results) {
            try {
                // 获取现有记录
                let experimentRecords = JSON.parse(localStorage.getItem('experimentRecords') || '[]');
                
                // 添加新记录
                experimentRecords.push({
                    type: 'stroop',
                    results: results,
                    timestamp: new Date().toISOString()
                });
                
                // 只保留最近20条记录
                if (experimentRecords.length > 20) {
                    experimentRecords = experimentRecords.slice(-20);
                }
                
                // 保存回localStorage
                localStorage.setItem('experimentRecords', JSON.stringify(experimentRecords));
            } catch (error) {
                console.error('保存实验结果到localStorage失败:', error);
            }
        }
        
        // 保存实验结果到服务器
        async function saveExperimentResult() {
            // 检查用户是否登录
            if (window.API && window.API.isAuthenticated) {
                if (!window.API.isAuthenticated()) {
                    // 显示登录提示
                    if (confirm('登录后可保存实验记录，是否立即登录？')) {
                        window.location.href = 'login.html';
                    }
                    return;
                }
            } else {
                // 降级检查
                const token = localStorage.getItem('token');
                if (!token) {
                    if (confirm('登录后可保存实验记录，是否立即登录？')) {
                        window.location.href = 'login.html';
                    }
                    return;
                }
            }
            
            // 获取最新的结果（从localStorage）
            try {
                let experimentRecords = JSON.parse(localStorage.getItem('experimentRecords') || '[]');
                const latestStroopResult = experimentRecords
                    .filter(record => record.type === 'stroop')
                    .pop();
                
                if (latestStroopResult && window.API && window.API.saveExperimentResult) {
                    // 调用API保存结果
                    await window.API.saveExperimentResult('stroop', latestStroopResult.results);
                    
                    // 显示成功提示
                    alert('实验结果保存成功！');
                    
                    // 禁用保存按钮
                    elements.saveResult.disabled = true;
                    elements.saveResult.classList.add('opacity-50');
                    elements.saveResult.textContent = '已保存';
                } else {
                    alert('保存失败，请稍后重试');
                }
            } catch (error) {
                console.error('保存实验结果失败:', error);
                alert('保存失败，请稍后重试');
            }
        }
        
        // 初始化导航栏
        function initNavbar() {
            // 这里可以添加导航栏特定的初始化逻辑
        }
    </script>
    <!-- 首先加载common.js以确保AuthManager可用 -->
    <script src="common.js"></script>
    <!-- 然后加载实验导航更新脚本 -->
    <script src="update_experiment_navigation.js"></script>
    
    <!-- 确保页面加载完成后更新登录状态 -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 立即强制同步登录状态
            if (window.forceExperimentLoginSync) {
                window.forceExperimentLoginSync();
            }
        });
        
        // 增强的登录检查函数
        function enhancedCheckLogin() {
            // 优先使用AuthManager
            if (window.AuthManager) {
                return window.AuthManager.isLoggedIn();
            } else {
                // 兼容旧的token检查和新的AuthManager格式
                const authToken = localStorage.getItem('auth_token');
                const oldToken = localStorage.getItem('token');
                const isLogin = localStorage.getItem('isLogin') === 'true';
                return authToken || oldToken || isLogin;
            }
        }
        
        // 监听全局登录事件，确保实验页面及时响应
        window.addEventListener('userLoggedIn', () => {
            console.log('斯特鲁普实验页面检测到用户登录');
            // 可以在这里更新UI，比如启用保存按钮
            const saveButton = document.querySelector('#save-result');
            if (saveButton) {
                saveButton.disabled = false;
                saveButton.classList.remove('opacity-50');
            }
        });
    </script>
    <!-- 统一页脚组件 -->
<footer class="bg-[#1e293b] text-white py-4">
    <div class="container mx-auto px-4">
        <div class="flex justify-between items-center">
            <!-- 左侧Logo和文字 -->
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 rounded-full bg-purple-500 flex items-center justify-center text-white">
                    <i class="fa fa-heart"></i>
                </div>
                <span class="text-white">心社区</span>
            </div>
            
            <!-- 中间版权信息 -->
            <div class="text-center">
                <p class="text-white">© 2025 心社区心理健康支持中心. 保留所有权利.</p>
            </div>
            
            <!-- 右侧图标 -->
            <div class="flex space-x-4">
                <a href="#" class="text-white/70 hover:text-white transition-colors">
                    <i class="fa fa-weixin"></i>
                </a>
                <a href="#" class="text-white/70 hover:text-white transition-colors">
                    <i class="fa fa-weibo"></i>
                </a>
                <a href="#" class="text-white/70 hover:text-white transition-colors">
                    <i class="fa fa-bell"></i>
                </a>
            </div>
        </div>
    </div>
</footer>
</body>
</html>