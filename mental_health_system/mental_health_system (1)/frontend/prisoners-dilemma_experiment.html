<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>心社区 - 心理健康支持平台</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 引入Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- Tailwind CSS配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#00B42A',
                        warning: '#FF7D00',
                        danger: '#F53F3F',
                        info: '#86909C',
                        light: '#F2F3F5',
                        dark: '#4E5969',
                        cooperation: '#00B42A',
                        betrayal: '#F53F3F'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- 自定义样式 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .game-board {
                background-color: white;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            }
            .decision-button {
                transition: all 0.2s ease;
                min-height: 80px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }
            .decision-button:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }
            .decision-button:active {
                transform: translateY(0);
            }
            .player-card {
                transition: all 0.3s ease;
            }
            .result-animation {
                animation: resultPulse 0.5s ease-out;
            }
            @keyframes resultPulse {
                0% { transform: scale(0.9); opacity: 0; }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); opacity: 1; }
            }
            .fade-in {
                animation: fadeIn 0.5s ease-out;
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            .slide-in {
                animation: slideIn 0.3s ease-out;
            }
            @keyframes slideIn {
                from { transform: translateY(10px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            .score-badge {
                animation: scorePop 0.3s ease-out;
            }
            @keyframes scorePop {
                0% { transform: scale(0); }
                70% { transform: scale(1.2); }
                100% { transform: scale(1); }
            }
            .strategy-quadrant {
                position: relative;
                min-height: 300px;
                border: 1px solid #E5E6EB;
                border-radius: 8px;
                overflow: hidden;
            }
            .strategy-point {
                position: absolute;
                width: 16px;
                height: 16px;
                background-color: #165DFF;
                border-radius: 50%;
                transform: translate(-50%, -50%);
                border: 3px solid white;
                box-shadow: 0 0 0 2px #165DFF;
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0% { box-shadow: 0 0 0 2px #165DFF; }
                50% { box-shadow: 0 0 0 4px rgba(22, 93, 255, 0.5); }
                100% { box-shadow: 0 0 0 2px #165DFF; }
            }
        }
    </style>
<link rel="stylesheet" href="experiments-responsive.css">
<style>

    /* 全局样式重置 */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    /* 全局颜色变量 */
    :root {
        --primary-color: #6366f1;
        --secondary-color: #8b5cf6;
        --text-primary: #1e293b;
        --text-secondary: #475569;
        --bg-primary: #ffffff;
        --bg-secondary: #f8fafc;
        --border-color: #e2e8f0;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        line-height: 1.6;
        color: var(--text-primary);
        background-color: var(--bg-primary);
    }
    
    /* 统一按钮样式 */
    button {
        font-family: inherit;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        outline: none;
    }
    
    /* 主按钮样式 - 注册按钮 */
    .btn-primary {
        background-color: var(--secondary-color);
        color: white;
        border-radius: 8px;
        padding: 8px 16px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }
    
    .btn-primary:hover {
        background-color: #7c3aed;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(139, 92, 246, 0.2);
    }
    
    /* 次要按钮样式 - 登录按钮 */
    .btn-secondary {
        background-color: transparent;
        color: var(--primary-color);
        border: 1px solid var(--primary-color);
        border-radius: 8px;
        padding: 8px 16px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }
    
    .btn-secondary:hover {
        background-color: rgba(99, 102, 241, 0.05);
        transform: translateY(-1px);
    }
    
    /* 导航栏样式 */
    nav {
        background-color: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--border-color);
    }
    
    /* 响应式设计 */
    @media (max-width: 768px) {
        .btn-primary,
        .btn-secondary {
            padding: 6px 12px;
            font-size: 0.875rem;
        }
    }
    
    /* 卡片样式 */
    .card {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        padding: 1.5rem;
    }
    
    /* 输入框样式 */
    input,
    textarea,
    select {
        font-family: inherit;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 8px 12px;
        transition: border-color 0.3s ease;
    }
    
    input:focus,
    textarea:focus,
    select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

</style>
</head>
<body class="bg-light min-h-screen flex flex-col">
    <!-- 导航栏组件 -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <nav id="main-nav"></nav>
    </header>

    <!-- 主要内容区域 -->
    <main class="flex-grow container mx-auto px-4 py-8">
        <!-- 页面标题 -->
        <div class="text-center mb-8">
            <h1 class="text-[clamp(1.5rem,3vw,2rem)] font-bold text-primary mb-2">囚徒困境游戏</h1>
            <p class="text-dark text-base">探索合作与竞争中的决策心理</p>
        </div>

        <!-- 实验容器 -->
        <div class="bg-white rounded-xl shadow-md p-6 md:p-8 max-w-4xl mx-auto">
            <!-- 准备阶段 -->
            <div id="preparation-stage" class="space-y-6">
                <div class="bg-light rounded-lg p-6">
                    <h2 class="text-xl font-bold text-dark mb-4">游戏背景</h2>
                    <p class="text-dark mb-4">"囚徒困境"是博弈论中的经典模型，描述了两个被捕的囚徒之间的特殊博弈关系。</p>
                    <p class="text-dark">在这个游戏中，你将与一位虚拟对手进行5轮决策。每轮你都需要在"合作"和"背叛"之间做出选择。双方的选择将共同决定你们各自获得的分数。</p>
                </div>

                <div class="bg-light rounded-lg p-6">
                    <h2 class="text-xl font-bold text-dark mb-4">得分规则</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full border-collapse">
                            <thead>
                                <tr class="bg-primary/10">
                                    <th class="border border-gray-300 p-3 text-left text-dark">你的选择</th>
                                    <th class="border border-gray-300 p-3 text-left text-dark">对手选择</th>
                                    <th class="border border-gray-300 p-3 text-left text-dark">你的得分</th>
                                    <th class="border border-gray-300 p-3 text-left text-dark">对手得分</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="border border-gray-300 p-3 text-cooperation">合作</td>
                                    <td class="border border-gray-300 p-3 text-cooperation">合作</td>
                                    <td class="border border-gray-300 p-3 text-secondary font-medium">+3</td>
                                    <td class="border border-gray-300 p-3 text-secondary font-medium">+3</td>
                                </tr>
                                <tr>
                                    <td class="border border-gray-300 p-3 text-cooperation">合作</td>
                                    <td class="border border-gray-300 p-3 text-betrayal">背叛</td>
                                    <td class="border border-gray-300 p-3 text-danger font-medium">0</td>
                                    <td class="border border-gray-300 p-3 text-secondary font-medium">+5</td>
                                </tr>
                                <tr>
                                    <td class="border border-gray-300 p-3 text-betrayal">背叛</td>
                                    <td class="border border-gray-300 p-3 text-cooperation">合作</td>
                                    <td class="border border-gray-300 p-3 text-secondary font-medium">+5</td>
                                    <td class="border border-gray-300 p-3 text-danger font-medium">0</td>
                                </tr>
                                <tr>
                                    <td class="border border-gray-300 p-3 text-betrayal">背叛</td>
                                    <td class="border border-gray-300 p-3 text-betrayal">背叛</td>
                                    <td class="border border-gray-300 p-3 text-warning font-medium">+1</td>
                                    <td class="border border-gray-300 p-3 text-warning font-medium">+1</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <p class="text-dark mt-4 text-sm">
                        <i class="fa fa-info-circle text-primary mr-2"></i>
                        从单次博弈看，背叛总能获得更高收益；但从长远看，合作才是最优策略。这个游戏将帮助你探索自己的决策风格。
                    </p>
                </div>

                <div class="flex justify-center">
                    <button id="start-tutorial" class="bg-primary hover:bg-primary/90 text-white py-3 px-8 rounded-lg font-medium transition-all transform hover:scale-105">
                        开始教程
                    </button>
                </div>
            </div>

            <!-- 教程阶段 -->
            <div id="tutorial-stage" class="hidden space-y-6 slide-in">
                <div class="text-center">
                    <h2 class="text-xl font-bold text-dark mb-4">游戏演示</h2>
                    <p class="text-dark">请了解游戏的具体流程</p>
                </div>

                <div class="game-board p-6">
                    <div class="grid grid-cols-2 gap-6">
                        <!-- 你的选择 -->
                        <div class="player-card border-2 border-primary rounded-lg p-4 bg-primary/5">
                            <div class="text-center mb-3">
                                <h3 class="font-bold text-primary">你</h3>
                                <p class="text-sm text-dark">请做出你的选择</p>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <button class="bg-cooperation/20 border border-cooperation text-cooperation rounded-lg p-3">
                                    <i class="fa fa-handshake-o text-xl block mb-1"></i>
                                    <span class="text-sm">合作</span>
                                </button>
                                <button class="bg-betrayal/20 border border-betrayal text-betrayal rounded-lg p-3">
                                    <i class="fa fa-times-circle-o text-xl block mb-1"></i>
                                    <span class="text-sm">背叛</span>
                                </button>
                            </div>
                        </div>

                        <!-- 对手的选择 -->
                        <div class="player-card border-2 border-gray-300 rounded-lg p-4 bg-light">
                            <div class="text-center mb-3">
                                <h3 class="font-bold text-dark">对手</h3>
                                <p class="text-sm text-dark">正在思考...</p>
                            </div>
                            <div class="flex justify-center items-center h-20">
                                <i class="fa fa-spinner fa-spin text-2xl text-dark"></i>
                            </div>
                        </div>
                    </div>

                    <!-- 结果区域 -->
                    <div class="mt-6 p-4 border border-gray-300 rounded-lg bg-light">
                        <h4 class="font-medium text-dark mb-3">本轮结果</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center">
                                <p class="text-dark text-sm mb-1">你选择了</p>
                                <p class="font-bold text-cooperation">合作</p>
                                <p class="mt-3 text-dark text-sm">得分: <span class="text-secondary font-bold">+3</span></p>
                            </div>
                            <div class="text-center">
                                <p class="text-dark text-sm mb-1">对手选择了</p>
                                <p class="font-bold text-cooperation">合作</p>
                                <p class="mt-3 text-dark text-sm">得分: <span class="text-secondary font-bold">+3</span></p>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <p class="text-dark">双方合作共赢！</p>
                        </div>
                    </div>
                </div>

                <div class="bg-light rounded-lg p-4">
                    <p class="text-dark text-sm">
                        <i class="fa fa-lightbulb-o text-warning mr-2"></i>
                        游戏共有5轮，你的目标是获得尽可能多的分数。记住，你的每个选择都会影响双方的收益。试着思考最优的决策策略。
                    </p>
                </div>

                <div class="flex justify-center">
                    <button id="start-experiment" class="bg-primary hover:bg-primary/90 text-white py-2 px-6 rounded-lg font-medium transition-all transform hover:scale-105">
                        开始游戏
                    </button>
                </div>
            </div>

            <!-- 实验阶段 -->
            <div id="experiment-stage" class="hidden space-y-6">
                <!-- 进度信息 -->
                <div class="text-center">
                    <div class="inline-block text-dark font-medium mb-2">
                        轮次: <span id="current-round">1</span>/<span id="total-rounds">5</span>
                    </div>
                    <div class="w-full bg-light rounded-full h-2.5">
                        <div id="progress-bar" class="bg-primary h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>

                <!-- 总分数显示 -->
                <div class="grid grid-cols-2 gap-4 max-w-md mx-auto">
                    <div class="bg-primary/10 rounded-lg p-3 text-center">
                        <p class="text-dark text-sm">你的总分</p>
                        <p id="your-total-score" class="text-primary font-bold text-xl">0</p>
                    </div>
                    <div class="bg-dark/10 rounded-lg p-3 text-center">
                        <p class="text-dark text-sm">对手总分</p>
                        <p id="opponent-total-score" class="text-dark font-bold text-xl">0</p>
                    </div>
                </div>

                <!-- 游戏板 -->
                <div class="game-board p-6">
                    <div class="grid grid-cols-2 gap-6">
                        <!-- 你的选择 -->
                        <div id="your-card" class="player-card border-2 border-primary rounded-lg p-4 bg-primary/5">
                            <div class="text-center mb-3">
                                <h3 class="font-bold text-primary">你</h3>
                                <p class="text-sm text-dark" id="your-status">请做出你的选择</p>
                            </div>
                            <div id="your-selection" class="grid grid-cols-2 gap-3">
                                <button id="cooperate-button" class="decision-button bg-cooperation/20 hover:bg-cooperation/30 border border-cooperation text-cooperation rounded-lg p-3">
                                    <i class="fa fa-handshake-o text-xl block mb-1"></i>
                                    <span class="text-sm">合作</span>
                                </button>
                                <button id="betray-button" class="decision-button bg-betrayal/20 hover:bg-betrayal/30 border border-betrayal text-betrayal rounded-lg p-3">
                                    <i class="fa fa-times-circle-o text-xl block mb-1"></i>
                                    <span class="text-sm">背叛</span>
                                </button>
                            </div>
                            <div id="your-choice-display" class="hidden text-center p-4">
                                <p id="your-choice-text" class="font-bold text-xl"></p>
                            </div>
                        </div>

                        <!-- 对手的选择 -->
                        <div id="opponent-card" class="player-card border-2 border-gray-300 rounded-lg p-4 bg-light">
                            <div class="text-center mb-3">
                                <h3 class="font-bold text-dark">对手</h3>
                                <p class="text-sm text-dark" id="opponent-status">正在思考...</p>
                            </div>
                            <div id="opponent-thinking" class="flex justify-center items-center h-24">
                                <i class="fa fa-spinner fa-spin text-2xl text-dark"></i>
                            </div>
                            <div id="opponent-choice-display" class="hidden text-center p-4">
                                <p id="opponent-choice-text" class="font-bold text-xl"></p>
                            </div>
                        </div>
                    </div>

                    <!-- 结果区域 -->
                    <div id="round-result" class="hidden mt-6 p-4 border border-gray-300 rounded-lg bg-light result-animation">
                        <h4 class="font-medium text-dark mb-3">本轮结果</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center">
                                <p class="text-dark text-sm mb-1">你选择了</p>
                                <p id="result-your-choice" class="font-bold"></p>
                                <p class="mt-3 text-dark text-sm">本轮得分: <span id="your-round-score" class="font-bold"></span></p>
                            </div>
                            <div class="text-center">
                                <p class="text-dark text-sm mb-1">对手选择了</p>
                                <p id="result-opponent-choice" class="font-bold"></p>
                                <p class="mt-3 text-dark text-sm">本轮得分: <span id="opponent-round-score" class="font-bold"></span></p>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <p id="result-message" class="text-dark"></p>
                        </div>
                        <div class="flex justify-center mt-4">
                            <button id="next-round-button" class="bg-primary hover:bg-primary/90 text-white py-2 px-6 rounded-lg font-medium transition-all">
                                下一轮
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 历史记录 -->
                <div class="bg-light rounded-lg p-4">
                    <h4 class="font-medium text-dark mb-3">历史记录</h4>
                    <div id="history-list" class="grid grid-cols-5 gap-2 text-center text-sm">
                        <!-- 历史记录将动态填充 -->
                    </div>
                </div>
            </div>

            <!-- 结果阶段 -->
            <div id="result-stage" class="hidden space-y-6 fade-in">
                <div class="text-center">
                    <h2 class="text-xl font-bold text-dark mb-2">游戏完成！</h2>
                    <p class="text-dark">你的决策策略分析</p>
                </div>

                <!-- 最终得分 -->
                <div class="grid grid-cols-2 gap-6 max-w-md mx-auto">
                    <div class="bg-primary/10 rounded-lg p-4 text-center">
                        <p class="text-dark mb-2">你的总分</p>
                        <p id="final-your-score" class="text-primary font-bold text-2xl">0</p>
                    </div>
                    <div class="bg-dark/10 rounded-lg p-4 text-center">
                        <p class="text-dark mb-2">对手总分</p>
                        <p id="final-opponent-score" class="text-dark font-bold text-2xl">0</p>
                    </div>
                </div>

                <!-- 策略分析图表 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-light rounded-lg p-4">
                        <h3 class="text-lg font-bold text-dark mb-4">决策分布</h3>
                        <div class="w-full h-64">
                            <canvas id="decision-distribution-chart"></canvas>
                        </div>
                    </div>
                    <div class="bg-light rounded-lg p-4">
                        <h3 class="text-lg font-bold text-dark mb-4">每轮得分</h3>
                        <div class="w-full h-64">
                            <canvas id="score-trend-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 策略象限图 -->
                <div class="bg-light rounded-lg p-4">
                    <h3 class="text-lg font-bold text-dark mb-4">决策策略定位</h3>
                    <div class="strategy-quadrant mb-4">
                        <!-- 象限标签 -->
                        <div class="absolute top-0 left-0 right-0 text-center bg-white/80 p-2 border-b border-gray-300">
                            <span class="text-dark">高合作性</span>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 text-center bg-white/80 p-2 border-t border-gray-300">
                            <span class="text-dark">低合作性</span>
                        </div>
                        <div class="absolute top-0 bottom-0 left-0 flex items-center bg-white/80 pl-2 border-r border-gray-300">
                            <span class="text-dark writing-vertical-rl transform rotate-180">低回报导向</span>
                        </div>
                        <div class="absolute top-0 bottom-0 right-0 flex items-center bg-white/80 pr-2 border-l border-gray-300">
                            <span class="text-dark writing-vertical-rl">高回报导向</span>
                        </div>
                        
                        <!-- 策略区域标签 -->
                        <div class="absolute top-1/4 left-1/4 transform -translate-x-1/2 -translate-y-1/2 text-dark text-center">
                            <div class="bg-white/80 px-3 py-1 rounded shadow-sm">利他型</div>
                        </div>
                        <div class="absolute top-1/4 right-1/4 transform -translate-x-1/2 -translate-y-1/2 text-dark text-center">
                            <div class="bg-white/80 px-3 py-1 rounded shadow-sm">互利型</div>
                        </div>
                        <div class="absolute bottom-1/4 left-1/4 transform -translate-x-1/2 -translate-y-1/2 text-dark text-center">
                            <div class="bg-white/80 px-3 py-1 rounded shadow-sm">退让型</div>
                        </div>
                        <div class="absolute bottom-1/4 right-1/4 transform -translate-x-1/2 -translate-y-1/2 text-dark text-center">
                            <div class="bg-white/80 px-3 py-1 rounded shadow-sm">竞争型</div>
                        </div>
                        
                        <!-- 策略点 -->
                        <div id="strategy-position" class="strategy-point" style="left: 50%; top: 50%;"></div>
                    </div>
                    <p class="text-dark text-sm text-center">
                        <i class="fa fa-info-circle text-primary mr-2"></i>
                        蓝色点表示你的策略位置，四个象限代表不同的决策风格
                    </p>
                </div>

                <!-- 详细分析 -->
                <div class="bg-light rounded-lg p-6">
                    <h3 class="text-lg font-bold text-dark mb-3">详细分析</h3>
                    <div class="space-y-3">
                        <div>
                            <p class="text-dark font-medium mb-1">策略类型：</p>
                            <p id="strategy-type" class="text-primary font-bold"></p>
                        </div>
                        <div>
                            <p class="text-dark font-medium mb-1">合作率：</p>
                            <p id="cooperation-rate" class="text-dark"></p>
                        </div>
                        <div>
                            <p class="text-dark font-medium mb-1">平均每轮得分：</p>
                            <p id="avg-score" class="text-dark"></p>
                        </div>
                        <div>
                            <p class="text-dark font-medium mb-1">策略特点：</p>
                            <p id="strategy-description" class="text-dark"></p>
                        </div>
                    </div>
                </div>

                <!-- 结果解读 -->
                <div class="bg-light rounded-lg p-6">
                    <h3 class="text-lg font-bold text-dark mb-3">结果解读</h3>
                    <p id="result-interpretation" class="text-dark">
                        你的决策模式显示...
                    </p>
                    <p class="text-info text-sm mt-3">*实验结果仅作科普参考，不构成心理诊断</p>
                </div>

                <!-- 操作按钮 -->
                <div class="flex flex-wrap justify-center gap-4">
                    <button id="save-result" class="bg-primary hover:bg-primary/90 text-white py-2 px-6 rounded-lg font-medium transition-all">
                        <i class="fa fa-save mr-2"></i> 保存结果
                    </button>
                    <button id="restart-experiment" class="bg-info hover:bg-info/90 text-white py-2 px-6 rounded-lg font-medium transition-all">
                        <i class="fa fa-refresh mr-2"></i> 重新开始
                    </button>
                    <button id="back-to-hall" class="bg-dark hover:bg-dark/90 text-white py-2 px-6 rounded-lg font-medium transition-all">
                        <i class="fa fa-arrow-left mr-2"></i> 返回大厅
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚组件 -->
    <!-- 统一页脚组件 -->
<footer class="bg-[#1e293b] text-white py-4">
    <div class="container mx-auto px-4">
        <div class="flex justify-between items-center">
            <!-- 左侧Logo和文字 -->
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 rounded-full bg-purple-500 flex items-center justify-center text-white">
                    <i class="fa fa-heart"></i>
                </div>
                <span class="text-white">心社区</span>
            </div>
            
            <!-- 中间版权信息 -->
            <div class="text-center">
                <p class="text-white">© 2025 心社区心理健康支持中心. 保留所有权利.</p>
            </div>
            
            <!-- 右侧图标 -->
            <div class="flex space-x-4">
                <a href="#" class="text-white/70 hover:text-white transition-colors">
                    <i class="fa fa-weixin"></i>
                </a>
                <a href="#" class="text-white/70 hover:text-white transition-colors">
                    <i class="fa fa-weibo"></i>
                </a>
                <a href="#" class="text-white/70 hover:text-white transition-colors">
                    <i class="fa fa-bell"></i>
                </a>
            </div>
        </div>
    </div>
</footer>

    <!-- 引入公共脚本 -->
    <script src="common.js"></script>
    <!-- 引入API模块 -->
    <script type="module">
      // 导入API函数
      import { 
        isAuthenticated, 
        saveExperimentResult, 
        saveExperimentResultToLocal,
        getExperimentStats 
      } from './api.js';
      
      // 将API函数暴露给全局作用域，供后续脚本使用
      window.API = {
        isAuthenticated,
        saveExperimentResult,
        saveExperimentResultToLocal,
        getExperimentStats
      };
    </script>
    <!-- 实验脚本 -->
    <script>
        // 游戏配置
        const config = {
            totalRounds: 5, // 总共5轮游戏
            // 对手策略：采用"以牙还牙"策略，第一轮合作，之后跟随玩家上一轮的选择
            opponentStrategy: 'titForTat',
            // 时间配置（毫秒）
            timing: {
                opponentDecisionTime: 1000, // 对手"思考"时间
                resultDisplayTime: 2000    // 结果显示时间
            },
            // 得分配置
            scoring: {
                bothCooperate: { player: 3, opponent: 3 },
                playerCooperateOpponentBetray: { player: 0, opponent: 5 },
                playerBetrayOpponentCooperate: { player: 5, opponent: 0 },
                bothBetray: { player: 1, opponent: 1 }
            }
        };

        // DOM元素
        const elements = {
            preparation: document.getElementById('preparation-stage'),
            tutorial: document.getElementById('tutorial-stage'),
            experiment: document.getElementById('experiment-stage'),
            result: document.getElementById('result-stage'),
            startTutorial: document.getElementById('start-tutorial'),
            startExperiment: document.getElementById('start-experiment'),
            // 实验元素
            currentRound: document.getElementById('current-round'),
            totalRounds: document.getElementById('total-rounds'),
            progressBar: document.getElementById('progress-bar'),
            yourTotalScore: document.getElementById('your-total-score'),
            opponentTotalScore: document.getElementById('opponent-total-score'),
            yourCard: document.getElementById('your-card'),
            opponentCard: document.getElementById('opponent-card'),
            yourStatus: document.getElementById('your-status'),
            opponentStatus: document.getElementById('opponent-status'),
            yourSelection: document.getElementById('your-selection'),
            yourChoiceDisplay: document.getElementById('your-choice-display'),
            yourChoiceText: document.getElementById('your-choice-text'),
            opponentThinking: document.getElementById('opponent-thinking'),
            opponentChoiceDisplay: document.getElementById('opponent-choice-display'),
            opponentChoiceText: document.getElementById('opponent-choice-text'),
            cooperateButton: document.getElementById('cooperate-button'),
            betrayButton: document.getElementById('betray-button'),
            roundResult: document.getElementById('round-result'),
            resultYourChoice: document.getElementById('result-your-choice'),
            resultOpponentChoice: document.getElementById('result-opponent-choice'),
            yourRoundScore: document.getElementById('your-round-score'),
            opponentRoundScore: document.getElementById('opponent-round-score'),
            resultMessage: document.getElementById('result-message'),
            nextRoundButton: document.getElementById('next-round-button'),
            historyList: document.getElementById('history-list'),
            // 结果元素
            finalYourScore: document.getElementById('final-your-score'),
            finalOpponentScore: document.getElementById('final-opponent-score'),
            strategyType: document.getElementById('strategy-type'),
            cooperationRate: document.getElementById('cooperation-rate'),
            avgScore: document.getElementById('avg-score'),
            strategyDescription: document.getElementById('strategy-description'),
            resultInterpretation: document.getElementById('result-interpretation'),
            strategyPosition: document.getElementById('strategy-position'),
            saveResult: document.getElementById('save-result'),
            restartExperiment: document.getElementById('restart-experiment'),
            backToHall: document.getElementById('back-to-hall')
        };

        // 游戏数据
        let gameData = {
            currentRound: 0,
            yourScore: 0,
            opponentScore: 0,
            rounds: [],
            opponentLastChoice: null // 对手上一轮的选择（用于策略计算）
        };

        // 绑定事件
        function bindEvents() {
            elements.startTutorial.addEventListener('click', startTutorial);
            elements.startExperiment.addEventListener('click', startExperiment);
            elements.restartExperiment.addEventListener('click', restartExperiment);
            elements.saveResult.addEventListener('click', saveGameResult);
            elements.backToHall.addEventListener('click', () => {
                window.location.href = 'psychology_experiments.html';
            });
            elements.cooperateButton.addEventListener('click', () => makeChoice('cooperate'));
            elements.betrayButton.addEventListener('click', () => makeChoice('betray'));
            elements.nextRoundButton.addEventListener('click', nextRound);
        }

        // 开始教程
        function startTutorial() {
            elements.preparation.classList.add('hidden');
            elements.tutorial.classList.remove('hidden');
            elements.experiment.classList.add('hidden');
            elements.result.classList.add('hidden');
        }

        // 开始游戏
        function startExperiment() {
            elements.tutorial.classList.add('hidden');
            elements.experiment.classList.remove('hidden');
            elements.result.classList.add('hidden');
            
            // 重置游戏数据
            resetGameData();
            
            // 初始化历史记录
            initHistoryList();
            
            // 开始第一轮
            startNewRound();
        }

        // 重置游戏数据
        function resetGameData() {
            gameData = {
                currentRound: 0,
                yourScore: 0,
                opponentScore: 0,
                rounds: [],
                opponentLastChoice: null // 第一轮对手将合作
            };
            
            // 更新显示
            elements.currentRound.textContent = '1';
            elements.totalRounds.textContent = config.totalRounds;
            elements.progressBar.style.width = '0%';
            elements.yourTotalScore.textContent = '0';
            elements.opponentTotalScore.textContent = '0';
        }

        // 初始化历史记录
        function initHistoryList() {
            elements.historyList.innerHTML = '';
            for (let i = 1; i <= config.totalRounds; i++) {
                const roundIndicator = document.createElement('div');
                roundIndicator.className = 'bg-white rounded-full h-8 flex items-center justify-center border border-gray-300';
                roundIndicator.textContent = i;
                roundIndicator.id = `round-history-${i}`;
                elements.historyList.appendChild(roundIndicator);
            }
        }

        // 开始新的一轮
        function startNewRound() {
            // 增加当前轮次
            gameData.currentRound++;
            
            // 更新显示
            elements.currentRound.textContent = gameData.currentRound;
            elements.progressBar.style.width = `${((gameData.currentRound - 1) / config.totalRounds) * 100}%`;
            
            // 重置状态
            elements.yourStatus.textContent = '请做出你的选择';
            elements.opponentStatus.textContent = '正在思考...';
            
            // 显示选择区域，隐藏结果
            elements.yourSelection.classList.remove('hidden');
            elements.yourChoiceDisplay.classList.add('hidden');
            elements.opponentThinking.classList.remove('hidden');
            elements.opponentChoiceDisplay.classList.add('hidden');
            elements.roundResult.classList.add('hidden');
            
            // 更新历史记录指示器
            updateHistoryIndicator();
        }

        // 更新历史记录指示器
        function updateHistoryIndicator() {
            // 重置所有指示器样式
            for (let i = 1; i <= config.totalRounds; i++) {
                const indicator = document.getElementById(`round-history-${i}`);
                if (i < gameData.currentRound) {
                    // 已完成的轮次
                    indicator.classList.remove('bg-white', 'border-gray-300');
                    indicator.classList.add('bg-primary/20', 'border-primary');
                } else if (i === gameData.currentRound) {
                    // 当前轮次
                    indicator.classList.remove('bg-primary/20', 'bg-white', 'border-gray-300');
                    indicator.classList.add('bg-primary', 'text-white', 'border-primary');
                } else {
                    // 未来轮次
                    indicator.classList.remove('bg-primary/20', 'bg-primary', 'text-white', 'border-primary');
                    indicator.classList.add('bg-white', 'border-gray-300');
                }
            }
        }

        // 做出选择
        function makeChoice(choice) {
            // 禁用选择按钮
            elements.cooperateButton.disabled = true;
            elements.betrayButton.disabled = true;
            
            // 更新状态
            elements.yourStatus.textContent = '你已做出选择';
            
            // 显示你的选择
            elements.yourSelection.classList.add('hidden');
            elements.yourChoiceDisplay.classList.remove('hidden');
            
            if (choice === 'cooperate') {
                elements.yourChoiceText.textContent = '合作';
                elements.yourChoiceText.className = 'font-bold text-xl text-cooperation';
            } else {
                elements.yourChoiceText.textContent = '背叛';
                elements.yourChoiceText.className = 'font-bold text-xl text-betrayal';
            }
            
            // 计算对手的选择
            const opponentChoice = calculateOpponentChoice();
            
            // 延迟显示对手的选择
            setTimeout(() => {
                revealOpponentChoice(choice, opponentChoice);
            }, config.timing.opponentDecisionTime);
        }

        // 计算对手的选择（采用以牙还牙策略）
        function calculateOpponentChoice() {
            // 第一轮或者以牙还牙策略
            if (gameData.opponentLastChoice === null) {
                // 第一轮对手选择合作
                return 'cooperate';
            } else if (config.opponentStrategy === 'titForTat') {
                // 之后的轮次跟随玩家上一轮的选择
                return gameData.rounds[gameData.rounds.length - 1].yourChoice;
            }
            // 默认合作
            return 'cooperate';
        }

        // 显示对手的选择
        function revealOpponentChoice(yourChoice, opponentChoice) {
            // 更新对手状态
            elements.opponentStatus.textContent = '已做出选择';
            
            // 隐藏思考动画，显示选择
            elements.opponentThinking.classList.add('hidden');
            elements.opponentChoiceDisplay.classList.remove('hidden');
            
            if (opponentChoice === 'cooperate') {
                elements.opponentChoiceText.textContent = '合作';
                elements.opponentChoiceText.className = 'font-bold text-xl text-cooperation';
            } else {
                elements.opponentChoiceText.textContent = '背叛';
                elements.opponentChoiceText.className = 'font-bold text-xl text-betrayal';
            }
            
            // 计算得分
            const scores = calculateScores(yourChoice, opponentChoice);
            
            // 更新总分
            gameData.yourScore += scores.player;
            gameData.opponentScore += scores.opponent;
            
            // 更新总分显示
            elements.yourTotalScore.textContent = gameData.yourScore;
            elements.opponentTotalScore.textContent = gameData.opponentScore;
            
            // 记录本轮结果
            gameData.rounds.push({
                round: gameData.currentRound,
                yourChoice: yourChoice,
                opponentChoice: opponentChoice,
                yourScore: scores.player,
                opponentScore: scores.opponent
            });
            
            // 更新对手上一轮选择
            gameData.opponentLastChoice = opponentChoice;
            
            // 延迟显示结果
            setTimeout(() => {
                showRoundResult(yourChoice, opponentChoice, scores);
            }, 500);
        }

        // 计算得分
        function calculateScores(yourChoice, opponentChoice) {
            if (yourChoice === 'cooperate' && opponentChoice === 'cooperate') {
                return config.scoring.bothCooperate;
            } else if (yourChoice === 'cooperate' && opponentChoice === 'betray') {
                return config.scoring.playerCooperateOpponentBetray;
            } else if (yourChoice === 'betray' && opponentChoice === 'cooperate') {
                return config.scoring.playerBetrayOpponentCooperate;
            } else {
                return config.scoring.bothBetray;
            }
        }

        // 显示轮次结果
        function showRoundResult(yourChoice, opponentChoice, scores) {
            // 更新结果显示
            if (yourChoice === 'cooperate') {
                elements.resultYourChoice.textContent = '合作';
                elements.resultYourChoice.className = 'font-bold text-cooperation';
            } else {
                elements.resultYourChoice.textContent = '背叛';
                elements.resultYourChoice.className = 'font-bold text-betrayal';
            }
            
            if (opponentChoice === 'cooperate') {
                elements.resultOpponentChoice.textContent = '合作';
                elements.resultOpponentChoice.className = 'font-bold text-cooperation';
            } else {
                elements.resultOpponentChoice.textContent = '背叛';
                elements.resultOpponentChoice.className = 'font-bold text-betrayal';
            }
            
            // 设置得分样式
            if (scores.player > 0) {
                elements.yourRoundScore.textContent = `+${scores.player}`;
                elements.yourRoundScore.className = 'font-bold text-secondary';
            } else {
                elements.yourRoundScore.textContent = scores.player;
                elements.yourRoundScore.className = 'font-bold text-danger';
            }
            
            if (scores.opponent > 0) {
                elements.opponentRoundScore.textContent = `+${scores.opponent}`;
                elements.opponentRoundScore.className = 'font-bold text-secondary';
            } else {
                elements.opponentRoundScore.textContent = scores.opponent;
                elements.opponentRoundScore.className = 'font-bold text-danger';
            }
            
            // 设置结果消息
            let message = '';
            if (yourChoice === 'cooperate' && opponentChoice === 'cooperate') {
                message = '双方合作共赢！';
                elements.resultMessage.className = 'text-secondary';
            } else if (yourChoice === 'cooperate' && opponentChoice === 'betray') {
                message = '你选择了合作，但对手背叛了你。';
                elements.resultMessage.className = 'text-danger';
            } else if (yourChoice === 'betray' && opponentChoice === 'cooperate') {
                message = '你选择了背叛，对手选择了合作。';
                elements.resultMessage.className = 'text-warning';
            } else {
                message = '双方都选择了背叛，两败俱伤。';
                elements.resultMessage.className = 'text-dark';
            }
            
            elements.resultMessage.textContent = message;
            
            // 显示结果区域
            elements.roundResult.classList.remove('hidden');
        }

        // 下一轮
        function nextRound() {
            if (gameData.currentRound >= config.totalRounds) {
                // 游戏结束，显示结果
                showResults();
            } else {
                // 重置按钮状态
                elements.cooperateButton.disabled = false;
                elements.betrayButton.disabled = false;
                
                // 开始下一轮
                startNewRound();
            }
        }

        // 显示最终结果
        function showResults() {
            // 隐藏实验阶段，显示结果阶段
            elements.experiment.classList.add('hidden');
            elements.result.classList.remove('hidden');
            
            // 更新最终得分
            elements.finalYourScore.textContent = gameData.yourScore;
            elements.finalOpponentScore.textContent = gameData.opponentScore;
            
            // 计算统计数据
            const stats = calculateStatistics();
            
            // 更新分析信息
            updateAnalysis(stats);
            
            // 绘制图表
            drawCharts(stats);
            
            // 设置策略位置
            setStrategyPosition(stats);
            
            // 保存到localStorage（即使未登录）
            if (window.API && window.API.saveExperimentResultToLocal) {
                window.API.saveExperimentResultToLocal('prisoners-dilemma', {
                    rounds: gameData.rounds,
                    statistics: stats,
                    yourScore: gameData.yourScore,
                    opponentScore: gameData.opponentScore,
                    timestamp: new Date().toISOString()
                });
            } else {
                // 降级到本地函数
                saveToLocalStorage({
                    rounds: gameData.rounds,
                    statistics: stats,
                    yourScore: gameData.yourScore,
                    opponentScore: gameData.opponentScore,
                    timestamp: new Date().toISOString()
                });
            }
        }

        // 计算统计数据
        function calculateStatistics() {
            const rounds = gameData.rounds;
            
            // 计算合作次数
            const cooperateCount = rounds.filter(round => round.yourChoice === 'cooperate').length;
            
            // 计算合作率
            const cooperationRate = Math.round((cooperateCount / rounds.length) * 100);
            
            // 计算平均每轮得分
            const avgScore = (gameData.yourScore / rounds.length).toFixed(1);
            
            // 计算互惠行为（对方合作，你也合作）
            const reciprocalCooperationCount = rounds.filter(round => 
                round.opponentChoice === 'cooperate' && round.yourChoice === 'cooperate'
            ).length;
            
            // 计算报复行为（对方背叛，你也背叛）
            const retaliationCount = rounds.filter(round => 
                round.opponentChoice === 'betray' && round.yourChoice === 'betray'
            ).length;
            
            // 计算信任行为（对方背叛，你仍合作）
            const trustingCount = rounds.filter(round => 
                round.opponentChoice === 'betray' && round.yourChoice === 'cooperate'
            ).length;
            
            // 计算背叛行为（对方合作，你却背叛）
            const betrayalCount = rounds.filter(round => 
                round.opponentChoice === 'cooperate' && round.yourChoice === 'betray'
            ).length;
            
            // 策略分类
            let strategyType = '';
            let strategyDescription = '';
            
            if (cooperationRate >= 80) {
                // 高合作性
                if (betrayalCount === 0) {
                    strategyType = '利他型';
                    strategyDescription = '你始终选择合作，即使面对对手的背叛。这种策略显示了高度的信任和利他精神。';
                } else {
                    strategyType = '互利型';
                    strategyDescription = '你总体倾向合作，但也会在适当时候做出理性决策。这种平衡策略往往在长期博弈中表现最佳。';
                }
            } else if (cooperationRate >= 50) {
                // 中等合作性
                strategyType = '灵活型';
                strategyDescription = '你根据情况灵活调整策略，既有合作也有竞争。这种适应性策略在复杂环境中较为有效。';
            } else if (cooperationRate > 0) {
                // 低合作性
                if (trustingCount === 0) {
                    strategyType = '竞争型';
                    strategyDescription = '你更倾向于竞争，优先考虑自身利益。这种策略在单次博弈中可能获利，但不利于建立长期合作关系。';
                } else {
                    strategyType = '警惕型';
                    strategyDescription = '你以竞争为主，但仍保留合作的可能性。这种策略体现了谨慎的态度，避免被过度利用。';
                }
            } else {
                // 完全竞争
                strategyType = '极度竞争型';
                strategyDescription = '你始终选择背叛，完全以自我利益为中心。这种策略在现实社会中可能导致孤立和信任危机。';
            }
            
            // 计算策略位置（用于象限图）
            let cooperationFactor = cooperationRate / 100; // 0-1
            // 收益导向：背叛对方合作的次数越多，收益导向越高
            let rewardOrientationFactor = rounds.length > 0 ? betrayalCount / rounds.length : 0;
            
            return {
                cooperateCount,
                cooperationRate,
                avgScore,
                reciprocalCooperationCount,
                retaliationCount,
                trustingCount,
                betrayalCount,
                strategyType,
                strategyDescription,
                cooperationFactor,
                rewardOrientationFactor,
                // 每轮得分数据（用于图表）
                roundScores: rounds.map(round => round.yourScore),
                opponentRoundScores: rounds.map(round => round.opponentScore)
            };
        }

        // 更新分析信息
        function updateAnalysis(stats) {
            elements.strategyType.textContent = stats.strategyType;
            elements.cooperationRate.textContent = `${stats.cooperationRate}% (${stats.cooperateCount}/${config.totalRounds}轮)`;
            elements.avgScore.textContent = `${stats.avgScore} 分/轮`;
            elements.strategyDescription.textContent = stats.strategyDescription;
            
            // 生成结果解读
            generateResultInterpretation(stats);
        }

        // 生成结果解读
        function generateResultInterpretation(stats) {
            let interpretation = '';
            
            // 基于合作率的解读
            if (stats.cooperationRate >= 80) {
                interpretation += '你展现出高度的合作倾向，';
                interpretation += stats.strategyType === '利他型' 
                    ? '始终选择信任他人并寻求合作，即使可能被利用。' 
                    : '但也会在适当的时候考虑自身利益，寻求双赢局面。';
                interpretation += ' 在重复博弈中，这种策略往往能够建立良好的合作关系，获得长期稳定的收益。';
            } else if (stats.cooperationRate >= 50) {
                interpretation += '你的决策表现出平衡的特点，';
                interpretation += '能够根据情况灵活调整合作与竞争的策略。';
                interpretation += ' 这种适应性强的决策方式在多变的环境中具有优势，既不会过度信任他人而被利用，也不会因过度竞争而失去合作机会。';
            } else if (stats.cooperationRate > 0) {
                interpretation += '你更倾向于竞争策略，';
                interpretation += stats.strategyType === '竞争型' 
                    ? '优先考虑自身利益的最大化，较少主动寻求合作。' 
                    : '但仍会在某些情况下选择合作，保持一定的灵活性。';
                interpretation += ' 这种策略在单次博弈中可能带来短期收益，但长期来看可能导致合作机会减少。';
            } else {
                interpretation += '你选择了极度竞争的策略，';
                interpretation += '在所有情况下都优先考虑自身利益。';
                interpretation += ' 虽然这种策略在特定情境下可能获得最高收益，但在需要长期合作的环境中往往难以维持。';
            }
            
            // 基于平均得分的解读
            if (stats.avgScore >= 3) {
                interpretation += ' 你的平均得分较高，说明你的策略在当前环境中表现良好。';
            } else if (stats.avgScore >= 2) {
                interpretation += ' 你的平均得分处于中等水平，还有优化空间。';
            } else {
                interpretation += ' 你的平均得分相对较低，可能需要调整策略以获得更好的结果。';
            }
            
            // 心理学解释
            interpretation += ' 从心理学角度看，合作与竞争倾向反映了一个人的社会价值取向和信任水平。';
            interpretation += ' 研究表明，在重复博弈中，"以牙还牙"策略（第一轮合作，之后模仿对方上一轮的行为）往往能够获得最好的长期收益。';
            interpretation += ' 这种策略体现了善良、可激怒、宽容和清晰的特点，是合作与竞争的最佳平衡点。';
            
            elements.resultInterpretation.textContent = interpretation;
        }

        // 绘制图表
        function drawCharts(stats) {
            // 绘制决策分布图
            drawDecisionDistributionChart(stats);
            // 绘制得分趋势图
            drawScoreTrendChart(stats);
        }

        // 绘制决策分布图
        function drawDecisionDistributionChart(stats) {
            const ctx = document.getElementById('decision-distribution-chart').getContext('2d');
            
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['合作', '背叛'],
                    datasets: [{
                        data: [stats.cooperateCount, config.totalRounds - stats.cooperateCount],
                        backgroundColor: [
                            'rgba(0, 180, 42, 0.7)',
                            'rgba(245, 63, 63, 0.7)'
                        ],
                        borderColor: [
                            'rgba(0, 180, 42, 1)',
                            'rgba(245, 63, 63, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const percentage = Math.round((value / config.totalRounds) * 100);
                                    return `${label}: ${value}次 (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 绘制得分趋势图
        function drawScoreTrendChart(stats) {
            const ctx = document.getElementById('score-trend-chart').getContext('2d');
            
            const labels = [];
            for (let i = 1; i <= config.totalRounds; i++) {
                labels.push(`轮次${i}`);
            }
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '你的得分',
                            data: stats.roundScores,
                            backgroundColor: 'rgba(22, 93, 255, 0.2)',
                            borderColor: 'rgba(22, 93, 255, 1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: '对手得分',
                            data: stats.opponentRoundScores,
                            backgroundColor: 'rgba(134, 144, 156, 0.2)',
                            borderColor: 'rgba(134, 144, 156, 1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '得分'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }

        // 设置策略位置
        function setStrategyPosition(stats) {
            // 计算x和y坐标（合作性越高，y值越小；收益导向越高，x值越大）
            const margin = 40; // 边距
            const width = elements.strategyPosition.parentElement.offsetWidth - (margin * 2);
            const height = elements.strategyPosition.parentElement.offsetHeight - (margin * 2);
            
            // 计算位置
            // x坐标：收益导向（0-1），从左到右
            // y坐标：合作性（0-1），从上到下（注意反转）
            const x = margin + (stats.rewardOrientationFactor * width);
            const y = margin + ((1 - stats.cooperationFactor) * height);
            
            // 设置位置
            elements.strategyPosition.style.left = `${x}px`;
            elements.strategyPosition.style.top = `${y}px`;
        }

        // 保存到localStorage（降级方案）
        function saveToLocalStorage(results) {
            try {
                // 获取现有记录
                let experimentRecords = JSON.parse(localStorage.getItem('experimentRecords') || '[]');
                
                // 添加新记录
                experimentRecords.push({
                    type: 'prisoners-dilemma',
                    results: results,
                    timestamp: new Date().toISOString()
                });
                
                // 只保留最近20条记录
                if (experimentRecords.length > 20) {
                    experimentRecords = experimentRecords.slice(-20);
                }
                
                // 保存回localStorage
                localStorage.setItem('experimentRecords', JSON.stringify(experimentRecords));
            } catch (error) {
                console.error('保存实验结果到localStorage失败:', error);
            }
        }

        // 保存游戏结果到服务器
        async function saveGameResult() {
            // 检查用户是否登录
            if (window.API && window.API.isAuthenticated) {
                if (!window.API.isAuthenticated()) {
                    // 显示登录提示
                    if (confirm('登录后可保存实验记录，是否立即登录？')) {
                        window.location.href = 'login.html';
                    }
                    return;
                }
            } else {
                // 降级检查
                const token = localStorage.getItem('token');
                if (!token) {
                    if (confirm('登录后可保存实验记录，是否立即登录？')) {
                        window.location.href = 'login.html';
                    }
                    return;
                }
            }
            
            // 获取最新的结果（从localStorage）
            try {
                let experimentRecords = JSON.parse(localStorage.getItem('experimentRecords') || '[]');
                const latestResult = experimentRecords
                    .filter(record => record.type === 'prisoners-dilemma')
                    .pop();
                
                if (latestResult && window.API && window.API.saveExperimentResult) {
                    // 调用API保存结果
                    await window.API.saveExperimentResult('prisoners-dilemma', latestResult.results);
                    
                    // 显示成功提示
                    alert('游戏结果保存成功！');
                    
                    // 禁用保存按钮
                    elements.saveResult.disabled = true;
                    elements.saveResult.classList.add('opacity-50');
                    elements.saveResult.textContent = '已保存';
                } else {
                    alert('保存失败，请稍后重试');
                }
            } catch (error) {
                console.error('保存游戏结果失败:', error);
                alert('保存失败，请稍后重试');
            }
        }

        // 重新开始游戏
        function restartExperiment() {
            // 重置游戏数据
            resetGameData();
            
            // 隐藏结果阶段，显示实验阶段
            elements.result.classList.add('hidden');
            elements.experiment.classList.remove('hidden');
            
            // 初始化历史记录
            initHistoryList();
            
            // 重新启用保存按钮
            elements.saveResult.disabled = false;
            elements.saveResult.classList.remove('opacity-50');
            elements.saveResult.textContent = '保存结果';
            
            // 开始新一轮游戏
            startNewRound();
        }

        // 初始化
        function init() {
            bindEvents();
            
            // 加载导航栏和页脚
            if (typeof loadNavbar === 'function') {
                loadNavbar();
            }
            if (typeof loadFooter === 'function') {
                loadFooter();
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
<script src="update_experiment_navigation.js"></script>
        <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 立即强制同步登录状态
            if (window.forceExperimentLoginSync) {
                window.forceExperimentLoginSync();
            }
        });
        
        // 增强的登录检查函数
        function enhancedCheckLogin() {
            // 优先使用AuthManager
            if (window.AuthManager) {
                return window.AuthManager.isLoggedIn();
            } else {
                // 兼容旧的token检查和新的AuthManager格式
                const authToken = localStorage.getItem('auth_token');
                const oldToken = localStorage.getItem('token');
                const isLogin = localStorage.getItem('isLogin') === 'true';
                return authToken || oldToken || isLogin;
            }
        }
        
        // 监听全局登录事件，确保实验页面及时响应
        window.addEventListener('userLoggedIn', () => {
            console.log('实验页面检测到用户登录');
            // 可以在这里更新UI，比如启用保存按钮
            const saveButton = document.querySelector('#save-result');
            if (saveButton) {
                saveButton.disabled = false;
                saveButton.classList.remove('opacity-50');
            }
        });
    </script>
    </body>
</html>