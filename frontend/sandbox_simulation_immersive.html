<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>心社区 - 心理健康支持平台</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 基础 Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#8b5cf6',
                        accent: '#ec4899',
                        success: '#10b981',
                        warning: '#f59e0b',
                        error: '#ef4444',
                        info: '#3b82f6',
                        dark: '#1e293b',
                        light: '#f8fafc'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'float-slow': 'float 8s ease-in-out infinite',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-in': 'slideIn 0.3s ease-out forwards',
                        'pulse-soft': 'pulseSoft 2s ease-in-out infinite',
                        'breath': 'breath 4s ease-in-out infinite'
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-20px)' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideIn: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        pulseSoft: {
                            '0%, 100%': { opacity: '0.8' },
                            '50%': { opacity: '1' }
                        },
                        breath: {
                            '0%, 100%': { transform: 'scale(1)', opacity: '0.8' },
                            '50%': { transform: 'scale(1.05)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>
    <!-- 全局样式文件 -->
    <link rel="stylesheet" href="common.css">
    
    <!-- 导航栏交互脚本 -->
    <script src="components/navbar.js" defer></script>
    <!-- 修复重复用户菜单脚本 -->
    <script src="components/fix_duplicate_user_menu.js" defer></script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .glass-effect {
                background: rgba(255, 255, 255, 0.7);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }
            .glass-effect-dark {
                background: rgba(30, 41, 59, 0.8);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }
            .sand-texture {
                background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23d1d5db' fill-opacity='0.3' fill-rule='evenodd'/%3E%3C/svg%3E");
            }
            .water-texture {
                background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%2393c5fd' fill-opacity='0.4' fill-rule='evenodd'/%3E%3C/svg%3E");
            }
            .sandFlow {
                background-size: 200% 200%;
                animation: sandFlow 20s linear infinite;
            }
            @keyframes sandFlow {
                0% { background-position: 0% 0%; }
                100% { background-position: 100% 100%; }
            }
        }
    </style>
    <!-- 沉浸式沙盘CSS -->
    <link rel="stylesheet" href="immersive_sandbox.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 自定义配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        accent: '#722ED1',
                        success: '#52C41A',
                        warning: '#FAAD14',
                        danger: '#F5222D',
                        info: '#1890FF'
                    },
                    fontFamily: {
                        sans: ['PingFang SC', 'Microsoft YaHei', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .glass-effect {
                background: rgba(255, 255, 255, 0.85);
                backdrop-filter: blur(8px);
            }
            .nav-scrolled {
                background: rgba(255, 255, 255, 0.95);
            }
            .transition-all-300 {
                transition: all 0.3s ease;
            }
            .treehole-input-focus {
                box-shadow: 0 0 0 3px rgba(22, 93, 255, 0.1);
            }
            .breathing {
                animation: breathing 2s infinite ease-in-out;
            }
            @keyframes breathing {
                0%, 100% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.01);
                }
            }
            .fade-in {
                animation: fadeIn 0.6s ease-in;
            }
            @keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }
            .grow-leaf {
                animation: growLeaf 0.8s ease-out;
                transform-origin: bottom center;
            }
            @keyframes growLeaf {
                0% {
                    transform: scale(0);
                    opacity: 0;
                }
                100% {
                    transform: scale(1);
                    opacity: 1;
                }
            }
            .tree-grow {
                animation: treeGrow 1.2s ease-out;
            }
            @keyframes treeGrow {
                0% {
                    transform: scaleY(0);
                    transform-origin: bottom center;
                }
                100% {
                    transform: scaleY(1);
                }
            }
            .emotion-tag-animate {
                transition: all 0.3s ease;
            }
        }
    </style>
    <link rel="stylesheet" href="common.css">
    <!-- 修复重复用户菜单脚本 -->
    <script src="fix_duplicate_user_menu.js"></script>
    <!-- 导航栏交互脚本 -->
    <script src="navbar.js"></script>
    <script>
        // 设置当前页面标识，用于导航栏高亮
        window.current_page = 'sandbox_simulation_immersive';
    </script>
    <style>
        /* 全局样式重置和基础设置 */
        body {
            margin: 0;
            padding: 0;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            overflow-x: hidden;
        }
        
        /* 导航栏样式已经在Tailwind配置中定义 */
        /* 以下保留一些特定样式的兼容性定义 */
        .mobile-menu-toggle {
            background: none;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            color: #4a5568;
            display: none;
        }
        
        #mobile-menu {
            position: fixed;
            top: 0;
            right: 0;
            width: 80%;
            max-width: 320px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 25px rgba(0, 0, 0, 0.1);
            z-index: 1100;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
        }
        
        #mobile-menu:not(.hidden) {
            transform: translateX(0);
        }
        
        .mobile-menu-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .mobile-menu-content {
            padding: 1rem;
        }
        
        .mobile-menu-group {
            margin-bottom: 1.5rem;
        }
        
        .mobile-menu-divider {
            height: 1px;
            background-color: #e2e8f0;
            margin: 1rem 0;
        }
        
        /* 响应式设计 */
        @media (max-width: 1024px) {
            .desktop-nav {
                display: none;
            }
            
            .mobile-menu-toggle {
                display: block;
            }
        }
        
        @media (min-width: 1025px) {
            #mobile-menu {
                display: none !important;
            }
        }
        
        /* 平滑滚动 */
        html {
            scroll-behavior: smooth;
        }
        
        /* 修复移动端滚动问题 */
        body.menu-open {
            overflow: hidden;
        }
        
        /* 动画效果 */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes bounceIn {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }
            70% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }
        
        @keyframes float {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }
        
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        .animate-slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        .animate-bounce-in {
            animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .animate-pulse {
            animation: pulse 2s infinite;
        }
        
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
        
        .shimmer {
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0) 100%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite linear;
        }

        /* 主要容器 */
        .sandbox-container {
            position: relative;
            min-height: 100vh;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }

        /* 沙箱区域 - 中央占屏80%，无边界感设计 */
        .sandbox-area {
            position: relative;
            width: 100%;
            max-width: 1200px;
            height: 80vh;
            max-height: 800px;
            border-radius: 16px;
            overflow: hidden;
            background: #f0f9ff;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            /* 流动细沙背景 */
            background-image: 
                radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.5) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.4) 0%, transparent 50%),
                repeating-linear-gradient(45deg, rgba(224, 242, 254, 0.9), rgba(224, 242, 254, 0.9) 10px, rgba(203, 232, 255, 0.9) 10px, rgba(203, 232, 255, 0.9) 20px);
            animation: sandFlow 30s ease-in-out infinite alternate;
        }

        /* 沙粒流动动画 */
        @keyframes sandFlow {
            0% {
                background-position: 0% 0%, 100% 100%, 0% 0%;
            }
            100% {
                background-position: 100% 100%, 0% 0%, 100% 100%;
            }
        }

        /* 水域层 - 占沙箱面积1/3，渐变色设计 */
        .water-layer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 33%;
            background: linear-gradient(to top, rgba(79, 70, 229, 0.6), rgba(139, 92, 246, 0.4));
            border-top: 2px solid rgba(139, 92, 246, 0.5);
            animation: waterRipple 15s ease-in-out infinite alternate;
        }

        /* 水面涟漪动画 */
        @keyframes waterRipple {
            0% {
                background-position: 0% 0%;
                transform: scaleX(1);
            }
            50% {
                background-position: 50% 50%;
                transform: scaleX(1.02);
            }
            100% {
                background-position: 100% 100%;
                transform: scaleX(1);
            }
        }

        /* 沙具容器 */
        .sandbox-items {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
        }

        /* 沙具通用样式 */
        .sandbox-item {
            position: absolute;
            cursor: grab;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center;
            z-index: 20;
            touch-action: none; /* 禁用触摸设备上的默认行为 */
            user-select: none;
            filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.1));
        }

        .sandbox-item:hover {
            filter: brightness(1.1) drop-shadow(0 4px 12px rgba(139, 92, 246, 0.3));
            transform: scale(1.05) translateY(-3px);
        }
        
        .sandbox-item.dragging {
            cursor: grabbing;
            z-index: 100;
            transform: scale(1.1);
            filter: drop-shadow(0 8px 16px rgba(139, 92, 246, 0.4));
            transition: all 0.1s ease;
        }
        
        .sandbox-item:active {
            transform: scale(0.98);
        }

        /* 环形菜单 - 半透明黑色背景，8个扇形分区 */
        .radial-menu {
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
            transform: scale(0);
            opacity: 0;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .radial-menu.visible {
            transform: scale(1);
            opacity: 1;
        }

        .radial-menu.hidden {
            transform: scale(0);
            opacity: 0;
        }

        /* 环形菜单项 */
        .menu-item {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        /* 变体选择器 */
        .variant-selector {
            position: absolute;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 10px;
            display: flex;
            gap: 10px;
            z-index: 110;
            transform: scale(0);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .variant-selector.visible {
            transform: scale(1);
            opacity: 1;
        }

        .variant-option {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .variant-option:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        /* 沙具功能盘 */
        .item-controls {
            position: absolute;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            z-index: 120;
            transform: scale(0);
            opacity: 0;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
        }

        .item-controls.visible {
            transform: scale(1);
            opacity: 1;
        }

        .control-btn {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(139, 92, 246, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
        }

        .control-btn:hover {
            background: rgba(79, 70, 229, 0.9);
            transform: scale(1.1);
            box-shadow: 0 3px 12px rgba(139, 92, 246, 0.4);
        }

        /* 全局工具栏 */
        .global-tools {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 50;
        }

        .tool-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            color: #4f46e5;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .tool-btn:hover {
            background: white;
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.2);
        }

        /* 音量控制 */
        .volume-control {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 5px 0;
        }

        .volume-control input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 80px;
            height: 4px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }

        .volume-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
        }

        .volume-control input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
        }

        .volume-control input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        /* 静音状态样式 */
        .tool-btn.muted i {
            color: #ff4d4f;
        }

        /* 背景音乐关闭状态 */
        .tool-btn.music-off i {
            opacity: 0.5;
        }

        /* 漂浮提示卡 */
        .floating-tip {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 24px 32px;
            border-radius: 18px;
            text-align: center;
            max-width: 400px;
            z-index: 200;
            backdrop-filter: blur(10px);
            animation: float 3s ease-in-out infinite;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .floating-tip p {
            margin: 0 0 15px 0;
            color: #374151;
            font-size: 16px;
            line-height: 1.6;
        }

        .floating-tip button {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .floating-tip button:hover {
            background: linear-gradient(135deg, #4338ca, #6d28d9);
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(79, 70, 229, 0.4);
        }

        /* 漂浮动画 */
        @keyframes float {
            0%, 100% {
                transform: translate(-50%, -50%) translateY(0);
            }
            50% {
                transform: translate(-50%, -50%) translateY(-10px);
            }
        }

        /* AI解读面板 */
        .analysis-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 380px;
            height: 100vh;
            background: white;
            box-shadow: -8px 0 30px rgba(0, 0, 0, 0.1);
            z-index: 300;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .analysis-panel.visible {
            transform: translateX(0);
        }

        .panel-header {
            padding: 20px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e7ff;
        }

        .panel-header h3 {
            margin: 0;
            color: #4f46e5;
            font-weight: 600;
        }

        .panel-header button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7c3aed;
            transition: all 0.2s ease;
        }
        
        .panel-header button:hover {
            color: #4f46e5;
            transform: scale(1.1);
        }

        .panel-content {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            color: #374151;
            line-height: 1.6;
        }
        
        /* 分析内容样式 */
        .analysis-header {
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 2px solid #7c3aed;
            padding-bottom: 10px;
        }
        
        .analysis-header h3 {
            color: #4f46e5;
            margin: 0;
            font-size: 1.3em;
            font-weight: 600;
        }
        
        .analysis-section {
            margin: 20px 0;
            padding: 15px;
            background-color: rgba(240, 249, 255, 0.8);
            border-radius: 12px;
            border-left: 4px solid #7c3aed;
            animation: fadeIn 0.5s ease-in-out;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .analysis-section h4 {
            color: #7c3aed;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1em;
            font-weight: 600;
        }
        
        .analysis-section p {
            margin: 8px 0;
            line-height: 1.6;
            color: #555;
        }
        
        .analysis-section ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .analysis-section li {
            margin: 8px 0;
            line-height: 1.5;
            color: #555;
            position: relative;
        }
        
        .analysis-section li::before {
            content: "•";
            color: #4A90E2;
            font-weight: bold;
            display: inline-block;
            width: 1em;
            margin-left: -1em;
        }
        
        /* 情绪分析相关样式 */
        .emotion-analysis {
            background-color: rgba(240, 249, 255, 0.8);
            border-left: 3px solid #7c3aed;
            padding-left: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .emotion-details {
            margin: 10px 0;
            padding: 10px;
            background-color: rgba(139, 92, 246, 0.08);
            border-radius: 10px;
            border-left: 2px solid #a78bfa;
        }
        
        .emotion-details ul,
        .emotion-feedback ul,
        .regulation-suggestions ul {
            margin-top: 5px;
            padding-left: 20px;
        }
        
        .emotion-feedback {
            margin: 15px 0;
            padding: 10px;
            background-color: rgba(139, 92, 246, 0.05);
            border-radius: 10px;
            border-left: 2px solid #8b5cf6;
        }
        
        .regulation-suggestions {
            margin: 15px 0;
            padding: 10px;
            background-color: rgba(79, 70, 229, 0.05);
            border-radius: 10px;
            border-left: 2px solid #6d28d9;
        }
        
        .regulation-suggestions li {
            margin-bottom: 8px;
        }
        
        .analysis-footer {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid #e0e7ff;
            text-align: center;
            font-style: italic;
            color: #6b7280;
        }
        
        /* 淡入动画 */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 响应式设计 - 增强版 */
        @media (max-width: 768px) {
            /* 沙箱区域适配 */
            .sandbox-area {
                height: 70vh;
                width: 100%;
                margin: 0;
                border-radius: 0;
            }
            
            /* 情绪分析样式移动端适配 */
            .emotion-analysis {
                padding-left: 10px;
                border-left-width: 2px;
            }
            
            .emotion-details {
                margin: 8px 0;
                padding: 8px;
                font-size: 13px;
            }
            
            .emotion-feedback {
                margin: 10px 0;
                padding: 8px;
                font-size: 13px;
            }
            
            .regulation-suggestions {
                padding: 8px;
                font-size: 13px;
            }
            
            .emotion-details ul,
            .emotion-feedback ul,
            .regulation-suggestions ul {
                padding-left: 15px;
                margin-top: 3px;
            }
            
            .emotion-details li,
            .emotion-feedback li,
            .regulation-suggestions li {
                font-size: 12px;
                line-height: 1.4;
            }
            
            /* 工具栏适配 */
            .sandbox-controls {
                padding: 15px;
                flex-wrap: wrap;
                gap: 10px;
                background: rgba(255, 255, 255, 0.95);
                border-radius: 12px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            }
            
            .sandbox-controls button {
                padding: 10px 15px;
                font-size: 14px;
                min-width: 80px;
                background: linear-gradient(135deg, #4f46e5, #7c3aed);
                color: white;
                border: none;
                border-radius: 20px;
                transition: all 0.2s ease;
                box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);
            }
            
            .sandbox-controls button:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
            }
            
            /* 环形菜单适配 */
            .radial-menu {
                width: 180px;
                height: 180px;
                position: fixed;
                left: 50% !important;
                top: 50% !important;
                transform: translate(-50%, -50%) !important;
                z-index: 200;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            }
            
            .radial-menu .menu-item {
                width: 45px;
                height: 45px;
                font-size: 11px;
                display: flex;
                align-items: center;
                justify-content: center;
                text-align: center;
                background: rgba(139, 92, 246, 0.8);
                color: white;
                border-radius: 50%;
                transition: all 0.2s ease;
                box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
            }
            
            .radial-menu .menu-item:hover {
                background: rgba(79, 70, 229, 0.9);
                transform: scale(1.1);
                box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
            }
            
            /* 分析面板适配 */
            .analysis-panel {
                width: 100%;
                height: 100vh;
            }
            
            .panel-header {
                padding: 15px;
            }
            
            .panel-header h3 {
                font-size: 18px;
            }
            
            .panel-content {
                padding: 15px;
                font-size: 14px;
            }
            
            /* 变体选择器适配 */
            .variant-selector {
                width: 90% !important;
                left: 5% !important;
                top: auto !important;
                bottom: 20px;
                max-height: 50vh;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-radius: 16px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
                border: none;
            }
            
            .variant-item {
                width: 80px;
                height: 80px;
                margin: 8px;
                border-radius: 12px;
                transition: all 0.2s ease;
                background: rgba(240, 249, 255, 0.8);
                border: 2px solid transparent;
            }
            
            .variant-item:hover {
                transform: scale(1.05);
                border-color: #7c3aed;
            }
            
            .variant-item .variant-name {
                font-size: 12px;
                padding: 4px 8px;
                background: rgba(139, 92, 246, 0.8);
                color: white;
                border-radius: 15px;
                margin-top: 5px;
            }
            
            /* 沙具控制适配 */
            .item-controls {
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                justify-content: space-around;
                padding: 12px;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-radius: 16px;
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            }
            
            .item-controls button {
                font-size: 14px;
                padding: 8px 12px;
                min-width: 70px;
                background: rgba(139, 92, 246, 0.8);
                color: white;
                border: none;
                border-radius: 18px;
                transition: all 0.2s ease;
                box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
            }
            
            .item-controls button:hover {
                background: rgba(79, 70, 229, 0.9);
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
            }
            
            /* 欢迎引导适配 */
            #welcome-guide {
                width: 90%;
                padding: 15px;
            }
            
            #welcome-guide h2 {
                font-size: 20px;
            }
            
            #welcome-guide p, #welcome-guide li {
                font-size: 14px;
                line-height: 1.5;
            }
            
            /* 沙具元素适配 */
            .sandbox-item {
                max-width: 60px;
                max-height: 60px;
            }
        }
        
        /* 平板设备适配 */
        @media (min-width: 769px) and (max-width: 1024px) {
            .sandbox-area {
                height: 75vh;
            }
            
            .radial-menu {
                width: 200px;
                height: 200px;
            }
            
            .analysis-panel {
                width: 400px;
            }
        }
        
        /* 触控设备优化 */
        @media (hover: none) and (pointer: coarse) {
            /* 沙具触摸优化 */
            .sandbox-item {
                touch-action: none;
                transform-origin: center;
                transition: transform 0.1s ease;
            }
            
            .sandbox-item:active {
                transform: scale(0.95);
            }
            
            /* 环形菜单触摸优化 */
            .radial-menu .menu-item {
                transition: all 0.2s ease;
                min-width: 55px;
                min-height: 55px;
                padding: 8px;
            }
            
            /* 所有按钮触摸优化 */
            button, .menu-item {
                touch-action: manipulation;
                user-select: none;
            }
            
            /* 分析面板滚动优化 */
            .panel-content {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
            }
            
            /* 沙箱区域手势优化 */
            .sandbox-area {
                touch-action: none;
            }
            }
            
            .radial-menu .menu-item:active {
                transform: scale(1.1);
            }
            
            .variant-item:active {
                transform: scale(1.05);
            }
        }

        /* 沙具放置动画 */
        @keyframes itemPlace {
            0% {
                transform: scale(1.2) translateY(-10px);
                opacity: 0;
            }
            50% {
                transform: scale(1.1) translateY(5px);
                opacity: 1;
            }
            100% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .item-place-animation {
            animation: itemPlace 0.3s ease-out forwards;
        }

        /* 沙具移除动画 */
        @keyframes itemRemove {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.5;
            }
            100% {
                transform: scale(0);
                opacity: 0;
            }
        }

        .item-remove-animation {
            animation: itemRemove 0.5s ease-out forwards;
        }
        
        /* 五感模拟动画效果 */
        
        /* 沙粒涟漪效果 */
        .sand-ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(210, 180, 140, 0.3);
            transform: scale(0);
            pointer-events: none;
            z-index: 10;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0);
                opacity: 0.8;
            }
            100% {
                transform: scale(1);
                opacity: 0;
            }
        }
        
        /* 种子成长动画 */
        .growth-animation {
            animation: growth 2s ease-out forwards;
        }
        
        @keyframes growth {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 1;
            }
            100% {
                transform: scale(1.2);
                opacity: 1;
            }
        }
        
        /* 火焰跳动动画 */
        .flame-animation {
            animation: flame 1s ease-in-out infinite;
        }
        
        @keyframes flame {
            0%, 100% {
                transform: scale(1) rotate(2deg);
            }
            50% {
                transform: scale(1.05) rotate(-2deg);
            }
        }
        
        /* 水域波纹效果 */
        .water-ripple {
            position: absolute;
            border: 1px solid rgba(100, 149, 237, 0.5);
            border-radius: 50%;
            background: rgba(173, 216, 230, 0.2);
            transform: scale(0);
            pointer-events: none;
            z-index: 10;
        }
        
        @keyframes waterRipple {
            0% {
                transform: scale(0);
                opacity: 0.8;
            }
            100% {
                transform: scale(1);
                opacity: 0;
            }
        }
        
        /* 连接线条动画 */
        .connection-line {
            position: absolute;
            background: linear-gradient(90deg, rgba(128, 0, 128, 0.8) 0%, rgba(128, 0, 128, 0.2) 100%);
            height: 2px;
            pointer-events: none;
            z-index: 50;
            opacity: 0;
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        /* 情绪符号变化动画 */
        .emotion-fade {
            animation: emotionFade 3s ease-in-out;
        }
        
        @keyframes emotionFade {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }
        
        /* 沙面微光效果 */
        .sand-glow {
            animation: sandGlow 4s ease-in-out infinite;
        }
        
        @keyframes sandGlow {
            0%, 100% {
                box-shadow: 0 0 5px rgba(255, 215, 0, 0.3);
            }
            50% {
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
            }
        }
        
        /* 连接线动画 - 脉冲效果 */
        @keyframes pulse-connection {
            0%, 100% { opacity: 0.3; transform: scaleX(1); }
            50% { opacity: 0.8; transform: scaleX(1.02); }
        }
        
        /* 连接线动画 - 流动效果 */
        @keyframes flow-connection {
            0% { background-position: -100% 0, 0 0; }
            100% { background-position: 200% 0, 0 0; }
        }
        
        /* 符号状态样式 */
        .sandbox-item.highlighted {
            z-index: 50;
            animation: highlightPulse 2s infinite ease-in-out;
        }
        
        .sandbox-item.influenced {
            transition: all 0.3s ease;
        }
        
        .sandbox-item.connected {
            border: 2px solid #4CAF50;
            border-radius: 50%;
        }
        
        .sandbox-item.repelled {
            animation: repelPulse 1s infinite ease-in-out;
        }
        
        .sandbox-item.balanced {
            animation: balanceGlow 3s infinite ease-in-out;
        }
        
        /* 环境状态样式 */
        .sandbox.growth-environment {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.05), rgba(139, 195, 74, 0.05));
            box-shadow: inset 0 0 100px rgba(76, 175, 80, 0.1);
        }
        
        .sandbox.connection-rich {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.05), rgba(2, 136, 209, 0.05));
        }
        
        .sandbox.balanced-environment {
            background: linear-gradient(135deg, rgba(156, 39, 176, 0.05), rgba(103, 58, 183, 0.05));
        }
        
        .sandbox.isolated-environment {
            background: linear-gradient(135deg, rgba(158, 158, 158, 0.05), rgba(117, 117, 117, 0.05));
        }
        
        /* 辅助动画 */
        @keyframes highlightPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes repelPulse {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(var(--repel-x, 0px), var(--repel-y, 0px)); }
        }
        
        @keyframes balanceGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(156, 39, 176, 0.3); }
            50% { box-shadow: 0 0 20px rgba(156, 39, 176, 0.6);
            }
            }
        }
    </style>
<style>

    /* 全局样式重置 */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    /* 全局颜色变量 */
    :root {
        --primary-color: #6366f1;
        --secondary-color: #8b5cf6;
        --text-primary: #1e293b;
        --text-secondary: #475569;
        --bg-primary: #ffffff;
        --bg-secondary: #f8fafc;
        --border-color: #e2e8f0;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        line-height: 1.6;
        color: var(--text-primary);
        background-color: var(--bg-primary);
    }
    
    /* 统一按钮样式 */
    button {
        font-family: inherit;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        outline: none;
    }
    
    /* 主按钮样式 - 注册按钮 */
    .btn-primary {
        background-color: var(--secondary-color);
        color: white;
        border-radius: 8px;
        padding: 8px 16px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }
    
    .btn-primary:hover {
        background-color: #7c3aed;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(139, 92, 246, 0.2);
    }
    
    /* 次要按钮样式 - 登录按钮 */
    .btn-secondary {
        background-color: transparent;
        color: var(--primary-color);
        border: 1px solid var(--primary-color);
        border-radius: 8px;
        padding: 8px 16px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }
    
    .btn-secondary:hover {
        background-color: rgba(99, 102, 241, 0.05);
        transform: translateY(-1px);
    }
    
    /* 导航栏样式 */
    nav {
        background-color: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--border-color);
    }
    
    /* 响应式设计 */
    @media (max-width: 768px) {
        .btn-primary,
        .btn-secondary {
            padding: 6px 12px;
            font-size: 0.875rem;
        }
    }
    
    /* 卡片样式 */
    .card {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        padding: 1.5rem;
    }
    
    /* 输入框样式 */
    input,
    textarea,
    select {
        font-family: inherit;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 8px 12px;
        transition: border-color 0.3s ease;
    }
    
    input:focus,
    textarea:focus,
    select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

</style>
</head>
<body>
<!-- 统一导航栏组件 -->
<nav id="main-nav" class="fixed top-0 left-0 right-0 z-50 glass-effect transition-all duration-300 py-3">
    <div class="container mx-auto px-4 flex justify-between items-center">
        <div class="flex items-center space-x-2">
            <!-- Logo -->
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary to-indigo-600 flex items-center justify-center text-white">
                <i class="fa fa-heart-o text-xl"></i>
            </div>
            <span class="text-xl font-bold text-primary tracking-wide">心社区</span>
        </div>
        
        <!-- 桌面端导航 -->
        <div class="hidden md:flex nav-links items-center space-x-1">
            <a href="index.html" class="text-primary border-b-2 border-primary transition-all duration-300 font-medium py-1 px-3 hover:scale-105 flex items-center">
                <i class="fa fa-home mr-2"></i>首页
            </a>
            <a href="assessment_list.html" class="text-gray-700 hover:text-primary transition-all duration-300 font-medium py-1 px-3 hover:scale-105 relative group flex items-center">
                <i class="fa fa-list-alt mr-2"></i>心理测评
                <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-primary transition-all duration-300 group-hover:w-full"></span>
            </a>
            <a href="consultant_list.html" class="text-gray-700 hover:text-primary transition-all duration-300 font-medium py-1 px-3 hover:scale-105 relative group flex items-center">
                <i class="fa fa-user-md mr-2"></i>咨询服务
                <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-primary transition-all duration-300 group-hover:w-full"></span>
            </a>
            <a href="activity_list.html" class="text-gray-700 hover:text-primary transition-all duration-300 font-medium py-1 px-3 hover:scale-105 relative group flex items-center">
                <i class="fa fa-users mr-2"></i>团体活动
                <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-primary transition-all duration-300 group-hover:w-full"></span>
            </a>
            <a href="relaxation_music.html" class="text-gray-700 hover:text-primary transition-all duration-300 font-medium py-1 px-3 hover:scale-105 relative group flex items-center">
                <i class="fa fa-music mr-2"></i>放松体验
                <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-primary transition-all duration-300 group-hover:w-full"></span>
            </a>
            
            <!-- 更多服务下拉菜单 -->
            <div class="relative" id="desktop-more-menu">
                <button id="desktop-more-menu-button" class="text-gray-700 hover:text-primary transition-all duration-300 font-medium py-1 px-3 hover:scale-105 flex items-center gap-1 relative group">
                    更多服务
                    <i class="fa fa-angle-down transition-transform duration-300 group-hover:rotate-180"></i>
                    <span class="absolute bottom-0 left-0 w-0 h-0.5 bg-primary transition-all duration-300 group-hover:w-full"></span>
                </button>
                <div id="desktop-more-dropdown" class="hidden absolute top-full left-0 mt-2 w-56 glass-effect rounded-lg shadow-xl z-50 py-2 animate-fade-in transform origin-top-right">
                    <a href="healing_treehole.html" class="block px-4 py-3 text-gray-700 hover:bg-white/50 transition-all-300">
                        <i class="fa fa-tree mr-2"></i>治愈树洞
                    </a>
                    <a href="sandbox_simulation_immersive.html" class="block px-4 py-3 text-gray-700 hover:bg-white/50 transition-all-300">
                        <i class="fa fa-cubes mr-2"></i>沙盘模拟
                    </a>
                    <a href="mental_stories.html" class="block px-4 py-3 text-gray-700 hover:bg-white/50 transition-all-300">
                        <i class="fa fa-book mr-2"></i>心理资源
                    </a>
                    <a href="mental_games.html" class="block px-4 py-3 text-gray-700 hover:bg-white/50 transition-all-300">
                        <i class="fa fa-gamepad mr-2"></i>心理游戏
                    </a>
                                    <a href="psychology_experiments.html" class="block px-4 py-3 text-gray-700 hover:bg-white/50 transition-all-300">
                        <i class="fa fa-flask mr-2"></i>心理实验
                    </a>
                    </div>
            </div>
        </div>
        
        <!-- 移动端菜单按钮 -->
        <div class="md:hidden">
            <button id="menu-toggle" class="text-gray-700 focus:outline-none transition-transform duration-300 hover:rotate-90 p-2 rounded-md hover:bg-gray-100">
                <i class="fa fa-bars text-xl"></i>
                <span class="sr-only">打开菜单</span>
            </button>
        </div>
        
        <!-- 用户菜单 -->
        <div id="user-menu" class="hidden md:flex items-center space-x-4">
            <div class="relative">
                <button id="user-menu-button" class="flex items-center space-x-2 focus:outline-none group p-1 rounded-full hover:bg-white/30 transition-all duration-300 focus:ring-2 focus:ring-primary/50">
                    <div class="h-8 w-8 rounded-full bg-gradient-to-br from-primary to-indigo-600 flex items-center justify-center text-white">
                        <i class="fa fa-user"></i>
                    </div>
                    <span id="user-name" class="text-gray-700 group-hover:text-primary transition-colors"></span>
                    <i class="fa fa-angle-down text-gray-500 group-hover:text-primary transition-transform duration-300 group-hover:rotate-180"></i>
                </button>
                <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-56 glass-effect rounded-lg shadow-xl z-50 py-2 animate-fade-in transform origin-top-right">
                    <a href="user_profile.html" class="block px-4 py-3 text-gray-700 hover:bg-white/50 transition-all duration-200 flex items-center">
                        <i class="fa fa-user-circle w-4 mr-3 text-center"></i>
                        <span>个人中心</span>
                    </a>
                    <a href="assessment_history.html" class="block px-4 py-3 text-gray-700 hover:bg-white/50 transition-all duration-200 flex items-center">
                        <i class="fa fa-list-alt w-4 mr-3 text-center"></i>
                        <span>测评记录</span>
                    </a>
                    <a href="booking_history.html" class="block px-4 py-3 text-gray-700 hover:bg-white/50 transition-all duration-200 flex items-center">
                        <i class="fa fa-calendar-check-o w-4 mr-3 text-center"></i>
                        <span>预约记录</span>
                    </a>
                    <a href="activity_registration.html" class="block px-4 py-3 text-gray-700 hover:bg-white/50 transition-all duration-200 flex items-center">
                        <i class="fa fa-calendar-plus-o w-4 mr-3 text-center"></i>
                        <span>活动报名</span>
                    </a>
                    <hr class="my-1 border-gray-200">
                    <a href="#" id="logout-button" class="block px-4 py-2 text-gray-700 hover:bg-gray-50 hover:text-danger transition-all duration-200 flex items-center">
                        <i class="fa fa-sign-out mr-3 w-4 text-center"></i>
                        <span>退出登录</span>
                    </a>
                </div>
            </div>
        </div>
        
        <!-- 登录/注册按钮 -->
        <div id="auth-buttons" class="hidden md:flex items-center space-x-3">
            <button class="px-4 py-2 text-primary border-2 border-primary rounded-lg hover:bg-primary/5 hover:text-primary transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-primary/30 font-medium shadow-sm hover:shadow transform hover:-translate-y-0.5 active:translate-y-0" onclick="window.location.href='login.html'">
                <i class="fa fa-sign-in mr-1"></i>登录
            </button>
            <button class="px-4 py-2 bg-gradient-to-r from-primary to-indigo-600 text-indigo-900 rounded-lg hover:from-indigo-600 hover:to-indigo-700 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-primary/30 font-bold shadow-md hover:shadow-lg transform hover:-translate-y-0.5 active:translate-y-0" onclick="window.location.href='register.html'">
                <i class="fa fa-user-plus mr-2"></i>注册
            </button>
            <a href="admin_login.html" class="text-gray-600 hover:text-gray-800 transition-all duration-300 text-xs hover:underline px-2">管理员入口</a>
        </div>
    </div>
    
    <!-- 移动端导航菜单 -->
    <div id="mobile-menu" class="md:hidden hidden glass-effect shadow-lg absolute w-full">
        <div class="container mx-auto px-4 py-3 flex flex-col space-y-1">
            <a href="index.html" class="bg-primary/5 text-primary py-2 px-3 rounded-lg font-medium flex items-center">
                <i class="fa fa-home w-5 mr-3 text-center"></i>
                首页
            </a>
            <a href="assessment_list.html" class="text-gray-700 hover:text-primary transition-all duration-300 py-2 px-3 rounded-lg font-medium flex items-center hover:bg-gray-50">
                <i class="fa fa-list-alt w-5 mr-3 text-center"></i>
                心理测评
            </a>
            <a href="consultant_list.html" class="text-gray-700 hover:text-primary transition-all duration-300 py-2 px-3 rounded-lg font-medium flex items-center hover:bg-gray-50">
                <i class="fa fa-user-md w-5 mr-3 text-center"></i>
                咨询服务
            </a>
            <a href="activity_list.html" class="text-gray-700 hover:text-primary transition-all duration-300 py-2 px-3 rounded-lg font-medium flex items-center hover:bg-gray-50">
                <i class="fa fa-users w-5 mr-3 text-center"></i>
                团体活动
            </a>
            <a href="relaxation_music.html" class="text-gray-700 hover:text-primary transition-all duration-300 py-2 px-3 rounded-lg font-medium flex items-center hover:bg-gray-50">
                <i class="fa fa-music w-5 mr-3 text-center"></i>
                放松体验
            </a>
            <a href="healing_treehole.html" class="text-gray-700 hover:text-primary transition-all duration-300 py-2 px-3 rounded-lg font-medium flex items-center hover:bg-gray-50">
                <i class="fa fa-tree w-5 mr-3 text-center"></i>
                治愈树洞
            </a>
            <a href="sandbox_simulation_immersive.html" class="text-gray-700 hover:text-primary transition-all duration-300 py-2 px-3 rounded-lg font-medium flex items-center hover:bg-gray-50">
                <i class="fa fa-th-large w-5 mr-3 text-center"></i>
                沙盘模拟
            </a>
            <a href="mental_stories.html" class="text-gray-700 hover:text-primary transition-all duration-300 py-2 px-3 rounded-lg font-medium flex items-center hover:bg-gray-50">
                <i class="fa fa-book w-5 mr-3 text-center"></i>
                心理资源
            </a>
            <a href="mental_games.html" class="text-gray-700 hover:text-primary transition-all duration-300 py-2 px-3 rounded-lg font-medium flex items-center hover:bg-gray-50">
                <i class="fa fa-gamepad w-5 mr-3 text-center"></i>
                心理游戏
            </a>
            
            <!-- 移动端登录/注册按钮 -->
            <div class="flex space-x-3 py-3 mt-2">
                <button class="px-4 py-2.5 text-primary border border-primary rounded-lg hover:bg-primary/5 transition-all duration-300 flex-1 font-medium focus:outline-none focus:ring-2 focus:ring-primary/30" onclick="window.location.href='login.html'">
                    <i class="fa fa-sign-in mr-2"></i>登录
                </button>
                <button class="px-4 py-2.5 bg-gradient-to-r from-primary to-indigo-600 text-white rounded-lg hover:from-indigo-600 hover:to-indigo-700 transition-all duration-300 flex-1 font-medium focus:outline-none focus:ring-2 focus:ring-primary/30" onclick="window.location.href='register.html'">
                    <i class="fa fa-user-plus mr-2"></i>注册
                </button>
            </div>
            
            <!-- 移动端用户菜单（登录后显示） -->
            <div id="mobile-user-menu" class="hidden py-2 animate-fade-in">
                <div class="flex items-center space-x-3 mb-3 pb-3 border-b border-gray-200 bg-white/30 rounded-lg p-2">
                    <div class="h-10 w-10 rounded-full bg-gradient-to-br from-primary to-indigo-600 flex items-center justify-center text-white">
                        <i class="fa fa-user"></i>
                    </div>
                    <span id="mobile-user-name" class="text-gray-700 font-medium"></span>
                </div>
                <a href="user_profile.html" class="block px-4 py-2 text-gray-700 hover:bg-white/50 transition-all duration-300 rounded-lg my-1">
                    <i class="fa fa-user-circle mr-2 w-5 text-center"></i>个人中心
                </a>
                <a href="assessment_history.html" class="block px-4 py-2 text-gray-700 hover:bg-white/50 transition-all duration-300 rounded-lg my-1">
                    <i class="fa fa-list-alt mr-2 w-5 text-center"></i>测评记录
                </a>
                <a href="booking_history.html" class="block px-4 py-2 text-gray-700 hover:bg-white/50 transition-all duration-300 rounded-lg my-1">
                    <i class="fa fa-calendar-check-o mr-2 w-5 text-center"></i>预约记录
                </a>
                <a href="activity_registration.html" class="block px-4 py-2 text-gray-700 hover:bg-white/50 transition-all duration-300 rounded-lg my-1">
                    <i class="fa fa-calendar-plus-o mr-2 w-5 text-center"></i>活动报名
                </a>
                <a href="#" id="mobile-logout-button" class="block px-4 py-2 text-gray-700 hover:bg-white/50 hover:text-danger transition-all duration-300 rounded-lg my-1">
                    <i class="fa fa-sign-out mr-2 w-5 text-center"></i>退出登录
                </a>
            </div>
        </div>
    </div>
</nav>

<!-- 修复重复元素的脚本 -->
<script>
// 动态确定脚本路径，确保在所有目录级别都能正确加载
function getBasePath() {
    const path = window.location.pathname;
    const depth = (path.match(/\//g) || []).length - 1;
    return ''.padStart(depth, '../');
}
const basePath = getBasePath();

// 动态加载fix_duplicate_user_menu.js脚本
const fixScript = document.createElement('script');
fixScript.src = basePath + 'fix_duplicate_user_menu.js';
fixScript.onload = function() {
    console.log('✅ 修复脚本已成功加载');
};
fixScript.onerror = function() {
    console.error('❌ 修复脚本加载失败，尝试备用路径...');
    fixScript.src = 'fix_duplicate_user_menu.js';
    document.head.appendChild(fixScript);
};
document.head.appendChild(fixScript);

// 动态加载navbar.js脚本
const navbarScript = document.createElement('script');
navbarScript.src = basePath + 'navbar.js';
navbarScript.onload = function() {
    console.log('✅ 导航栏脚本已成功加载');
};
navbarScript.onerror = function() {
    console.error('❌ 导航栏脚本加载失败，尝试备用路径...');
    navbarScript.src = 'navbar.js';
    document.head.appendChild(navbarScript);
};
document.head.appendChild(navbarScript);
</script>
            
            <!-- 移动端登录/注册按钮 -->
            <div class="flex space-x-3 py-3 mt-2">
                <button class="px-4 py-2.5 text-primary border border-primary rounded-lg hover:bg-primary/5 transition-all duration-300 flex-1 font-medium focus:outline-none focus:ring-2 focus:ring-primary/30" onclick="window.location.href='login.html'">
                    <i class="fa fa-sign-in mr-2"></i>登录
                </button>
                <button class="px-4 py-2.5 bg-gradient-to-r from-primary to-indigo-600 text-white rounded-lg hover:from-indigo-600 hover:to-indigo-700 transition-all duration-300 flex-1 font-medium focus:outline-none focus:ring-2 focus:ring-primary/30" onclick="window.location.href='register.html'">
                    <i class="fa fa-user-plus mr-2"></i>注册
                </button>
            </div>
            
            <!-- 移动端用户菜单（登录后显示） -->
            <div id="mobile-user-menu" class="hidden py-2 animate-fade-in">
                <div class="flex items-center space-x-3 mb-3 pb-3 border-b border-gray-200 bg-white/30 rounded-lg p-2">
                    <div class="h-10 w-10 rounded-full bg-gradient-to-br from-primary to-indigo-600 flex items-center justify-center text-white">
                        <i class="fa fa-user"></i>
                    </div>
                    <span id="mobile-user-name" class="text-gray-700 font-medium"></span>
                </div>
                <a href="user_profile.html" class="block px-4 py-2 text-gray-700 hover:bg-white/50 transition-all duration-300 rounded-lg my-1">
                    <i class="fa fa-user-circle mr-2 w-5 text-center"></i>个人中心
                </a>
                <a href="assessment_history.html" class="block px-4 py-2 text-gray-700 hover:bg-white/50 transition-all duration-300 rounded-lg my-1">
                    <i class="fa fa-list-alt mr-2 w-5 text-center"></i>测评记录
                </a>
                <a href="booking_history.html" class="block px-4 py-2 text-gray-700 hover:bg-white/50 transition-all duration-300 rounded-lg my-1">
                    <i class="fa fa-calendar-check-o mr-2 w-5 text-center"></i>预约记录
                </a>
                <a href="activity_registration.html" class="block px-4 py-2 text-gray-700 hover:bg-white/50 transition-all duration-300 rounded-lg my-1">
                    <i class="fa fa-calendar-plus-o mr-2 w-5 text-center"></i>活动报名
                </a>
                <a href="#" id="mobile-logout-button" class="block px-4 py-2 text-gray-700 hover:bg-white/50 hover:text-danger transition-all duration-300 rounded-lg my-1">
                    <i class="fa fa-sign-out mr-2 w-5 text-center"></i>退出登录
                </a>
            </div>
        </div>
    </div>
</nav>

<!-- 导航栏必要的脚本引用 -->
<script src="components/navbar.js" defer></script>
<script src="components/fix_duplicate_user_menu.js" defer></script>

<!-- 导航栏JavaScript功能 -->
<script>
        // 导航栏管理类
        class NavbarManager {
            constructor() {
                this.navElement = document.getElementById('main-nav');
                this.mobileMenuToggle = document.getElementById('mobile-menu-toggle');
                this.mobileMenu = document.getElementById('mobile-menu');
                this.desktopMoreMenuButton = document.getElementById('desktop-more-menu-button');
                this.desktopMoreDropdown = document.getElementById('desktop-more-dropdown');
                this.userMenuButton = document.getElementById('user-menu-button');
                this.userDropdown = document.getElementById('user-dropdown');
                this.logoutButton = document.getElementById('logout-button');
                this.mobileLogoutButton = document.getElementById('mobile-logout-button');
                this.authButtons = document.getElementById('auth-buttons');
                this.userMenu = document.getElementById('user-menu');
                this.mobileAuthButtons = document.getElementById('mobile-auth-buttons');
                this.mobileUserMenu = document.getElementById('mobile-user-menu');
                this.userName = document.getElementById('user-name');
                this.mobileUserName = document.getElementById('mobile-user-name');
                
                // 配置动画参数
                this.animationSpeed = 300; // 动画速度（毫秒）
                this.lastScrollTop = 0;
                this.isMobileMenuOpen = false;
                this.isDesktopMoreMenuOpen = false;
                this.isUserMenuOpen = false;
                
                // 获取所有导航链接
                this.navLinks = document.querySelectorAll('.nav-link, .mobile-nav-link');
            }
            
            // 初始化导航栏功能
            init() {
                this.initScrollEffect();
                this.initMobileMenu();
                this.initUserMenu();
                this.initMoreMenu();
                this.checkLoginStatus();
                this.initHighlightCurrentPage();
                this.initCloseDropdownOnOutsideClick();
                this.initLinkHoverEffects();
                this.initSmoothScroll();
                this.initKeyboardNavigation();
                this.initPageLoadAnimation();
            }
            
            // 工具函数：防抖
            debounce(func, wait) {
                let timeout;
                return function() {
                    const context = this;
                    const args = arguments;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), wait);
                };
            }
            
            // 工具函数：节流
            throttle(func, limit) {
                let inThrottle;
                return function() {
                    const context = this;
                    const args = arguments;
                    if (!inThrottle) {
                        func.apply(context, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                };
            }
            
            // 初始化滚动效果
            initScrollEffect() {
                // 使用节流优化滚动性能
                window.addEventListener('scroll', this.throttle(() => {
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    
                    // 设置CSS变量控制过渡动画
                    this.navElement.style.setProperty('--transition-speed', `${this.animationSpeed}ms`);
                    
                    if (scrollTop > 50) {
                        this.navElement.classList.add('nav-scrolled');
                        this.navElement.classList.remove('py-4');
                        this.navElement.classList.add('py-2');
                        // 添加阴影效果，使导航栏更突出
                        this.navElement.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.08)';
                    } else {
                        this.navElement.classList.remove('nav-scrolled');
                        this.navElement.classList.remove('py-2');
                        this.navElement.classList.add('py-4');
                        // 移除阴影
                        this.navElement.style.boxShadow = 'none';
                    }
                    
                    // 隐藏/显示导航栏（向上滚动显示，向下滚动隐藏）
                    if (scrollTop > this.lastScrollTop && scrollTop > 100) {
                        // 平滑隐藏
                        this.navElement.classList.add('nav-hidden');
                        this.navElement.style.transform = `translateY(-100%)`;
                        this.navElement.style.transition = `transform ${this.animationSpeed}ms ease`;
                    } else if (scrollTop < this.lastScrollTop || scrollTop <= 100) {
                        // 平滑显示
                        this.navElement.classList.remove('nav-hidden');
                        this.navElement.style.transform = `translateY(0)`;
                        this.navElement.style.transition = `transform ${this.animationSpeed}ms ease`;
                    }
                    
                    this.lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
                }, 16)); // 约60fps
            }
            
            // 初始化移动端菜单
            initMobileMenu() {
                if (this.mobileMenuToggle && this.mobileMenu) {
                    // 添加点击波纹效果
                    this.addRippleToElement(this.mobileMenuToggle);
                    
                    this.mobileMenuToggle.addEventListener('click', this.debounce(() => {
                        this.toggleMobileMenu();
                    }, 50));
                }
            }
            
            // 切换移动端菜单显示状态
            toggleMobileMenu() {
                this.isMobileMenuOpen = !this.isMobileMenuOpen;
                
                if (this.isMobileMenuOpen) {
                    // 移除hidden类并添加动画类
                    this.mobileMenu.classList.remove('hidden');
                    // 延迟添加动画类以确保过渡效果正常
                    setTimeout(() => {
                        this.mobileMenu.classList.add('mobile-menu-open');
                    }, 10);
                    this.mobileMenuToggle.setAttribute('aria-expanded', 'true');
                    
                    // 添加菜单项目的级联动画
                    this.animateMenuItems(this.mobileMenu.querySelectorAll('.mobile-nav-link, .mobile-menu-section'), true);
                    
                    // 防止背景滚动 - 更优雅的方式
                    this.disableBodyScroll();
                } else {
                    // 先添加关闭动画，然后隐藏
                    this.mobileMenu.classList.remove('mobile-menu-open');
                    
                    // 添加菜单项目的级联动画（反向）
                    const menuItems = this.mobileMenu.querySelectorAll('.mobile-nav-link, .mobile-menu-section');
                    this.animateMenuItems(menuItems, false);
                    
                    // 延迟隐藏以等待动画完成
                    setTimeout(() => {
                        this.mobileMenu.classList.add('hidden');
                    }, this.animationSpeed);
                    
                    this.mobileMenuToggle.setAttribute('aria-expanded', 'false');
                    
                    // 恢复背景滚动
                    this.enableBodyScroll();
                }
            }
            
            // 为菜单项目添加级联动画
            animateMenuItems(items, isOpening) {
                items.forEach((item, index) => {
                    if (isOpening) {
                        // 重置样式
                        item.style.opacity = '0';
                        item.style.transform = 'translateX(-20px)';
                        
                        // 设置动画
                        setTimeout(() => {
                            item.style.transition = `opacity 0.3s ease ${index * 50}ms, transform 0.3s ease ${index * 50}ms`;
                            item.style.opacity = '1';
                            item.style.transform = 'translateX(0)';
                        }, 50);
                    } else {
                        // 关闭动画
                        const delay = (items.length - index - 1) * 30;
                        item.style.transition = `opacity 0.2s ease ${delay}ms, transform 0.2s ease ${delay}ms`;
                        item.style.opacity = '0';
                        item.style.transform = 'translateX(-20px)';
                    }
                });
            }
            
            // 禁用页面滚动
            disableBodyScroll() {
                this.scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                document.body.style.overflow = 'hidden';
                document.body.style.position = 'fixed';
                document.body.style.top = `-${this.scrollTop}px`;
                document.body.style.width = '100%';
                document.body.style.touchAction = 'none'; // 防止移动设备上的滚动
            }
            
            // 启用页面滚动
            enableBodyScroll() {
                document.body.style.overflow = '';
                document.body.style.position = '';
                document.body.style.top = '';
                document.body.style.width = '';
                document.body.style.touchAction = '';
                window.scrollTo(0, this.scrollTop);
            }
            
            // 初始化用户菜单
            initUserMenu() {
                if (this.userMenuButton && this.userDropdown) {
                    // 添加点击波纹效果
                    this.addRippleToElement(this.userMenuButton);
                    
                    this.userMenuButton.addEventListener('click', this.debounce(() => {
                        this.toggleUserMenu();
                    }, 50));
                }
            }
            
            // 切换用户菜单显示状态
            toggleUserMenu() {
                this.isUserMenuOpen = !this.isUserMenuOpen;
                
                if (this.isUserMenuOpen) {
                    // 移除hidden类并添加动画
                    this.userDropdown.classList.remove('hidden');
                    setTimeout(() => {
                        this.userDropdown.classList.add('dropdown-animation');
                    }, 10);
                    this.userMenuButton.setAttribute('aria-expanded', 'true');
                    
                    // 为下拉菜单项添加淡入动画
                    this.animateDropdownItems(this.userDropdown.querySelectorAll('a, button'), true);
                    
                    // 关闭其他打开的菜单
                    if (this.isDesktopMoreMenuOpen) {
                        this.toggleMoreMenu();
                    }
                } else {
                    // 移除动画类
                    this.userDropdown.classList.remove('dropdown-animation');
                    
                    // 为下拉菜单项添加淡出动画
                    const items = this.userDropdown.querySelectorAll('a, button');
                    this.animateDropdownItems(items, false);
                    
                    // 延迟隐藏以等待动画完成
                    setTimeout(() => {
                        this.userDropdown.classList.add('hidden');
                    }, this.animationSpeed);
                    
                    this.userMenuButton.setAttribute('aria-expanded', 'false');
                }
            }
            
            // 为下拉菜单项添加动画
            animateDropdownItems(items, isOpening) {
                items.forEach((item, index) => {
                    if (isOpening) {
                        // 重置样式
                        item.style.opacity = '0';
                        item.style.transform = 'translateY(-10px)';
                        
                        // 设置动画
                        setTimeout(() => {
                            item.style.transition = `opacity 0.2s ease ${index * 40}ms, transform 0.2s ease ${index * 40}ms`;
                            item.style.opacity = '1';
                            item.style.transform = 'translateY(0)';
                        }, 50);
                    } else {
                        // 关闭动画
                        const delay = (items.length - index - 1) * 30;
                        item.style.transition = `opacity 0.15s ease ${delay}ms, transform 0.15s ease ${delay}ms`;
                        item.style.opacity = '0';
                        item.style.transform = 'translateY(-10px)';
                    }
                });
            }
            
            // 初始化更多服务菜单
            initMoreMenu() {
                if (this.desktopMoreMenuButton && this.desktopMoreDropdown) {
                    // 添加点击波纹效果
                    this.addRippleToElement(this.desktopMoreMenuButton);
                    
                    this.desktopMoreMenuButton.addEventListener('click', this.debounce(() => {
                        this.toggleMoreMenu();
                    }, 50));
                }
            }
            
            // 切换更多服务菜单显示状态
            toggleMoreMenu() {
                this.isDesktopMoreMenuOpen = !this.isDesktopMoreMenuOpen;
                
                if (this.isDesktopMoreMenuOpen) {
                    // 移除hidden类并添加动画
                    this.desktopMoreDropdown.classList.remove('hidden');
                    setTimeout(() => {
                        this.desktopMoreDropdown.classList.add('dropdown-animation');
                    }, 10);
                    this.desktopMoreMenuButton.setAttribute('aria-expanded', 'true');
                    
                    // 为下拉菜单项添加淡入动画
                    this.animateDropdownItems(this.desktopMoreDropdown.querySelectorAll('a'), true);
                    
                    // 关闭其他打开的菜单
                    if (this.isUserMenuOpen) {
                        this.toggleUserMenu();
                    }
                } else {
                    // 移除动画类
                    this.desktopMoreDropdown.classList.remove('dropdown-animation');
                    
                    // 为下拉菜单项添加淡出动画
                    const items = this.desktopMoreDropdown.querySelectorAll('a');
                    this.animateDropdownItems(items, false);
                    
                    // 延迟隐藏以等待动画完成
                    setTimeout(() => {
                        this.desktopMoreDropdown.classList.add('hidden');
                    }, this.animationSpeed);
                    
                    this.desktopMoreMenuButton.setAttribute('aria-expanded', 'false');
                }
            }
            
            // 检查登录状态
            checkLoginStatus() {
                // 从本地存储获取用户信息
                const userInfo = localStorage.getItem('userInfo');
                
                if (userInfo) {
                    try {
                        const user = JSON.parse(userInfo);
                        // 显示用户菜单，隐藏登录/注册按钮 - 使用淡入淡出效果
                        if (this.userMenu && this.authButtons) {
                            this.authButtons.style.transition = `opacity 0.3s ease, transform 0.3s ease`;
                            this.authButtons.style.opacity = '0';
                            this.authButtons.style.transform = 'translateY(-10px)';
                            
                            setTimeout(() => {
                                this.authButtons.classList.add('hidden');
                                if (!this.userMenu.classList.contains('hidden')) {
                                    this.userMenu.style.transition = `opacity 0.3s ease, transform 0.3s ease`;
                                    this.userMenu.style.opacity = '1';
                                    this.userMenu.style.transform = 'translateY(0)';
                                } else {
                                    this.userMenu.classList.remove('hidden');
                                    // 触发重排
                                    this.userMenu.offsetHeight;
                                    this.userMenu.style.transition = `opacity 0.3s ease, transform 0.3s ease`;
                                    this.userMenu.style.opacity = '1';
                                    this.userMenu.style.transform = 'translateY(0)';
                                }
                            }, 300);
                        }
                        
                        // 移动端同样处理
                        if (this.mobileUserMenu && this.mobileAuthButtons) {
                            this.mobileAuthButtons.style.transition = `opacity 0.3s ease, transform 0.3s ease`;
                            this.mobileAuthButtons.style.opacity = '0';
                            this.mobileAuthButtons.style.transform = 'translateY(-10px)';
                            
                            setTimeout(() => {
                                this.mobileAuthButtons.classList.add('hidden');
                                if (!this.mobileUserMenu.classList.contains('hidden')) {
                                    this.mobileUserMenu.style.transition = `opacity 0.3s ease, transform 0.3s ease`;
                                    this.mobileUserMenu.style.opacity = '1';
                                    this.mobileUserMenu.style.transform = 'translateY(0)';
                                } else {
                                    this.mobileUserMenu.classList.remove('hidden');
                                    // 触发重排
                                    this.mobileUserMenu.offsetHeight;
                                    this.mobileUserMenu.style.transition = `opacity 0.3s ease, transform 0.3s ease`;
                                    this.mobileUserMenu.style.opacity = '1';
                                    this.mobileUserMenu.style.transform = 'translateY(0)';
                                }
                            }, 300);
                        }
                        
                        // 设置用户名
                        if (this.userName && this.mobileUserName) {
                            // 添加用户名淡入效果
                            this.userName.style.opacity = '0';
                            this.mobileUserName.style.opacity = '0';
                            
                            this.userName.textContent = user.name || '用户';
                            this.mobileUserName.textContent = user.name || '用户';
                            
                            setTimeout(() => {
                                this.userName.style.transition = `opacity 0.5s ease`;
                                this.mobileUserName.style.transition = `opacity 0.5s ease`;
                                this.userName.style.opacity = '1';
                                this.mobileUserName.style.opacity = '1';
                            }, 350);
                        }
                        
                        // 绑定退出登录事件
                        this.bindLogoutEvent();
                    } catch (e) {
                        console.error('解析用户信息失败:', e);
                        // 解析失败，清除本地存储
                        localStorage.removeItem('userInfo');
                    }
                }
            }
            
            // 绑定退出登录事件
            bindLogoutEvent() {
                if (this.logoutButton) {
                    this.logoutButton.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.addRippleToElement(this.logoutButton);
                        // 添加点击后的视觉反馈
                        this.logoutButton.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            this.logoutButton.style.transform = 'scale(1)';
                            this.logout();
                        }, 150);
                    });
                }
                
                if (this.mobileLogoutButton) {
                    this.mobileLogoutButton.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.addRippleToElement(this.mobileLogoutButton);
                        // 添加点击后的视觉反馈
                        this.mobileLogoutButton.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            this.mobileLogoutButton.style.transform = 'scale(1)';
                            this.logout();
                        }, 150);
                    });
                }
            }
            
            // 退出登录
            logout() {
                // 添加淡出动画
                document.body.style.transition = 'opacity 0.3s ease';
                document.body.style.opacity = '0';
                
                // 清除本地存储的用户信息
                localStorage.removeItem('userInfo');
                
                // 延迟刷新以等待动画完成
                setTimeout(() => {
                    window.location.reload();
                }, 300);
            }
            
            // 初始化当前页面高亮
            initHighlightCurrentPage() {
                // 获取当前页面标识
                const currentPage = window.current_page || '';
                const currentUrl = window.location.pathname;
                
                // 为导航链接添加高亮样式
                this.navLinks.forEach(link => {
                    const href = link.getAttribute('href');
                    if (href) {
                        // 匹配当前页面或URL路径
                        const isActive = href.includes(currentPage) || 
                                        (href !== '#' && currentUrl.includes(href)) ||
                                        (href === 'index.html' && currentUrl === '/');
                        
                        if (isActive) {
                            // 添加高亮样式，带有平滑过渡
                            link.style.transition = 'all 0.3s ease';
                            link.classList.add('nav-link-active');
                            link.classList.remove('nav-link-hover');
                            // 添加微妙的缩放效果
                            link.style.transform = 'scale(1.05)';
                        }
                    }
                });
            }
            
            // 初始化链接悬停效果
            initLinkHoverEffects() {
                this.navLinks.forEach((link, index) => {
                    // 跳过已激活的链接
                    if (!link.classList.contains('nav-link-active')) {
                        link.addEventListener('mouseenter', (e) => {
                            // 计算延迟，创建级联效果
                            const delay = index * 20;
                            
                            link.style.transition = `transform 0.2s ease ${delay}ms, color 0.2s ease, background-color 0.2s ease`;
                            link.style.transform = 'translateY(-3px)';
                            link.style.color = '#3b82f6'; // 主色调
                        });
                        
                        link.addEventListener('mouseleave', (e) => {
                            // 计算延迟，创建级联效果
                            const delay = index * 20;
                            
                            link.style.transition = `transform 0.2s ease ${delay}ms, color 0.2s ease, background-color 0.2s ease`;
                            link.style.transform = 'translateY(0)';
                            link.style.color = ''; // 恢复默认
                        });
                        
                        // 添加点击波纹效果
                        this.addRippleToElement(link);
                    }
                });
            }
            
            // 添加点击波纹效果
            addRippleToElement(element) {
                element.addEventListener('click', function(e) {
                    // 排除右键点击
                    if (e.button !== 0) return;
                    
                    // 计算波纹位置
                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    const x = e.clientX - rect.left - size / 2;
                    const y = e.clientY - rect.top - size / 2;
                    
                    // 创建波纹元素
                    const ripple = document.createElement('span');
                    ripple.classList.add('ripple-effect');
                    ripple.style.width = ripple.style.height = `${size}px`;
                    ripple.style.left = `${x}px`;
                    ripple.style.top = `${y}px`;
                    
                    // 移除旧的波纹
                    const oldRipple = this.querySelector('.ripple-effect');
                    if (oldRipple) {
                        oldRipple.remove();
                    }
                    
                    // 添加新的波纹
                    this.appendChild(ripple);
                    
                    // 动画结束后移除
                    setTimeout(() => {
                        ripple.remove();
                    }, 600);
                });
            }
            
            // 初始化平滑滚动
            initSmoothScroll() {
                // 为所有内部链接添加平滑滚动
                document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                    anchor.addEventListener('click', function(e) {
                        e.preventDefault();
                        
                        const targetId = this.getAttribute('href');
                        const targetElement = document.querySelector(targetId);
                        
                        if (targetElement) {
                            // 计算目标位置，考虑导航栏高度
                            const navHeight = this.navElement ? this.navElement.offsetHeight : 80;
                            const targetPosition = targetElement.getBoundingClientRect().top + window.pageYOffset - navHeight;
                            
                            // 使用自定义平滑滚动函数
                            this.smoothScrollTo(targetPosition, 800);
                        }
                    }.bind(this));
                });
            }
            
            // 自定义平滑滚动函数
            smoothScrollTo(targetPosition, duration) {
                const startPosition = window.pageYOffset;
                const distance = targetPosition - startPosition;
                let startTime = null;
                
                function animation(currentTime) {
                    if (startTime === null) startTime = currentTime;
                    const timeElapsed = currentTime - startTime;
                    const run = this.ease(timeElapsed, startPosition, distance, duration);
                    window.scrollTo(0, run);
                    if (timeElapsed < duration) {
                        requestAnimationFrame(animation.bind(this));
                    }
                }
                
                // 缓动函数 - 平滑的开始和结束
                this.ease = function(t, b, c, d) {
                    t /= d / 2;
                    if (t < 1) return c / 2 * t * t + b;
                    t--;
                    return -c / 2 * (t * (t - 2) - 1) + b;
                };
                
                requestAnimationFrame(animation.bind(this));
            }
            
            // 初始化键盘导航
            initKeyboardNavigation() {
                document.addEventListener('keydown', (e) => {
                    // ESC键关闭所有菜单
                    if (e.key === 'Escape') {
                        if (this.isMobileMenuOpen) {
                            this.toggleMobileMenu();
                        }
                        if (this.isDesktopMoreMenuOpen) {
                            this.toggleMoreMenu();
                        }
                        if (this.isUserMenuOpen) {
                            this.toggleUserMenu();
                        }
                    }
                    
                    // 为打开的下拉菜单提供键盘导航
                    const activeMenu = this.getActiveMenu();
                    if (activeMenu) {
                        const focusableItems = activeMenu.querySelectorAll('a, button, [tabindex="0"]');
                        if (focusableItems.length > 0) {
                            const currentIndex = Array.from(focusableItems).indexOf(document.activeElement);
                            let nextIndex = currentIndex;
                            
                            if (e.key === 'ArrowDown') {
                                e.preventDefault();
                                nextIndex = currentIndex < focusableItems.length - 1 ? currentIndex + 1 : 0;
                                focusableItems[nextIndex].focus();
                            } else if (e.key === 'ArrowUp') {
                                e.preventDefault();
                                nextIndex = currentIndex > 0 ? currentIndex - 1 : focusableItems.length - 1;
                                focusableItems[nextIndex].focus();
                            } else if (e.key === 'Enter' || e.key === ' ') {
                                // 确保当前聚焦项有点击事件触发
                                if (document.activeElement) {
                                    document.activeElement.click();
                                }
                            }
                        }
                    }
                });
            }
            
            // 获取当前活动的菜单
            getActiveMenu() {
                if (this.isMobileMenuOpen && this.mobileMenu) return this.mobileMenu;
                if (this.isDesktopMoreMenuOpen && this.desktopMoreDropdown) return this.desktopMoreDropdown;
                if (this.isUserMenuOpen && this.userDropdown) return this.userDropdown;
                return null;
            }
            
            // 页面加载动画
            initPageLoadAnimation() {
                // 为导航栏添加淡入和上移动画
                this.navElement.style.opacity = '0';
                this.navElement.style.transform = 'translateY(-20px)';
                this.navElement.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                
                // 添加延迟以确保动画效果可见
                setTimeout(() => {
                    this.navElement.style.opacity = '1';
                    this.navElement.style.transform = 'translateY(0)';
                }, 100);
                
                // 为导航链接添加级联淡入效果
                setTimeout(() => {
                    this.navLinks.forEach((link, index) => {
                        if (!link.classList.contains('nav-link-active')) {
                            link.style.opacity = '0';
                            link.style.transform = 'translateY(10px)';
                            
                            setTimeout(() => {
                                link.style.transition = `opacity 0.4s ease, transform 0.4s ease`;
                                link.style.opacity = '1';
                                link.style.transform = 'translateY(0)';
                            }, index * 50);
                        }
                    });
                }, 300);
            }
            
            // 初始化点击外部关闭下拉菜单
            initCloseDropdownOnOutsideClick() {
                document.addEventListener('click', (e) => {
                    // 检查是否点击了导航栏外部
                    if (!this.navElement.contains(e.target)) {
                        // 关闭所有下拉菜单 - 添加动画
                        if (this.isMobileMenuOpen) {
                            this.toggleMobileMenu();
                        }
                        if (this.isDesktopMoreMenuOpen) {
                            this.toggleMoreMenu();
                        }
                        if (this.isUserMenuOpen) {
                            this.toggleUserMenu();
                        }
                    }
                });
            }
        }
        
        // 页面加载完成后初始化导航栏
        document.addEventListener('DOMContentLoaded', () => {
            const navbarManager = new NavbarManager();
            navbarManager.init();
        });
    </script>

    <!-- 主要内容区 -->
    <main class="sandbox-container">
        <!-- 沙箱区域 -->
        <div id="sandbox" class="sandbox-area">
            <!-- 水域层 -->
            <div id="water-area" class="water-layer"></div>
            
            <!-- 沙具容器 -->
            <div id="sandbox-items" class="sandbox-items"></div>
            
            <!-- 漂浮提示卡 -->
            <div id="floating-tip" class="floating-tip">
                <p>试着点击沙箱，从菜单中选择让你有感觉的符号，不用在意'对错'—— 你的摆放本身就是语言</p>
                <button id="close-tip">关闭</button>
            </div>
        </div>

        <!-- 环形菜单 (默认隐藏) -->
        <div id="radial-menu" class="radial-menu hidden">
            <!-- 菜单项将通过JavaScript动态生成 -->
        </div>

        <!-- 沙具变体选择 (默认隐藏) -->
        <div id="variant-selector" class="variant-selector hidden">
            <!-- 变体选项将通过JavaScript动态生成 -->
        </div>

        <!-- 沙具功能盘 (默认隐藏) -->
        <div id="item-controls" class="item-controls hidden">
            <div class="control-btn rotate-btn"><i class="fas fa-sync-alt"></i></div>
            <div class="control-btn duplicate-btn"><i class="fas fa-copy"></i></div>
            <div class="control-btn scale-btn"><i class="fas fa-expand-alt"></i></div>
            <div class="control-btn remove-btn"><i class="fas fa-trash-alt"></i></div>
        </div>

        <!-- 全局工具栏 -->
        <div id="global-tools" class="global-tools">
            <div class="tool-btn reset-btn" title="重置沙盘"><i class="fas fa-undo"></i></div>
            <div class="tool-btn save-btn" title="保存场景"><i class="fas fa-save"></i></div>
            <div class="tool-btn load-btn" title="加载场景"><i class="fas fa-folder-open"></i></div>
            <div class="tool-btn analyze-btn" title="AI解读"><i class="fas fa-brain"></i></div>
            <div class="tool-btn music-toggle-btn" title="背景音乐开关"><i class="fas fa-music"></i></div>
            <div class="tool-btn mute-btn" title="静音/取消静音"><i class="fas fa-volume-up"></i></div>
            <!-- 音量控制滑块 -->
            <div class="volume-control">
                <input type="range" id="effects-volume" min="0" max="1" step="0.1" value="0.5" title="音效音量">
            </div>
            <div class="volume-control">
                <input type="range" id="music-volume" min="0" max="1" step="0.1" value="0.3" title="音乐音量">
            </div>
        </div>

        <!-- AI解读面板 (默认隐藏) -->
        <div id="analysis-panel" class="analysis-panel hidden">
            <div class="panel-header">
                <h3>心理解读</h3>
                <button id="close-analysis">×</button>
            </div>
            <div id="analysis-content" class="panel-content">
                <!-- AI解读内容将通过JavaScript动态生成 -->
            </div>
        </div>
    </main>

    <!-- 修复沙盘UI的脚本 -->
    <script src="fix_sandbox_ui.js"></script>
    
    <!-- 页脚 -->
    <!-- 统一页脚组件 -->
<footer class="bg-[#1e293b] text-white py-4">
    <div class="container mx-auto px-4">
        <div class="flex justify-between items-center">
            <!-- 左侧Logo和文字 -->
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 rounded-full bg-purple-500 flex items-center justify-center text-white">
                    <i class="fa fa-heart"></i>
                </div>
                <span class="text-white">心社区</span>
            </div>
            
            <!-- 中间版权信息 -->
            <div class="text-center">
                <p class="text-white">© 2025 心社区心理健康支持中心. 保留所有权利.</p>
            </div>
            
            <!-- 右侧图标 -->
            <div class="flex space-x-4">
                <a href="#" class="text-white/70 hover:text-white transition-colors">
                    <i class="fa fa-weixin"></i>
                </a>
                <a href="#" class="text-white/70 hover:text-white transition-colors">
                    <i class="fa fa-weibo"></i>
                </a>
                <a href="#" class="text-white/70 hover:text-white transition-colors">
                    <i class="fa fa-bell"></i>
                </a>
            </div>
        </div>
    </div>
</footer>

    <script src="common.js"></script>
    <script>
        // 初始化音效控制按钮事件
        function initSoundControls() {
            // 静音按钮
            const muteBtn = document.querySelector('.mute-btn');
            muteBtn.addEventListener('click', function() {
                const isMuted = toggleMute();
                if (isMuted) {
                    this.classList.add('muted');
                    this.querySelector('i').className = 'fas fa-volume-mute';
                } else {
                    this.classList.remove('muted');
                    this.querySelector('i').className = 'fas fa-volume-up';
                }
            });
            
            // 背景音乐开关按钮
            const musicToggleBtn = document.querySelector('.music-toggle-btn');
            let isMusicPlaying = false;
            musicToggleBtn.addEventListener('click', function() {
                isMusicPlaying = !isMusicPlaying;
                toggleBackgroundMusic(isMusicPlaying);
                
                if (isMusicPlaying) {
                    this.classList.remove('music-off');
                } else {
                    this.classList.add('music-off');
                }
            });
            
            // 音效音量滑块
            const effectsVolumeSlider = document.getElementById('effects-volume');
            effectsVolumeSlider.addEventListener('input', function() {
                const volume = parseFloat(this.value);
                setVolume('effects', volume);
            });
            
            // 音乐音量滑块
            const musicVolumeSlider = document.getElementById('music-volume');
            musicVolumeSlider.addEventListener('input', function() {
                const volume = parseFloat(this.value);
                setVolume('music', volume);
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // 加载导航栏和页脚
            fetch('components/navbar.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('navbar').innerHTML = data;
                    // 初始化导航栏功能
                    initSoundControls();
                    
                    if (typeof initNavbar === 'function') {
                        initNavbar();
                    }
                });
            
            fetch('components/footer.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('footer').innerHTML = data;
                });

            // 全局变量
            const sandbox = document.getElementById('sandbox');
            const sandboxItems = document.getElementById('sandbox-items');
            const radialMenu = document.getElementById('radial-menu');
            const variantSelector = document.getElementById('variant-selector');
            const itemControls = document.getElementById('item-controls');
            const floatingTip = document.getElementById('floating-tip');
            const analysisPanel = document.getElementById('analysis-panel');
            const analysisContent = document.getElementById('analysis-content');
            
            let selectedMenuItem = null;
            let currentItem = null;
            let menuTimeout = null;
            let itemCount = 0;
            
            // 沙具数据结构（10个心理学维度）- 完整的符号系统
            const sandItemsData = {
                'self': {
                    name: '自我',
                    icon: 'fas fa-user',
                    color: '#4A90E2',
                    variants: [
                        { name: '成年男性', icon: 'fas fa-user', specialEffect: 'pulse', sound: 'soft-tone' },
                        { name: '成年女性', icon: 'fas fa-female', specialEffect: 'pulse', sound: 'soft-tone' },
                        { name: '儿童', icon: 'fas fa-child', specialEffect: 'float', sound: 'light-tone' },
                        { name: '抽象人形', icon: 'fas fa-user-circle', specialEffect: 'glow', sound: 'harmonic-tone' },
                        { name: '老人', icon: 'fas fa-user-tie', specialEffect: 'wisdom', sound: 'deep-tone' },
                        { name: '影子', icon: 'fas fa-user-secret', specialEffect: 'fade', sound: 'whisper' }
                    ],
                    type: 'character',
                    dynamics: {
                        connectTo: ['relationship', 'growth'],
                        influenceRange: 100
                    }
                },
                'relationship': {
                    name: '关系',
                    icon: 'fas fa-handshake',
                    color: '#50C878',
                    variants: [
                        { name: '桥梁', icon: 'fas fa-landmark', specialEffect: 'bridge-connect', sound: 'flowing' },
                        { name: '双手', icon: 'fas fa-hands', specialEffect: 'grab', sound: 'gentle-grab' },
                        { name: '对话气泡', icon: 'fas fa-comment-dots', specialEffect: 'bubble', sound: 'whisper' },
                        { name: '锁链', icon: 'fas fa-chain', specialEffect: 'link', sound: 'chain-rattle' },
                        { name: '家庭', icon: 'fas fa-home', specialEffect: 'family-bond', sound: 'heart-warm' },
                        { name: '拥抱', icon: 'fas fa-hands-hugging', specialEffect: 'comfort', sound: 'warmth' }
                    ],
                    type: 'connection',
                    dynamics: {
                        connectTo: ['self', 'environment'],
                        influenceRange: 80,
                        createLines: true
                    }
                },
                'environment': {
                    name: '环境',
                    icon: 'fas fa-tree',
                    color: '#2E8B57',
                    variants: [
                        { name: '房屋', icon: 'fas fa-home', specialEffect: 'house-glow', sound: 'home-ambient' },
                        { name: '树木', icon: 'fas fa-tree', specialEffect: 'sway', sound: 'wind-through-leaves' },
                        { name: '山脉', icon: 'fas fa-mountain', specialEffect: 'stable', sound: 'deep-ambient' },
                        { name: '河流', icon: 'fas fa-water', specialEffect: 'flow', sound: 'water-flow', waterCompatible: true },
                        { name: '海洋', icon: 'fas fa-water', specialEffect: 'wave', sound: 'ocean', waterCompatible: true },
                        { name: '森林', icon: 'fas fa-tree', specialEffect: 'forest-glow', sound: 'birds' },
                        { name: '道路', icon: 'fas fa-road', specialEffect: 'path', sound: 'travel' }
                    ],
                    type: 'space',
                    dynamics: {
                        influenceArea: 'large',
                        positionNearWater: false
                    }
                },
                'emotion': {
                    name: '情绪',
                    icon: 'fas fa-heart',
                    color: '#E74C3C',
                    variants: [
                        { name: '乌云', icon: 'fas fa-cloud', specialEffect: 'darken', sound: 'thunder-distant', animation: 'float' },
                        { name: '火焰', icon: 'fas fa-fire', specialEffect: 'heat', sound: 'crackle', animation: 'flame-animation' },
                        { name: '彩虹', icon: 'fas fa-heart', specialEffect: 'rainbow-glow', sound: 'bright-chime', animation: 'glow' },
                        { name: '漩涡', icon: 'fas fa-stream', specialEffect: 'spin', sound: 'swirl', animation: 'spin' },
                        { name: '星星', icon: 'fas fa-star', specialEffect: 'twinkle', sound: 'twinkle', animation: 'pulse' },
                        { name: '风暴', icon: 'fas fa-wind', specialEffect: 'turbulence', sound: 'storm', animation: 'shake' },
                        { name: '花朵', icon: 'fas fa-flower', specialEffect: 'bloom', sound: 'bloom', animation: 'grow' }
                    ],
                    type: 'abstract',
                    dynamics: {
                        affectedBy: ['defense'],
                        intensity: 'high',
                        fadeWhenDefended: true
                    }
                },
                'defense': {
                    name: '防御',
                    icon: 'fas fa-shield-alt',
                    color: '#95A5A6',
                    variants: [
                        { name: '围墙', icon: 'fas fa-border-all', specialEffect: 'enclose', sound: 'wall-thump' },
                        { name: '盾牌', icon: 'fas fa-shield-alt', specialEffect: 'protect', sound: 'shield-clang' },
                        { name: '迷宫', icon: 'fas fa-map', specialEffect: 'confuse', sound: 'puzzle' },
                        { name: '面具', icon: 'fas fa-smile-beam', specialEffect: 'hide', sound: 'mask-shift' },
                        { name: '堡垒', icon: 'fas fa-castle', specialEffect: 'fortify', sound: 'fortify' },
                        { name: '盔甲', icon: 'fas fa-shield-halved', specialEffect: 'armor', sound: 'metal-clink' }
                    ],
                    type: 'boundary',
                    dynamics: {
                        canEnclose: ['emotion'],
                        protectiveRange: 60,
                        hideEmotions: true
                    }
                },
                'growth': {
                    name: '成长',
                    icon: 'fas fa-seedling',
                    color: '#27AE60',
                    variants: [
                        { name: '种子', icon: 'fas fa-seedling', specialEffect: 'grow', sound: 'sprout', animation: 'growth-animation' },
                        { name: '阶梯', icon: 'fas fa-stairs', specialEffect: 'ascend', sound: 'step-up' },
                        { name: '钥匙', icon: 'fas fa-key', specialEffect: 'unlock', sound: 'unlock' },
                        { name: '蝴蝶', icon: 'fas fa-butterfly', specialEffect: 'transform', sound: 'flutter', animation: 'flutter' },
                        { name: '果实', icon: 'fas fa-apple-whole', specialEffect: 'ripen', sound: 'ripen' },
                        { name: '日出', icon: 'fas fa-sun', specialEffect: 'illuminate', sound: 'dawn' }
                    ],
                    type: 'change',
                    dynamics: {
                        globalEffect: true,
                        sandGlow: true,
                        activateAfterTime: 3000
                    }
                },
                'time': {
                    name: '时间',
                    icon: 'fas fa-clock',
                    color: '#F39C12',
                    variants: [
                        { name: '时钟', icon: 'fas fa-clock', specialEffect: 'tick', sound: 'clock-tick' },
                        { name: '沙漏', icon: 'fas fa-hourglass-half', specialEffect: 'drip', sound: 'sand-drip' },
                        { name: '年轮', icon: 'fas fa-tree-ring', specialEffect: 'circulate', sound: 'cycle' },
                        { name: '脚印', icon: 'fas fa-walking', specialEffect: 'path', sound: 'footstep' },
                        { name: '日历', icon: 'fas fa-calendar', specialEffect: 'turn-page', sound: 'paper-flip' },
                        { name: '月亮', icon: 'fas fa-moon', specialEffect: 'phase', sound: 'night-ambient' }
                    ],
                    type: 'dimension',
                    dynamics: {
                        affectsAll: true,
                        timeProgression: true
                    }
                },
                'conflict': {
                    name: '冲突',
                    icon: 'fas fa-bolt',
                    color: '#E67E22',
                    variants: [
                        { name: '闪电', icon: 'fas fa-bolt', specialEffect: 'shock', sound: 'thunder', animation: 'flash' },
                        { name: '剑', icon: 'fas fa-sword', specialEffect: 'cut', sound: 'sword-clash' },
                        { name: '交叉', icon: 'fas fa-xmark', specialEffect: 'block', sound: 'block' },
                        { name: '火山', icon: 'fas fa-mountain', specialEffect: 'erupt', sound: 'eruption', animation: 'shake' }
                    ],
                    type: 'tension',
                    dynamics: {
                        conflictsWith: ['growth', 'relationship'],
                        intensifyEmotions: true,
                        destructRange: 50
                    }
                },
                'balance': {
                    name: '平衡',
                    icon: 'fas fa-balance-scale',
                    color: '#9B59B6',
                    variants: [
                        { name: '天平', icon: 'fas fa-balance-scale', specialEffect: 'balance', sound: 'level' },
                        { name: '太极', icon: 'fas fa-yin-yang', specialEffect: 'harmony', sound: 'harmony', animation: 'rotate' },
                        { name: '桥梁', icon: 'fas fa-bridge', specialEffect: 'connect', sound: 'bridge' },
                        { name: '星星', icon: 'fas fa-star', specialEffect: 'align', sound: 'align', animation: 'twinkle' }
                    ],
                    type: 'equilibrium',
                    dynamics: {
                        neutralizes: ['conflict'],
                        stabilizes: true,
                        balanceRange: 70
                    }
                },
                'clear': {
                    name: '清除',
                    icon: 'fas fa-trash-alt',
                    color: '#7F8C8D',
                    action: 'clear',
                    sound: 'clear-swish'
                }
            };

            // 创建环形菜单
            function createRadialMenu() {
                const menuItems = Object.keys(sandItemsData);
                const radius = 70; // 菜单项距离中心的半径
                
                menuItems.forEach((key, index) => {
                    const item = sandItemsData[key];
                    const menuItem = document.createElement('div');
                    menuItem.className = 'menu-item';
                    menuItem.dataset.key = key;
                    
                    // 计算菜单项位置
                    const angle = (index / menuItems.length) * 2 * Math.PI;
                    const x = radius * Math.cos(angle);
                    const y = radius * Math.sin(angle);
                    
                    menuItem.style.transform = `translate(${x}px, ${y}px)`;
                    menuItem.innerHTML = `<i class="${item.icon}"></i>`;
                    menuItem.title = item.name;
                    
                    menuItem.addEventListener('click', (e) => {
                        e.stopPropagation();
                        handleMenuItemClick(key, e.clientX, e.clientY);
                    });
                    
                    radialMenu.appendChild(menuItem);
                });
            }

            // 处理菜单项点击
            function handleMenuItemClick(key, x, y) {
                const itemData = sandItemsData[key];
                
                // 处理清除操作
                if (itemData.action === 'clear') {
                    clearSandboxArea(x, y);
                    hideRadialMenu();
                    return;
                }
                
                // 显示变体选择器
                showVariantSelector(key, x, y);
                hideRadialMenu();
            }

            // 显示变体选择器
            function showVariantSelector(category, x, y) {
                const variants = sandItemsData[category].variants;
                
                // 清空现有变体
                variantSelector.innerHTML = '';
                
                // 创建变体选项
                variants.forEach(variant => {
                    const option = document.createElement('div');
                    option.className = 'variant-option';
                    option.innerHTML = `<i class="${variant.icon}"></i>`;
                    option.title = variant.name;
                    
                    option.addEventListener('click', (e) => {
                        e.stopPropagation();
                        placeSandItem(category, variant, x, y);
                        hideVariantSelector();
                    });
                    
                    variantSelector.appendChild(option);
                });
                
                // 定位变体选择器
                const sandboxRect = sandbox.getBoundingClientRect();
                const selectorRect = variantSelector.getBoundingClientRect();
                
                let posX = x - selectorRect.width / 2;
                let posY = y - selectorRect.height / 2;
                
                // 确保选择器在沙箱内
                if (posX < 0) posX = 10;
                if (posX + selectorRect.width > sandboxRect.width) posX = sandboxRect.width - selectorRect.width - 10;
                if (posY < 0) posY = 10;
                if (posY + selectorRect.height > sandboxRect.height) posY = sandboxRect.height - selectorRect.height - 10;
                
                variantSelector.style.left = posX + 'px';
                variantSelector.style.top = posY + 'px';
                
                // 显示选择器
                variantSelector.classList.remove('hidden');
                setTimeout(() => {
                    variantSelector.classList.add('visible');
                }, 10);
            }

            // 放置沙具
            function placeSandItem(category, variant, x, y) {
                const sandboxRect = sandbox.getBoundingClientRect();
                const itemData = sandItemsData[category];
                
                // 创建沙具元素
                const item = document.createElement('div');
                item.className = 'sandbox-item item-place-animation';
                item.dataset.category = category;
                item.dataset.type = itemData.type;
                item.dataset.name = variant.name;
                item.dataset.rotation = '0';
                item.dataset.scale = '1';
                item.dataset.placedAt = Date.now(); // 记录放置时间，用于动画效果
                
                item.innerHTML = `<i class="${variant.icon}" style="font-size: 32px; color: #333;"></i>`;
                
                // 智能定位
                const finalPosition = calculateSmartPosition(x - sandboxRect.left, y - sandboxRect.top, itemData.type);
                
                item.style.left = finalPosition.x + 'px';
                item.style.top = finalPosition.y + 'px';
                
                // 添加点击事件
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showItemControls(item, e.clientX, e.clientY);
                    // 触觉反馈
                    triggerHapticFeedback();
                });
                
                // 初始化拖拽功能
                initDragAndDrop(item);
                
                sandboxItems.appendChild(item);
                itemCount++;
                
                // 播放沙具放置音效
                playSound('place');
                
                // 触觉反馈
                triggerHapticFeedback();
                
                // 检查是否需要显示引导问题
                if (itemCount % 5 === 0) {
                    showGuidingQuestion();
                }
                
                // 检查符号动力学
                checkSymbolDynamics();
                
                // 根据类别添加特殊动画效果
                if (category === 'emotion' || category === 'growth') {
                    setTimeout(() => {
                        updateVisualEffects(item);
                    }, 1000);
                }
                
                // 根据类别添加环境音效
                updateEnvironmentalSounds();
            }

            // 拖拽功能实现
            function initDragAndDrop(item) {
                let isDragging = false;
                let offsetX, offsetY;
                const sandboxRect = sandbox.getBoundingClientRect();
                
                // 开始拖拽的处理函数
                function startDrag(e) {
                    // 阻止冒泡，避免触发点击事件
                    e.stopPropagation();
                    
                    // 如果是触摸事件，使用第一个触摸点
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    
                    // 计算偏移量
                    const itemRect = item.getBoundingClientRect();
                    offsetX = clientX - itemRect.left;
                    offsetY = clientY - itemRect.top;
                    
                    // 设置拖拽状态
                    isDragging = true;
                    item.classList.add('dragging');
                    
                    // 播放拖拽音效
                    playSound('drag');
                    
                    // 触觉反馈
                    triggerHapticFeedback();
                }
                
                // 拖拽移动的处理函数
                function dragMove(e) {
                    if (!isDragging) return;
                    
                    // 阻止默认行为，避免页面滚动
                    e.preventDefault();
                    
                    // 如果是触摸事件，使用第一个触摸点
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    
                    // 计算新位置，考虑偏移量和沙箱边界
                    let newX = clientX - sandboxRect.left - offsetX;
                    let newY = clientY - sandboxRect.top - offsetY;
                    
                    // 边界检查
                    newX = Math.max(0, Math.min(sandboxRect.width - item.offsetWidth, newX));
                    newY = Math.max(0, Math.min(sandboxRect.height - item.offsetHeight, newY));
                    
                    // 更新位置
                    item.style.left = newX + 'px';
                    item.style.top = newY + 'px';
                }
                
                // 结束拖拽的处理函数
                function endDrag() {
                    if (!isDragging) return;
                    
                    isDragging = false;
                    item.classList.remove('dragging');
                    
                    // 播放放置音效
                    playSound('place');
                    
                    // 触觉反馈
                    triggerHapticFeedback();
                    
                    // 检查符号动力学
                    checkSymbolDynamics();
                    
                    // 更新环境音效
                    updateEnvironmentalSounds();
                }
                
                // 添加鼠标事件监听器
                item.addEventListener('mousedown', startDrag);
                document.addEventListener('mousemove', dragMove);
                document.addEventListener('mouseup', endDrag);
                
                // 添加触摸事件监听器（支持移动设备）
                if ('ontouchstart' in window) {
                    item.addEventListener('touchstart', startDrag, { passive: false });
                    document.addEventListener('touchmove', dragMove, { passive: false });
                    document.addEventListener('touchend', endDrag);
                    document.addEventListener('touchcancel', endDrag);
                }
            }
            
            // 智能定位算法 - 优化性能和逻辑
            // 显示通知
        function showNotification(message, type = 'info') {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                background-color: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                color: white;
                border-radius: 4px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                font-size: 14px;
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            
            document.body.appendChild(notification);
            
            // 显示通知
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 10);
            
            // 自动关闭
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }
        
        // 增强版场景列表显示功能
        function showSceneList() {
            // 从localStorage获取场景列表
            const savedScenes = JSON.parse(localStorage.getItem('sandboxScenes') || '[]');
            
            // 如果已经有场景列表面板，先移除
            let sceneListPanel = document.querySelector('.scene-list-panel');
            if (sceneListPanel) {
                sceneListPanel.remove();
            }
            
            // 创建场景列表面板
            sceneListPanel = document.createElement('div');
            sceneListPanel.className = 'scene-list-panel';
            sceneListPanel.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 600px;
                max-width: 95vw;
                max-height: 85vh;
                background: white;
                border-radius: 12px;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                z-index: 999;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            `;
            
            // 添加面板头部
            const header = document.createElement('div');
            header.style.cssText = `
                padding: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 12px 12px 0 0;
                color: white;
                font-weight: bold;
                font-size: 18px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            `;
            header.textContent = '我的沙盘场景';
            
            // 添加关闭按钮
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '×';
            closeBtn.style.cssText = `
                background: rgba(255, 255, 255, 0.2);
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: white;
                padding: 0;
                width: 35px;
                height: 35px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: all 0.3s;
            `;
            closeBtn.onmouseover = () => {
                closeBtn.style.background = 'rgba(255, 255, 255, 0.3)';
                closeBtn.style.transform = 'scale(1.1)';
            };
            closeBtn.onmouseout = () => {
                closeBtn.style.background = 'rgba(255, 255, 255, 0.2)';
                closeBtn.style.transform = 'scale(1)';
            };
            closeBtn.onclick = () => {
                sceneListPanel.remove();
                playSound('click');
            };
            
            header.appendChild(closeBtn);
            sceneListPanel.appendChild(header);
            
            // 添加场景统计信息
            const statsContainer = document.createElement('div');
            statsContainer.style.cssText = `
                padding: 12px 20px;
                background: #f8f9fa;
                border-bottom: 1px solid #e9ecef;
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 14px;
                color: #6c757d;
            `;
            
            const statsText = document.createElement('span');
            statsText.textContent = `共保存 ${savedScenes.length} 个场景`;
            
            const configBtn = document.createElement('button');
            configBtn.textContent = '设置';
            configBtn.style.cssText = `
                background: #6c757d;
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
                transition: background 0.2s;
            `;
            configBtn.onclick = () => {
                showStorageConfig(savedScenes.length);
                playSound('click');
            };
            
            statsContainer.appendChild(statsText);
            statsContainer.appendChild(configBtn);
            sceneListPanel.appendChild(statsContainer);
            
            // 添加场景列表
            const listContainer = document.createElement('div');
            listContainer.style.cssText = `
                padding: 16px;
                max-height: calc(70vh - 80px);
                overflow-y: auto;
            `;
            
            // 添加自定义滚动条样式
            const styleSheet = document.createElement('style');
            styleSheet.textContent = `
                .scene-list-panel::-webkit-scrollbar {
                    width: 6px;
                }
                .scene-list-panel::-webkit-scrollbar-track {
                    background: #f1f1f1;
                    border-radius: 3px;
                }
                .scene-list-panel::-webkit-scrollbar-thumb {
                    background: #c1c1c1;
                    border-radius: 3px;
                }
                .scene-list-panel::-webkit-scrollbar-thumb:hover {
                    background: #a8a8a8;
                }
            `;
            document.head.appendChild(styleSheet);
            
            if (savedScenes.length === 0) {
                const emptyText = document.createElement('div');
                emptyText.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <i class="fas fa-save text-4xl text-gray-300 mb-4"></i>
                        <p style="color: #666; font-size: 16px;">暂无保存的场景</p>
                        <p style="color: #999; font-size: 14px; margin-top: 8px;">创建你的沙盘并保存，记录你的内心世界</p>
                    </div>
                `;
                listContainer.appendChild(emptyText);
            } else {
                // 按时间倒序排序（最新的在前）
                savedScenes.sort((a, b) => b.timestamp - a.timestamp);
                
                savedScenes.forEach((scene, index) => {
                    const sceneItem = document.createElement('div');
                    sceneItem.style.cssText = `
                        padding: 16px;
                        margin-bottom: 12px;
                        background: white;
                        border-radius: 8px;
                        cursor: pointer;
                        transition: all 0.3s;
                        border: 1px solid #e9ecef;
                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                    `;
                    sceneItem.onmouseover = () => {
                        sceneItem.style.background = '#f8f9fa';
                        sceneItem.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.1)';
                        sceneItem.style.transform = 'translateY(-2px)';
                    };
                    sceneItem.onmouseout = () => {
                        sceneItem.style.background = 'white';
                        sceneItem.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.05)';
                        sceneItem.style.transform = 'translateY(0)';
                    };
                    
                    // 场景头部信息
                    const headerContainer = document.createElement('div');
                    headerContainer.style.cssText = 'display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;';
                    
                    // 左侧信息
                    const leftInfo = document.createElement('div');
                    
                    const sceneName = document.createElement('div');
                    sceneName.textContent = scene.name;
                    sceneName.style.cssText = 'font-weight: 600; font-size: 16px; margin-bottom: 4px; color: #333;';
                    
                    // 场景标签 - 基于情绪主题
                    const tagsContainer = document.createElement('div');
                    tagsContainer.style.cssText = 'display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 6px;';
                    
                    if (scene.emotionThemes && scene.emotionThemes.length > 0) {
                        scene.emotionThemes.forEach(theme => {
                            const tag = document.createElement('span');
                            tag.textContent = theme;
                            tag.style.cssText = `
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white;
                                padding: 2px 8px;
                                border-radius: 12px;
                                font-size: 11px;
                                font-weight: 500;
                            `;
                            tagsContainer.appendChild(tag);
                        });
                    }
                    
                    const sceneMeta = document.createElement('div');
                    const dateStr = new Date(scene.timestamp).toLocaleString();
                    const modifiedStr = scene.lastModified && scene.lastModified !== scene.timestamp 
                        ? `，修改于 ${new Date(scene.lastModified).toLocaleString()}` 
                        : '';
                    sceneMeta.textContent = `${scene.itemCount} 个沙具 | 创建于 ${dateStr}${modifiedStr}`;
                    sceneMeta.style.cssText = 'font-size: 12px; color: #666;';
                    
                    leftInfo.appendChild(sceneName);
                    leftInfo.appendChild(tagsContainer);
                    leftInfo.appendChild(sceneMeta);
                    
                    // 右侧操作按钮
                    const actionsContainer = document.createElement('div');
                    actionsContainer.style.cssText = 'display: flex; gap: 6px;';
                    
                    // 查看详情按钮
                    const detailsBtn = document.createElement('button');
                    detailsBtn.innerHTML = '<i class="fas fa-eye"></i>';
                    detailsBtn.title = '查看详情';
                    detailsBtn.style.cssText = `
                        background: #17a2b8;
                        color: white;
                        border: none;
                        padding: 6px 8px;
                        border-radius: 4px;
                        cursor: pointer;
                        transition: background 0.2s;
                        font-size: 14px;
                    `;
                    detailsBtn.onclick = (e) => {
                        e.stopPropagation();
                        showSceneDetails(scene);
                        playSound('click');
                    };
                    
                    // 编辑名称按钮
                    const editBtn = document.createElement('button');
                    editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                    editBtn.title = '编辑名称';
                    editBtn.style.cssText = `
                        background: #ffc107;
                        color: #333;
                        border: none;
                        padding: 6px 8px;
                        border-radius: 4px;
                        cursor: pointer;
                        transition: background 0.2s;
                        font-size: 14px;
                    `;
                    editBtn.onclick = (e) => {
                        e.stopPropagation();
                        editSceneName(scene, index);
                        playSound('click');
                    };
                    
                    // 删除按钮
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    deleteBtn.title = '删除场景';
                    deleteBtn.style.cssText = `
                        background: #dc3545;
                        color: white;
                        border: none;
                        padding: 6px 8px;
                        border-radius: 4px;
                        cursor: pointer;
                        transition: background 0.2s;
                        font-size: 14px;
                    `;
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteScene(scene.id || index, index);
                        playSound('click');
                    };
                    
                    actionsContainer.appendChild(detailsBtn);
                    actionsContainer.appendChild(editBtn);
                    actionsContainer.appendChild(deleteBtn);
                    
                    headerContainer.appendChild(leftInfo);
                    headerContainer.appendChild(actionsContainer);
                    
                    // 沙具类型统计
                    if (scene.types && scene.types.length > 0) {
                        const typesContainer = document.createElement('div');
                        typesContainer.style.cssText = 'margin-top: 8px; padding-top: 8px; border-top: 1px solid #e9ecef;';
                        
                        const typesLabel = document.createElement('span');
                        typesLabel.textContent = '包含元素类型：';
                        typesLabel.style.cssText = 'font-size: 12px; color: #666; margin-right: 8px;';
                        
                        const typeTagsContainer = document.createElement('span');
                        typeTagsContainer.style.cssText = 'display: inline-flex; gap: 4px;';
                        
                        // 类型映射为友好名称
                        const typeMap = {
                            'character': '角色',
                            'connection': '连接',
                            'boundary': '边界',
                            'abstract': '情感',
                            'change': '成长',
                            'space': '环境',
                            'dimension': '时间'
                        };
                        
                        scene.types.forEach(type => {
                            const typeTag = document.createElement('span');
                            typeTag.textContent = typeMap[type] || type;
                            typeTag.style.cssText = `
                                background: #e9ecef;
                                color: #495057;
                                padding: 1px 6px;
                                border-radius: 10px;
                                font-size: 10px;
                            `;
                            typeTagsContainer.appendChild(typeTag);
                        });
                        
                        typesContainer.appendChild(typesLabel);
                        typesContainer.appendChild(typeTagsContainer);
                        sceneItem.appendChild(typesContainer);
                    }
                    
                    // 加载按钮
                    const loadBtn = document.createElement('button');
                    loadBtn.textContent = '加载场景';
                    loadBtn.style.cssText = `
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: 500;
                        margin-top: 12px;
                        transition: all 0.3s;
                        width: 100%;
                    `;
                    loadBtn.onmouseover = () => {
                        loadBtn.style.transform = 'translateY(-1px)';
                        loadBtn.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.4)';
                    };
                    loadBtn.onmouseout = () => {
                        loadBtn.style.transform = 'translateY(0)';
                        loadBtn.style.boxShadow = 'none';
                    };
                    loadBtn.onclick = (e) => {
                        e.stopPropagation();
                        loadScene(scene);
                        sceneListPanel.remove();
                        playSound('click');
                    };
                    
                    sceneItem.appendChild(headerContainer);
                    sceneItem.appendChild(loadBtn);
                    listContainer.appendChild(sceneItem);
                });
            }
            
            sceneListPanel.appendChild(listContainer);
            document.body.appendChild(sceneListPanel);
        }
        
        // 显示场景详情
        function showSceneDetails(scene) {
            const detailsPanel = document.createElement('div');
            detailsPanel.className = 'scene-details-panel';
            detailsPanel.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 500px;
                max-width: 90vw;
                max-height: 80vh;
                background: white;
                border-radius: 12px;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                z-index: 1000;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            `;
            
            // 面板头部
            const header = document.createElement('div');
            header.style.cssText = `
                padding: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 12px 12px 0 0;
                color: white;
                font-weight: bold;
                font-size: 18px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            `;
            header.textContent = '场景详情';
            
            // 关闭按钮
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '×';
            closeBtn.style.cssText = `
                background: rgba(255, 255, 255, 0.2);
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: white;
                padding: 0;
                width: 35px;
                height: 35px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: all 0.3s;
            `;
            closeBtn.onclick = () => {
                detailsPanel.remove();
            };
            
            header.appendChild(closeBtn);
            detailsPanel.appendChild(header);
            
            // 详情内容
            const content = document.createElement('div');
            content.style.cssText = `
                padding: 20px;
                overflow-y: auto;
                max-height: calc(80vh - 120px);
            `;
            
            // 场景信息卡片
            const infoCard = document.createElement('div');
            infoCard.style.cssText = 'margin-bottom: 20px;';
            
            // 场景名称
            const nameSection = document.createElement('div');
            nameSection.innerHTML = `
                <div style="font-size: 14px; color: #666; margin-bottom: 4px;">场景名称</div>
                <div style="font-size: 20px; font-weight: bold; color: #333;">${scene.name}</div>
            `;
            
            // 统计信息
            const statsSection = document.createElement('div');
            statsSection.style.cssText = 'margin-top: 20px;';
            
            const statsGrid = document.createElement('div');
            statsGrid.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 12px;';
            
            // 沙具数量
            const itemCountStat = document.createElement('div');
            itemCountStat.style.cssText = 'padding: 12px; background: #f8f9fa; border-radius: 8px;';
            itemCountStat.innerHTML = `
                <div style="font-size: 12px; color: #666; margin-bottom: 4px;">沙具数量</div>
                <div style="font-size: 24px; font-weight: bold; color: #667eea;">${scene.itemCount}</div>
            `;
            
            // 元素类型数量
            const typesCountStat = document.createElement('div');
            const typesCount = scene.types ? scene.types.length : 0;
            typesCountStat.style.cssText = 'padding: 12px; background: #f8f9fa; border-radius: 8px;';
            typesCountStat.innerHTML = `
                <div style="font-size: 12px; color: #666; margin-bottom: 4px;">元素类型</div>
                <div style="font-size: 24px; font-weight: bold; color: #764ba2;">${typesCount}</div>
            `;
            
            statsGrid.appendChild(itemCountStat);
            statsGrid.appendChild(typesCountStat);
            
            // 时间信息
            const timeInfo = document.createElement('div');
            timeInfo.style.cssText = 'margin-top: 16px;';
            timeInfo.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="font-size: 14px; color: #666;">创建时间：</span>
                    <span style="font-size: 14px; color: #333;">${new Date(scene.timestamp).toLocaleString()}</span>
                </div>
            `;
            
            if (scene.lastModified && scene.lastModified !== scene.timestamp) {
                timeInfo.innerHTML += `
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 14px; color: #666;">最后修改：</span>
                        <span style="font-size: 14px; color: #333;">${new Date(scene.lastModified).toLocaleString()}</span>
                    </div>
                `;
            }
            
            // 会话时长
            if (scene.sessionDuration) {
                const durationMinutes = Math.round(scene.sessionDuration / 60000);
                timeInfo.innerHTML += `
                    <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                        <span style="font-size: 14px; color: #666;">创作时长：</span>
                        <span style="font-size: 14px; color: #333;">约 ${durationMinutes} 分钟</span>
                    </div>
                `;
            }
            
            // 情绪主题
            if (scene.emotionThemes && scene.emotionThemes.length > 0) {
                const themesSection = document.createElement('div');
                themesSection.style.cssText = 'margin-top: 20px;';
                themesSection.innerHTML = `
                    <div style="font-size: 14px; color: #666; margin-bottom: 10px;">情绪主题</div>
                `;
                
                const themesContainer = document.createElement('div');
                themesContainer.style.cssText = 'display: flex; gap: 8px; flex-wrap: wrap;';
                
                scene.emotionThemes.forEach(theme => {
                    const themeTag = document.createElement('span');
                    themeTag.textContent = theme;
                    themeTag.style.cssText = `
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        padding: 6px 12px;
                        border-radius: 16px;
                        font-size: 13px;
                        font-weight: 500;
                    `;
                    themesContainer.appendChild(themeTag);
                });
                
                themesSection.appendChild(themesContainer);
                infoCard.appendChild(themesSection);
            }
            
            // 组装信息卡片
            infoCard.appendChild(nameSection);
            infoCard.appendChild(statsSection);
            infoCard.appendChild(timeInfo);
            
            content.appendChild(infoCard);
            
            // 添加加载按钮
            const loadBtn = document.createElement('button');
            loadBtn.textContent = '加载此场景';
            loadBtn.style.cssText = `
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 16px;
                font-weight: 500;
                width: 100%;
                transition: all 0.3s;
            `;
            loadBtn.onmouseover = () => {
                loadBtn.style.transform = 'translateY(-2px)';
                loadBtn.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.4)';
            };
            loadBtn.onmouseout = () => {
                loadBtn.style.transform = 'translateY(0)';
                loadBtn.style.boxShadow = 'none';
            };
            loadBtn.onclick = () => {
                loadScene(scene);
                detailsPanel.remove();
            };
            
            content.appendChild(loadBtn);
            detailsPanel.appendChild(content);
            document.body.appendChild(detailsPanel);
        }
        
        // 编辑场景名称
        function editSceneName(scene, index) {
            const newName = prompt('请输入新的场景名称:', scene.name);
            
            if (newName === null) return; // 用户取消
            
            const trimmedName = newName.trim();
            if (!trimmedName) return; // 名称不能为空
            
            // 获取所有场景
            const savedScenes = JSON.parse(localStorage.getItem('sandboxScenes') || '[]');
            
            // 更新场景名称和修改时间
            savedScenes[index].name = trimmedName;
            savedScenes[index].lastModified = Date.now();
            
            // 保存回localStorage
            localStorage.setItem('sandboxScenes', JSON.stringify(savedScenes));
            
            // 刷新场景列表
            const listPanel = document.querySelector('.scene-list-panel');
            if (listPanel) {
                listPanel.remove();
                showSceneList();
            }
            
            showNotification(`场景名称已更新为 "${trimmedName}"`, 'success');
        }
        
        // 删除场景
        function deleteScene(sceneId, index) {
            if (!confirm('确定要删除这个场景吗？此操作无法撤销。')) {
                return;
            }
            
            // 获取所有场景
            const savedScenes = JSON.parse(localStorage.getItem('sandboxScenes') || '[]');
            
            // 删除指定场景
            savedScenes.splice(index, 1);
            
            // 保存回localStorage
            localStorage.setItem('sandboxScenes', JSON.stringify(savedScenes));
            
            // 刷新场景列表
            const listPanel = document.querySelector('.scene-list-panel');
            if (listPanel) {
                listPanel.remove();
                showSceneList();
            }
            
            showNotification('场景已成功删除', 'success');
        }
        
        // 显示存储配置
        function showStorageConfig(currentCount) {
            const configPanel = document.createElement('div');
            configPanel.className = 'storage-config-panel';
            configPanel.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 400px;
                max-width: 90vw;
                background: white;
                border-radius: 12px;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                z-index: 1000;
                overflow: hidden;
            `;
            
            // 面板内容
            configPanel.innerHTML = `
                <div style="padding: 20px; border-bottom: 1px solid #e9ecef; background: #f8f9fa; border-radius: 12px 12px 0 0;">
                    <h3 style="margin: 0; color: #333; font-size: 18px;">存储设置</h3>
                </div>
                <div style="padding: 20px;">
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">最大保存场景数</div>
                        <input 
                            type="range" 
                            min="5" 
                            max="30" 
                            value="${parseInt(localStorage.getItem('maxSavedScenes')) || 15}" 
                            id="max-scenes-slider"
                            style="width: 100%; margin-bottom: 8px;"
                        >
                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                            <span>5</span>
                            <span id="current-max-value">${parseInt(localStorage.getItem('maxSavedScenes')) || 15}</span>
                            <span>30</span>
                        </div>
                        <div style="font-size: 12px; color: #999; margin-top: 8px;">
                            当前已保存: ${currentCount} 个场景
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button id="clear-all-btn" style="
                            background: #dc3545;
                            color: white;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 14px;
                            width: 100%;
                            transition: background 0.3s;
                        ">清空所有保存的场景</button>
                    </div>
                </div>
                <div style="padding: 16px; background: #f8f9fa; border-radius: 0 0 12px 12px; text-align: right;">
                    <button id="save-config-btn" style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        padding: 8px 20px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: 500;
                        transition: all 0.3s;
                    ">保存设置</button>
                </div>
            `;
            
            // 获取元素引用
            const slider = configPanel.querySelector('#max-scenes-slider');
            const valueDisplay = configPanel.querySelector('#current-max-value');
            const saveBtn = configPanel.querySelector('#save-config-btn');
            const clearBtn = configPanel.querySelector('#clear-all-btn');
            
            // 滑块事件
            slider.addEventListener('input', () => {
                valueDisplay.textContent = slider.value;
            });
            
            // 保存按钮事件
            saveBtn.addEventListener('click', () => {
                localStorage.setItem('maxSavedScenes', slider.value);
                
                // 如果当前场景数量超过新限制，进行清理
                const savedScenes = JSON.parse(localStorage.getItem('sandboxScenes') || '[]');
                const maxScenes = parseInt(slider.value);
                
                if (savedScenes.length > maxScenes) {
                    const removedCount = savedScenes.length - maxScenes;
                    savedScenes.splice(maxScenes);
                    localStorage.setItem('sandboxScenes', JSON.stringify(savedScenes));
                    showNotification(`已调整保存数量上限为 ${maxScenes}，并删除了 ${removedCount} 个最旧的场景`, 'success');
                } else {
                    showNotification('存储设置已保存', 'success');
                }
                
                // 关闭面板
                configPanel.remove();
            });
            
            // 清空按钮事件
            clearBtn.addEventListener('click', () => {
                if (confirm('确定要清空所有保存的场景吗？此操作无法撤销！')) {
                    localStorage.removeItem('sandboxScenes');
                    showNotification('所有场景已清空', 'success');
                    
                    // 关闭面板
                    configPanel.remove();
                    
                    // 如果场景列表打开，刷新它
                    const listPanel = document.querySelector('.scene-list-panel');
                    if (listPanel) {
                        listPanel.remove();
                        showSceneList();
                    }
                }
            });
            
            document.body.appendChild(configPanel);
        }
        
        // 加载场景
        function loadScene(scene) {
            // 清空现有沙具
            const sandboxItems = document.querySelector('.sandbox-items');
            const existingItems = sandboxItems.querySelectorAll('.sandbox-item');
            existingItems.forEach(item => {
                sandboxItems.removeChild(item);
            });
            
            // 重建沙具
            scene.data.forEach(itemData => {
                const item = document.createElement('div');
                item.className = 'sandbox-item';
                item.dataset.category = itemData.category;
                item.dataset.type = itemData.type;
                item.dataset.name = itemData.name;
                item.dataset.rotation = itemData.rotation || '0';
                item.dataset.scale = itemData.scale || '1';
                item.style.left = itemData.left;
                item.style.top = itemData.top;
                
                // 应用旋转和缩放
                item.style.transform = `translate(-50%, -50%) rotate(${itemData.rotation}deg) scale(${itemData.scale})`;
                
                // 添加图标
                const icon = document.createElement('i');
                icon.className = itemData.icon;
                item.appendChild(icon);
                
                // 初始化拖拽功能
                initDragAndDrop(item);
                
                // 添加到沙盒
                sandboxItems.appendChild(item);
            });
            
            showNotification(`场景 "${scene.name}" 加载成功！`, 'success');
            
            // 播放加载音效
            playSound('loadScene');
            
            // 更新环境音效
            updateEnvironmentalSounds();
        }
        
        function calculateSmartPosition(x, y, itemType) {
                const sandboxRect = sandbox.getBoundingClientRect();
                const waterArea = document.getElementById('water-area');
                
                // 检查waterArea是否存在
                let isWaterArea = false;
                let waterTop = 0;
                
                if (waterArea) {
                    const waterRect = waterArea.getBoundingClientRect();
                    waterTop = waterRect.top - sandboxRect.top;
                    isWaterArea = y > waterTop;
                }
                
                let finalX = x;
                let finalY = y;
                
                // 特殊处理：根据类型和水域位置调整
                if (itemType === 'connection' && !isWaterArea && waterArea) {
                    // 桥梁等连接符号放在水面附近
                    finalY = waterTop + 10;
                } else if (itemType === 'space') {
                    // 环境符号适当避开水域
                    if (isWaterArea) {
                        finalY = waterTop - 20;
                    }
                }
                
                // 检查与其他沙具的距离，避免重叠 - 优化性能
                const existingItems = document.querySelectorAll('.sandbox-item');
                const minDistance = 50;
                let hasCollision = false;
                
                // 先检查是否有碰撞，有碰撞才执行推开逻辑
                for (let i = 0; i < existingItems.length; i++) {
                    const item = existingItems[i];
                    const itemRect = item.getBoundingClientRect();
                    const itemX = (itemRect.left + itemRect.right) / 2 - sandboxRect.left;
                    const itemY = (itemRect.top + itemRect.bottom) / 2 - sandboxRect.top;
                    
                    const distance = Math.sqrt(Math.pow(finalX - itemX, 2) + Math.pow(finalY - itemY, 2));
                    
                    if (distance < minDistance) {
                        // 计算推开方向
                        const angle = Math.atan2(finalY - itemY, finalX - itemX);
                        const pushDistance = minDistance - distance;
                        
                        finalX += Math.cos(angle) * pushDistance;
                        finalY += Math.sin(angle) * pushDistance;
                        hasCollision = true;
                    }
                }
                
                // 如果有碰撞，再次检查是否还有重叠（简化处理）
                if (hasCollision) {
                    // 微调位置，避免多次重叠检查
                    finalX += (Math.random() - 0.5) * 20;
                    finalY += (Math.random() - 0.5) * 20;
                }
                
                // 确保在沙箱边界内
                finalX = Math.max(20, Math.min(sandboxRect.width - 20, finalX));
                finalY = Math.max(20, Math.min(sandboxRect.height - 20, finalY));
                
                return { x: finalX, y: finalY };
            }

            // 显示沙具功能盘
            function showItemControls(item, x, y) {
                currentItem = item;
                
                // 定位功能盘
                const sandboxRect = sandbox.getBoundingClientRect();
                const controlsRect = itemControls.getBoundingClientRect();
                
                let posX = x - controlsRect.width / 2;
                let posY = y - controlsRect.height / 2;
                
                itemControls.style.left = posX + 'px';
                itemControls.style.top = posY + 'px';
                
                // 计算控制按钮位置
                const controlButtons = itemControls.querySelectorAll('.control-btn');
                const radius = 40;
                
                controlButtons.forEach((btn, index) => {
                    const angle = (index / controlButtons.length) * 2 * Math.PI;
                    const btnX = radius * Math.cos(angle);
                    const btnY = radius * Math.sin(angle);
                    
                    btn.style.transform = `translate(${btnX}px, ${btnY}px)`;
                });
                
                // 绑定控制按钮事件
                document.querySelector('.rotate-btn').onclick = rotateItem;
                document.querySelector('.duplicate-btn').onclick = duplicateItem;
                document.querySelector('.scale-btn').onclick = scaleItem;
                document.querySelector('.remove-btn').onclick = removeItem;
                
                // 显示功能盘
                itemControls.classList.remove('hidden');
                setTimeout(() => {
                    itemControls.classList.add('visible');
                }, 10);
            }

            // 旋转沙具
            function rotateItem() {
                if (!currentItem) return;
                
                const currentRotation = parseInt(currentItem.dataset.rotation);
                const newRotation = (currentRotation + 45) % 360;
                currentItem.dataset.rotation = newRotation;
                currentItem.style.transform = `rotate(${newRotation}deg) scale(${currentItem.dataset.scale})`;
                
                // 播放旋转音效（模拟）
                playSound('click');
            }

            // 复制沙具
            function duplicateItem() {
                if (!currentItem) return;
                
                const sandboxRect = sandbox.getBoundingClientRect();
                const itemRect = currentItem.getBoundingClientRect();
                
                // 获取原沙具数据
                const category = currentItem.dataset.category;
                const variantName = currentItem.dataset.name;
                const variant = sandItemsData[category].variants.find(v => v.name === variantName);
                
                // 在原位置附近创建新沙具
                const newX = itemRect.left + itemRect.width + 20;
                const newY = itemRect.top;
                
                placeSandItem(category, variant, newX, newY);
                hideItemControls();
            }

            // 缩放沙具
            function scaleItem() {
                if (!currentItem) return;
                
                const currentScale = parseFloat(currentItem.dataset.scale);
                const newScale = currentScale === 1 ? 1.2 : currentScale === 1.2 ? 0.8 : 1;
                currentItem.dataset.scale = newScale;
                currentItem.style.transform = `rotate(${currentItem.dataset.rotation}deg) scale(${newScale})`;
            }

            // 删除沙具
            function removeItem() {
                if (!currentItem) return;
                
                // 添加移除动画
                currentItem.classList.add('item-remove-animation');
                
                // 动画结束后移除元素
                setTimeout(() => {
                    currentItem.remove();
                    itemCount--;
                }, 500);
                
                hideItemControls();
            }

            // 清除沙箱区域
            function clearSandboxArea(x, y) {
                const sandboxRect = sandbox.getBoundingClientRect();
                const items = document.querySelectorAll('.sandbox-item');
                
                items.forEach(item => {
                    const itemRect = item.getBoundingClientRect();
                    const itemCenterX = itemRect.left + itemRect.width / 2;
                    const itemCenterY = itemRect.top + itemRect.height / 2;
                    
                    const distance = Math.sqrt(Math.pow(x - itemCenterX, 2) + Math.pow(y - itemCenterY, 2));
                    
                    // 如果沙具在点击位置附近50px范围内
                    if (distance < 50) {
                        removeItemFromDOM(item);
                    }
                });
            }

            // 从DOM中移除沙具
            function removeItemFromDOM(item) {
                item.classList.add('item-remove-animation');
                setTimeout(() => {
                    item.remove();
                    itemCount--;
                }, 500);
            }

            // 符号动力学检查函数 - 性能优化版
            function checkSymbolDynamics() {
                // 移除旧的连接线和效果
                const oldLines = document.querySelectorAll('.connection-line');
                for (let i = 0; i < oldLines.length; i++) {
                    oldLines[i].remove();
                }
                
                // 清除所有符号的特殊状态
                const items = document.querySelectorAll('.sandbox-item');
                items.forEach(item => {
                    item.classList.remove('highlighted', 'influenced', 'connected', 'protected', 'repelled', 'balanced');
                    item.style.opacity = '1';
                    item.style.filter = 'grayscale(0%)';
                    item.style.boxShadow = '';
                    item.style.transition = 'all 0.3s ease';
                });
                
                // 分类符号
                const selfItems = Array.from(items).filter(item => item.dataset.type === 'character');
                const relationshipItems = Array.from(items).filter(item => item.dataset.type === 'connection');
                const defenseItems = Array.from(items).filter(item => item.dataset.type === 'boundary');
                const emotionItems = Array.from(items).filter(item => item.dataset.type === 'abstract');
                const growthItems = Array.from(items).filter(item => item.dataset.type === 'change');
                const environmentItems = Array.from(items).filter(item => item.dataset.type === 'space');
                const timeItems = Array.from(items).filter(item => item.dataset.type === 'dimension');
                
                // 1. 自我与关系符号连接 - 增强版
                if (selfItems.length > 0 && relationshipItems.length > 0) {
                    selfItems.forEach(selfItem => {
                        // 获取最近的关系符号
                        const distances = relationshipItems.map(relItem => {
                            const positions = getRelativePositions(selfItem, relItem);
                            return {
                                ...positions,
                                distance: positions.distance,
                                item: relItem
                            };
                        });
                        
                        distances.sort((a, b) => a.distance - b.distance);
                        const closestRelations = distances.slice(0, 5); // 增加到5个连接
                        
                        closestRelations.forEach(data => {
                            if (data.distance < 250) { // 增加连接距离范围
                                // 根据距离设置连接强度和样式
                                const connectionStrength = 1 - (data.distance / 250);
                                const lineColor = data.distance < 150 ? '#4CAF50' : '#2196F3';
                                const lineWidth = Math.max(1, connectionStrength * 3);
                                
                                createConnectionLine(
                                    data.selfX, data.selfY, 
                                    data.relX, data.relY, 
                                    data.distance,
                                    lineColor,
                                    lineWidth,
                                    data.distance < 100 ? 'pulse' : 'static' // 添加脉冲动画效果
                                );
                                
                                // 高亮连接的符号
                                selfItem.classList.add('connected');
                                data.item.classList.add('connected');
                                
                                // 添加发光效果
                                const glowIntensity = Math.min(1, 1.5 - data.distance / 150);
                                selfItem.style.boxShadow = `0 0 ${10 * glowIntensity}px rgba(76, 175, 80, ${glowIntensity})`;
                                data.item.style.boxShadow = `0 0 ${10 * glowIntensity}px rgba(76, 175, 80, ${glowIntensity})`;
                            }
                        });
                    });
                }
                
                // 2. 情绪符号表现力增强
                emotionItems.forEach(emotionItem => {
                    let isSuppressed = false;
                    let isSupported = false;
                    let closeDefenseCount = 0;
                    let closeGrowthCount = 0;
                    
                    // 防御符号检查
                    if (defenseItems.length > 0) {
                        closeDefenseCount = defenseItems.filter(defenseItem => {
                            const positions = getRelativePositions(emotionItem, defenseItem);
                            return positions.distance < 150;
                        }).length;
                    }
                    
                    // 成长符号支持检查
                    if (growthItems.length > 0) {
                        closeGrowthCount = growthItems.filter(growthItem => {
                            const positions = getRelativePositions(emotionItem, growthItem);
                            return positions.distance < 150;
                        }).length;
                    }
                    
                    isSuppressed = closeDefenseCount >= 2;
                    isSupported = closeGrowthCount >= 1;
                    
                    // 应用情绪表达效果
                    if (isSuppressed && !isSupported) {
                        emotionItem.classList.add('suppressed');
                        emotionItem.style.opacity = '0.3';
                        emotionItem.style.filter = 'grayscale(80%)';
                        emotionItem.style.transform = 'scale(0.9)';
                    } else if (isSupported && !isSuppressed) {
                        emotionItem.classList.add('highlighted');
                        emotionItem.style.opacity = '1';
                        emotionItem.style.transform = 'scale(1.1)';
                        emotionItem.style.boxShadow = '0 0 20px rgba(255, 193, 7, 0.6)';
                        emotionItem.style.filter = 'brightness(1.2)';
                    } else if (isSuppressed && isSupported) {
                        // 矛盾状态 - 平衡效果
                        emotionItem.classList.add('balanced');
                        emotionItem.style.opacity = '0.8';
                        emotionItem.style.transform = 'scale(1)';
                        emotionItem.style.boxShadow = '0 0 10px rgba(156, 39, 176, 0.5)';
                    }
                });
                
                // 3. 成长与环境符号的交互
                if (growthItems.length > 0 && environmentItems.length > 0) {
                    environmentItems.forEach(envItem => {
                        const nearbyGrowth = growthItems.filter(growthItem => {
                            const positions = getRelativePositions(envItem, growthItem);
                            return positions.distance < 200;
                        });
                        
                        if (nearbyGrowth.length > 0) {
                            // 环境促进成长的效果
                            envItem.classList.add('influenced');
                            nearbyGrowth.forEach(growthItem => {
                                growthItem.classList.add('highlighted');
                                
                                // 添加绿色连接线表示滋养关系
                                const positions = getRelativePositions(envItem, growthItem);
                                createConnectionLine(
                                    positions.selfX, positions.selfY,
                                    positions.relX, positions.relY,
                                    positions.distance,
                                    '#8BC34A',
                                    1.5,
                                    'flow' // 流动动画效果
                                );
                            });
                        }
                    });
                }
                
                // 4. 时间符号的特殊效果
                if (timeItems.length > 0) {
                    timeItems.forEach(timeItem => {
                        // 时间符号影响周围的所有符号
                        const nearbyItems = items.filter(item => {
                            if (item === timeItem) return false;
                            const positions = getRelativePositions(timeItem, item);
                            return positions.distance < 250;
                        });
                        
                        if (nearbyItems.length > 0) {
                            timeItem.classList.add('highlighted');
                            timeItem.style.boxShadow = '0 0 25px rgba(3, 169, 244, 0.7)';
                            
                            // 为时间符号添加旋转动画
                            timeItem.style.transition = 'transform 5s linear infinite';
                            timeItem.style.transform = 'translate(-50%, -50%) rotate(360deg)';
                            
                            // 为附近的符号添加微妙的脉动效果
                            nearbyItems.forEach(item => {
                                item.classList.add('influenced');
                                item.style.animation = 'pulse 3s ease-in-out infinite';
                            });
                        }
                    });
                }
                
                // 5. 符号间排斥效果 - 防止过度拥挤
                applyRepulsionEffect(items);
                
                // 6. 整体环境效果优化
                updateOverallEnvironment(selfItems, relationshipItems, growthItems, environmentItems);
                
                // 7. 五感模拟 - 视觉变化效果
                updateVisualEffects(items);
                
                // 8. 五感模拟 - 环境音效管理
                updateEnvironmentalSounds(environmentItems, relationshipItems, emotionItems, growthItems);
            }
            
            // 辅助函数：获取两个元素的相对位置
            function getRelativePositions(selfElement, relElement) {
                const selfRect = selfElement.getBoundingClientRect();
                const relRect = relElement.getBoundingClientRect();
                const sandboxRect = sandbox.getBoundingClientRect();
                
                const selfX = (selfRect.left + selfRect.right) / 2 - sandboxRect.left;
                const selfY = (selfRect.top + selfRect.bottom) / 2 - sandboxRect.top;
                const relX = (relRect.left + relRect.right) / 2 - sandboxRect.left;
                const relY = (relRect.top + relRect.bottom) / 2 - sandboxRect.top;
                
                const distance = Math.sqrt(Math.pow(selfX - relX, 2) + Math.pow(selfY - relY, 2));
                
                return { selfX, selfY, relX, relY, distance };
            }
            
            // 辅助函数：应用符号间排斥效果
            function applyRepulsionEffect(items) {
                // 仅在元素数量较多时应用，避免性能问题
                if (items.length < 5) return;
                
                const repulsionThreshold = 80; // 排斥阈值距离
                
                for (let i = 0; i < items.length; i++) {
                    for (let j = i + 1; j < items.length; j++) {
                        const item1 = items[i];
                        const item2 = items[j];
                        
                        const positions = getRelativePositions(item1, item2);
                        
                        // 如果元素太接近，应用排斥视觉效果
                        if (positions.distance < repulsionThreshold) {
                            const repulsionIntensity = 1 - (positions.distance / repulsionThreshold);
                            
                            // 添加红色边框表示排斥
                            item1.style.boxShadow = `0 0 5px ${Math.min(2, repulsionIntensity * 5)}px rgba(244, 67, 54, 0.7)`;
                            item2.style.boxShadow = `0 0 5px ${Math.min(2, repulsionIntensity * 5)}px rgba(244, 67, 54, 0.7)`;
                            
                            // 添加微小的移动效果（通过transform实现视觉感知）
                            const angle = Math.atan2(positions.relY - positions.selfY, positions.relX - positions.selfX);
                            const pushDistance = repulsionIntensity * 5;
                            
                            // 注意：这里不实际改变位置，只添加视觉效果
                            // 实际移动应在拖拽时处理
                            item1.dataset.repulsionX = (-Math.cos(angle) * pushDistance).toString();
                            item1.dataset.repulsionY = (-Math.sin(angle) * pushDistance).toString();
                            item2.dataset.repulsionX = (Math.cos(angle) * pushDistance).toString();
                            item2.dataset.repulsionY = (Math.sin(angle) * pushDistance).toString();
                            
                            item1.classList.add('repelled');
                            item2.classList.add('repelled');
                        }
                    }
                }
            }
            
            // 辅助函数：更新整体环境效果
            function updateOverallEnvironment(selfItems, relationshipItems, growthItems, environmentItems) {
                // 重置环境效果
                sandbox.classList.remove('growth-environment', 'connection-rich', 'balanced-environment', 'isolated-environment');
                
                // 基于符号组合应用不同的环境主题
                if (growthItems.length >= 3 && environmentItems.length >= 2) {
                    sandbox.classList.add('growth-environment');
                    sandbox.classList.add('glowing');
                    sandbox.style.background = 'linear-gradient(135deg, rgba(76, 175, 80, 0.05), rgba(139, 195, 74, 0.05))';
                }
                
                if (relationshipItems.length >= 4 && selfItems.length >= 1) {
                    sandbox.classList.add('connection-rich');
                    sandbox.style.background = 'linear-gradient(135deg, rgba(33, 150, 243, 0.05), rgba(2, 136, 209, 0.05))';
                }
                
                // 平衡环境
                const totalItems = selfItems.length + relationshipItems.length + growthItems.length + environmentItems.length;
                const diversityScore = [selfItems, relationshipItems, growthItems, environmentItems]
                    .filter(category => category.length > 0).length;
                
                if (totalItems >= 8 && diversityScore >= 3) {
                    sandbox.classList.add('balanced-environment');
                    sandbox.style.boxShadow = 'inset 0 0 100px rgba(156, 39, 176, 0.1)';
                }
                
                // 孤立环境 - 当只有自我符号或极少其他符号时
                if (selfItems.length === 1 && totalItems <= 3) {
                    sandbox.classList.add('isolated-environment');
                    sandbox.style.background = 'linear-gradient(135deg, rgba(158, 158, 158, 0.05), rgba(117, 117, 117, 0.05))';
                }
            }
            
            // 五感模拟 - 视觉变化效果
            function updateVisualEffects(items) {
                items.forEach(item => {
                    // 根据不同类型添加微动画
                    const itemName = item.dataset.name;
                    
                    // 重置所有动画类
                    item.classList.remove('pulse-slow', 'flicker', 'rainbow-glow', 'float-light', 'flowing');
                    
                    // 根据名称添加相应的动画效果
                    if (itemName && itemName.includes('种子')) {
                        // 种子微生长效果
                        item.classList.add('pulse-slow');
                    } else if (itemName && itemName.includes('火焰')) {
                        // 火焰跳动效果
                        item.classList.add('flicker');
                    } else if (itemName && (itemName.includes('彩虹') || itemName.includes('心'))) {
                        // 彩虹渐变效果
                        item.classList.add('rainbow-glow');
                    } else if (item.dataset.type === 'space' && itemName && (itemName.includes('河流') || itemName.includes('水'))) {
                        // 水域流动效果
                        item.classList.add('flowing');
                    } else {
                        // 普通沙具轻微浮动
                        item.classList.add('float-light');
                    }
                });
            }
            
            // 五感模拟 - 环境音效管理（增强版）
            function updateEnvironmentalSounds(environmentItems, relationshipItems, emotionItems, growthItems) {
                // 初始化音效系统（如果尚未初始化）
                if (!soundSystem.initialized) {
                    initSoundSystem();
                }
                
                // 分析环境元素
                const hasWaterElements = environmentItems.some(item => 
                    item.dataset.name && (item.dataset.name.includes('河流') || 
                                         item.dataset.name.includes('湖泊') || 
                                         item.dataset.name.includes('海洋') || 
                                         item.dataset.name.includes('水'))
                );
                
                const hasNatureElements = environmentItems.some(item => 
                    item.dataset.name && (item.dataset.name.includes('树') || 
                                         item.dataset.name.includes('森林') || 
                                         item.dataset.name.includes('山'))
                );
                
                const hasGrowthElements = growthItems.length >= 2;
                
                // 环境音效控制 - 水元素
                if (hasWaterElements && !soundSystem.ambientSounds.water) {
                    playSound('water', true); // 作为环境音效播放
                } else if (!hasWaterElements && soundSystem.ambientSounds.water) {
                    stopSound('water');
                }
                
                // 环境音效控制 - 自然元素
                if (hasNatureElements && !soundSystem.ambientSounds.nature) {
                    playSound('nature', true); // 作为环境音效播放
                } else if (!hasNatureElements && soundSystem.ambientSounds.nature) {
                    stopSound('nature');
                }
                
                // 环境音效控制 - 成长元素
                if (hasGrowthElements && !soundSystem.ambientSounds.growth) {
                    playSound('growth', true); // 作为环境音效播放
                } else if (!hasGrowthElements && soundSystem.ambientSounds.growth) {
                    stopSound('growth');
                }
                
                // 情绪元素特殊音效处理
                if (emotionItems.length > 0) {
                    const hasSuppressedEmotions = emotionItems.some(item => item.classList.contains('suppressed'));
                    const hasPositiveEmotions = emotionItems.length > relationshipItems.length / 2;
                    
                    if (hasSuppressedEmotions && !soundSystem.ambientSounds.emotion) {
                        playSound('emotion', false); // 作为一次性音效播放
                    }
                    
                    // 根据情绪状态调整背景音乐音量
                    if (hasPositiveEmotions) {
                        setVolume('music', 0.4); // 积极情绪时音乐稍大
                    } else if (hasSuppressedEmotions) {
                        setVolume('music', 0.2); // 情绪被抑制时音乐较小
                    } else {
                        setVolume('music', 0.3); // 正常音量
                    }
                }
                
                // 关系互动音效
                if (relationshipItems.length > 2) {
                    // 当有多个关系元素时，偶尔播放互动音效
                    if (Math.random() < 0.01) { // 低概率触发，避免过于频繁
                        playSound('interaction', false);
                    }
                }
            }
            
            // 辅助函数：创建连接线
            function createConnectionLine(x1, y1, x2, y2, distance, color = '#9333ea', lineWidth = 2, animationType = 'pulse') {
                const line = document.createElement('div');
                line.className = 'connection-line';
                
                // 计算角度和长度
                const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
                const length = distance;
                const opacity = Math.max(0.2, 1 - distance / 300); // 调整透明度计算
                
                // 根据动画类型设置不同的样式
                let animationStyle = '';
                let additionalClass = '';
                
                switch (animationType) {
                    case 'pulse':
                        animationStyle = 'animation: pulse-connection 2s infinite ease-in-out;';
                        break;
                    case 'flow':
                        animationStyle = 'animation: flow-connection 3s infinite linear;';
                        // 添加流动效果所需的背景
                        line.style.backgroundImage = `linear-gradient(90deg, transparent, ${color}, transparent), linear-gradient(90deg, ${color} 50%, transparent 50%)`;
                        line.style.backgroundSize = '200% 100%, 20px 100%';
                        line.style.backgroundRepeat = 'no-repeat, repeat-x';
                        break;
                    case 'static':
                    default:
                        animationStyle = '';
                        break;
                }
                
                // 设置基本样式
                line.style.cssText = `
                    width: ${length}px;
                    height: ${lineWidth}px;
                    background: ${color};
                    background-opacity: ${opacity};
                    transform-origin: 0 50%;
                    transform: translate(${x1}px, ${y1}px) rotate(${angle}deg);
                    position: absolute;
                    pointer-events: none;
                    z-index: 10;
                    transition: all 0.3s ease;
                    border-radius: ${lineWidth}px;
                    opacity: ${opacity};
                    ${animationStyle}
                `;
                
                // 为flow类型添加额外的样式（如果上面的内联设置不生效）
                if (animationType === 'flow') {
                    line.classList.add('flow-animation');
                }
                
                sandbox.appendChild(line);
            }
            
            // 增强的引导式探索功能
            function checkGuidedExploration() {
                const items = document.querySelectorAll('.sandbox-item');
                
                // 检查是否已经有问题显示
                if (document.querySelector('.guidance-question')) return;
                
                // 每放置5个沙具，显示一个问题
                if (items.length > 0 && items.length % 5 === 0) {
                    showGuidingQuestion();
                }
            }
            
            // 触觉反馈（如果浏览器支持）
            function triggerHapticFeedback() {
                if (navigator.vibrate) {
                    navigator.vibrate(10); // 轻微震动10毫秒
                }
            }

            // 显示引导问题
            function showGuidingQuestion() {
                const questions = [
                    "这些符号中，哪个让你感觉最亲近？",
                    "你为什么选择将这个符号放在那个位置？",
                    "这个场景中，什么让你感到平静或不安？",
                    "如果你可以改变场景中的一件事，你会改变什么？",
                    "这些符号之间，你觉得它们有着什么样的关系？",
                    "在这个场景中，你想象自己处于什么位置？"
                ];
                
                const randomQuestion = questions[Math.floor(Math.random() * questions.length)];
                
                const questionBox = document.createElement('div');
                questionBox.className = 'guidance-question floating-tip';
                questionBox.innerHTML = `
                    <div class="guidance-content">
                        <i class="fas fa-lightbulb text-amber-500"></i>
                        <p>${randomQuestion}</p>
                    </div>
                    <button class="skip-guidance">跳过</button>
                `;
                
                document.body.appendChild(questionBox);
                
                // 添加跳过按钮事件（避免内联事件处理器）
                const skipButton = questionBox.querySelector('.skip-guidance');
                skipButton.addEventListener('click', () => {
                    questionBox.classList.add('fade-out');
                    setTimeout(() => {
                        if (questionBox.parentNode) {
                            questionBox.remove();
                        }
                    }, 300);
                });
                
                // 30秒后自动消失
                setTimeout(() => {
                    if (questionBox.parentNode) {
                        questionBox.classList.add('fade-out');
                        setTimeout(() => {
                            questionBox.remove();
                        }, 300);
                    }
                }, 30000);
            }

            // 音效系统 - 真实实现
            // 音效资源对象 - 使用公共CDN上的音效资源
            const soundResources = {
                water: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3', // 示例水声音效
                nature: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3', // 示例自然音效
                growth: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3', // 示例成长音效
                interaction: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3', // 示例交互音效
                emotion: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3', // 示例情绪音效
                background: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-6.mp3' // 示例背景音乐
            };
            
            // 音效实例缓存
            let soundInstances = {};
            
            // 音效状态管理
            let soundSystem = {
                ambientSounds: {},
                backgroundMusic: null,
                volume: {
                    effects: 0.5,
                    music: 0.3
                },
                isMuted: false,
                initialized: false
            };
            
            // 初始化音效系统
            function initSoundSystem() {
                if (soundSystem.initialized) return;
                
                // 创建背景音乐实例
                soundSystem.backgroundMusic = new Audio(soundResources.background);
                soundSystem.backgroundMusic.loop = true;
                soundSystem.backgroundMusic.volume = soundSystem.volume.music;
                
                soundSystem.initialized = true;
                console.log('音效系统初始化完成');
            }
            
            // 播放音效
            function playSound(type, isAmbient = false) {
                // 确保音效系统已初始化
                if (!soundSystem.initialized) {
                    initSoundSystem();
                }
                
                // 检查是否已静音
                if (soundSystem.isMuted) {
                    return;
                }
                
                const soundUrl = soundResources[type];
                if (!soundUrl) {
                    console.warn(`未找到类型为${type}的音效资源`);
                    return;
                }
                
                try {
                    if (isAmbient) {
                        // 环境音效处理
                        if (!soundInstances[type]) {
                            soundInstances[type] = new Audio(soundUrl);
                            soundInstances[type].loop = true;
                            soundInstances[type].volume = soundSystem.volume.effects * 0.7; // 环境音效稍小
                        }
                        
                        if (soundInstances[type].paused) {
                            soundInstances[type].play().catch(error => {
                                console.warn(`环境音效${type}播放失败:`, error);
                            });
                            soundSystem.ambientSounds[type] = true;
                        }
                    } else {
                        // 一次性音效处理
                        let soundInstance = new Audio(soundUrl);
                        soundInstance.volume = soundSystem.volume.effects;
                        soundInstance.play().catch(error => {
                            console.warn(`音效${type}播放失败:`, error);
                        });
                        
                        // 播放结束后释放资源
                        soundInstance.addEventListener('ended', () => {
                            soundInstance = null;
                        });
                    }
                } catch (error) {
                    console.error(`播放音效${type}时出错:`, error);
                }
            }
            
            // 停止环境音效
            function stopSound(type) {
                if (soundInstances[type] && !soundInstances[type].paused) {
                    soundInstances[type].pause();
                    soundInstances[type].currentTime = 0;
                    soundSystem.ambientSounds[type] = false;
                }
            }
            
            // 控制背景音乐
            function toggleBackgroundMusic(play = true) {
                if (!soundSystem.initialized) {
                    initSoundSystem();
                }
                
                try {
                    if (play) {
                        if (soundSystem.backgroundMusic.paused) {
                            soundSystem.backgroundMusic.play().catch(error => {
                                console.warn('背景音乐播放失败:', error);
                            });
                        }
                    } else {
                        if (!soundSystem.backgroundMusic.paused) {
                            soundSystem.backgroundMusic.pause();
                        }
                    }
                } catch (error) {
                    console.error('控制背景音乐时出错:', error);
                }
            }
            
            // 设置音量
            function setVolume(type, value) {
                const clampedValue = Math.max(0, Math.min(1, value));
                
                if (type === 'effects') {
                    soundSystem.volume.effects = clampedValue;
                    // 更新所有环境音效的音量
                    Object.keys(soundInstances).forEach(key => {
                        if (soundInstances[key]) {
                            soundInstances[key].volume = clampedValue * 0.7;
                        }
                    });
                } else if (type === 'music') {
                    soundSystem.volume.music = clampedValue;
                    if (soundSystem.backgroundMusic) {
                        soundSystem.backgroundMusic.volume = clampedValue;
                    }
                }
            }
            
            // 切换静音状态
            function toggleMute() {
                soundSystem.isMuted = !soundSystem.isMuted;
                
                // 更新所有环境音效
                Object.keys(soundInstances).forEach(key => {
                    if (soundInstances[key]) {
                        if (soundSystem.isMuted) {
                            soundInstances[key].pause();
                        } else if (soundSystem.ambientSounds[key]) {
                            soundInstances[key].play().catch(error => {
                                console.warn(`恢复环境音效${key}播放失败:`, error);
                            });
                        }
                    }
                });
                
                // 更新背景音乐
                if (soundSystem.backgroundMusic) {
                    if (soundSystem.isMuted) {
                        soundSystem.backgroundMusic.pause();
                    } else {
                        soundSystem.backgroundMusic.play().catch(error => {
                            console.warn('恢复背景音乐播放失败:', error);
                        });
                    }
                }
                
                return soundSystem.isMuted;
            }

            // 隐藏环形菜单
            function hideRadialMenu() {
                radialMenu.classList.remove('visible');
                setTimeout(() => {
                    radialMenu.classList.add('hidden');
                }, 300);
            }

            // 隐藏变体选择器
            function hideVariantSelector() {
                variantSelector.classList.remove('visible');
                setTimeout(() => {
                    variantSelector.classList.add('hidden');
                }, 300);
            }

            // 隐藏沙具功能盘
            function hideItemControls() {
                itemControls.classList.remove('visible');
                setTimeout(() => {
                    itemControls.classList.add('hidden');
                    currentItem = null;
                }, 300);
            }

            // 沙箱点击事件
            sandbox.addEventListener('click', (e) => {
                // 如果点击的是空白区域
                if (e.target === sandbox || e.target === sandboxItems) {
                    // 隐藏所有其他面板
                    hideVariantSelector();
                    hideItemControls();
                    
                    // 显示环形菜单
                    const sandboxRect = sandbox.getBoundingClientRect();
                    const x = e.clientX - sandboxRect.left;
                    const y = e.clientY - sandboxRect.top;
                    
                    radialMenu.style.left = (x - 100) + 'px';
                    radialMenu.style.top = (y - 100) + 'px';
                    
                    radialMenu.classList.remove('hidden');
                    setTimeout(() => {
                        radialMenu.classList.add('visible');
                    }, 10);
                    
                    // 3秒后自动隐藏
                    clearTimeout(menuTimeout);
                    menuTimeout = setTimeout(hideRadialMenu, 3000);
                }
            });

            // 全局工具按钮事件
            document.querySelector('.reset-btn').addEventListener('click', () => {
                const items = document.querySelectorAll('.sandbox-item');
                items.forEach(item => {
                    removeItemFromDOM(item);
                });
                itemCount = 0;
                
                // 重置沙箱样式
                sandbox.classList.remove('growth-environment');
            });
            
            // 导出按钮事件监听
            if (document.querySelector('.export-btn')) {
                document.querySelector('.export-btn').addEventListener('click', function() {
                    exportScenes();
                    playSound('click');
                });
            } else {
                // 如果导出按钮不存在，创建一个
                const exportBtn = document.createElement('button');
                exportBtn.className = 'export-btn';
                exportBtn.innerHTML = '<i class="fas fa-download"></i> 导出';
                exportBtn.style.cssText = `
                    background: #28a745;
                    color: white;
                    border: none;
                    padding: 10px 16px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: 500;
                    margin-left: 8px;
                    transition: all 0.3s;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                `;
                exportBtn.onmouseover = () => {
                    exportBtn.style.background = '#218838';
                    exportBtn.style.transform = 'translateY(-1px)';
                };
                exportBtn.onmouseout = () => {
                    exportBtn.style.background = '#28a745';
                    exportBtn.style.transform = 'translateY(0)';
                };
                exportBtn.addEventListener('click', function() {
                    exportScenes();
                    playSound('click');
                });
                
                // 添加到工具栏
                const toolbar = document.querySelector('.toolbar');
                if (toolbar) {
                    toolbar.appendChild(exportBtn);
                }
            }
            
            // 导入按钮事件监听
            if (document.querySelector('.import-btn')) {
                document.querySelector('.import-btn').addEventListener('click', function() {
                    importScenes();
                    playSound('click');
                });
            } else {
                // 如果导入按钮不存在，创建一个
                const importBtn = document.createElement('button');
                importBtn.className = 'import-btn';
                importBtn.innerHTML = '<i class="fas fa-upload"></i> 导入';
                importBtn.style.cssText = `
                    background: #17a2b8;
                    color: white;
                    border: none;
                    padding: 10px 16px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: 500;
                    margin-left: 8px;
                    transition: all 0.3s;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                `;
                importBtn.onmouseover = () => {
                    importBtn.style.background = '#138496';
                    importBtn.style.transform = 'translateY(-1px)';
                };
                importBtn.onmouseout = () => {
                    importBtn.style.background = '#17a2b8';
                    importBtn.style.transform = 'translateY(0)';
                };
                importBtn.addEventListener('click', function() {
                    importScenes();
                    playSound('click');
                });
                
                // 添加到工具栏
                const toolbar = document.querySelector('.toolbar');
                if (toolbar) {
                    toolbar.appendChild(importBtn);
                }
            }

            // 保存场景功能
            document.querySelector('.save-btn').addEventListener('click', () => {
                // 实现增强版保存功能
                const items = document.querySelectorAll('.sandbox-item');
                
                if (items.length === 0) {
                    alert('沙盘中没有沙具，无法保存！');
                    return;
                }
                
                // 获取用户输入的场景名称
                const defaultName = `场景_${new Date().toLocaleString()}`;
                const sceneName = prompt('请输入场景名称:', defaultName);
                
                // 如果用户取消输入，则不保存
                if (sceneName === null) {
                    return;
                }
                
                // 如果用户输入为空，使用默认名称
                const finalName = sceneName.trim() || defaultName;
                
                // 收集沙具数据
                const sandboxData = Array.from(items).map((item, index) => ({
                    id: `item_${Date.now()}_${index}`,
                    category: item.dataset.category,
                    type: item.dataset.type,
                    name: item.dataset.name,
                    left: item.style.left,
                    top: item.style.top,
                    rotation: item.dataset.rotation || '0',
                    scale: item.dataset.scale || '1',
                    icon: item.querySelector('i')?.className || ''
                }));
                
                // 分析场景元数据
                const itemTypes = [...new Set(sandboxData.map(item => item.type))];
                const itemCategories = [...new Set(sandboxData.map(item => item.category))];
                
                // 根据场景内容分析可能的情绪主题
                const emotionThemes = analyzeSceneEmotions(sandboxData);
                
                // 创建增强版场景数据
                const timestamp = new Date().getTime();
                const sceneData = {
                    id: `scene_${timestamp}`,
                    name: finalName,
                    timestamp: timestamp,
                    lastModified: timestamp,
                    itemCount: sandboxData.length,
                    categories: itemCategories,
                    types: itemTypes,
                    emotionThemes: emotionThemes,
                    sessionDuration: calculateSessionDuration(), // 计算本次会话时长
                    data: sandboxData
                };
                
                // 从localStorage获取现有场景列表
                const savedScenes = JSON.parse(localStorage.getItem('sandboxScenes') || '[]');
                
                // 添加新场景
                savedScenes.unshift(sceneData);
                
                // 用户可配置的保存数量限制
                const maxSavedScenes = parseInt(localStorage.getItem('maxSavedScenes')) || 15;
                if (savedScenes.length > maxSavedScenes) {
                    // 显示警告通知
                    showNotification(`已达到保存数量上限(${maxSavedScenes}个)，最早的场景将被删除`, 'warning');
                    // 移除最旧的场景
                    savedScenes.splice(maxSavedScenes);
                }
                
                // 保存到localStorage
                localStorage.setItem('sandboxScenes', JSON.stringify(savedScenes));
                
                // 显示保存成功消息
                showNotification(`场景 "${finalName}" 保存成功！`, 'success');
                
                // 播放保存音效
                playSound('saveScene');
            });
            
            // 辅助函数：分析场景情绪主题
            function analyzeSceneEmotions(sandboxData) {
                const themes = [];
                
                // 统计各类沙具数量
                const typeCount = {};
                sandboxData.forEach(item => {
                    typeCount[item.type] = (typeCount[item.type] || 0) + 1;
                });
                
                // 基于沙具类型判断可能的情绪主题
                if (typeCount['character'] > 0 && typeCount['connection'] > 0) {
                    themes.push('关系导向');
                }
                
                if (typeCount['change'] > 1) {
                    themes.push('成长与转变');
                }
                
                if (typeCount['abstract'] > 0) {
                    themes.push('情感表达');
                }
                
                if (typeCount['boundary'] > 1) {
                    themes.push('保护与边界');
                }
                
                if (typeCount['space'] > 2) {
                    themes.push('环境探索');
                }
                
                // 如果没有特定主题，返回默认主题
                if (themes.length === 0) {
                    themes.push('自由表达');
                }
                
                return themes;
            }
            
            // 辅助函数：计算会话时长（毫秒）
            function calculateSessionDuration() {
                const sessionStart = parseInt(localStorage.getItem('sessionStartTime')) || Date.now();
                return Date.now() - sessionStart;
            }
            
            // 初始化会话计时
            localStorage.setItem('sessionStartTime', Date.now().toString());
            
            // 导出场景数据为JSON文件
            function exportScenes() {
                // 从localStorage获取所有场景
                const savedScenes = JSON.parse(localStorage.getItem('sandboxScenes') || '[]');
                
                if (savedScenes.length === 0) {
                    showNotification('没有可导出的场景', 'info');
                    return;
                }
                
                // 创建导出数据对象，包含元数据和场景列表
                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    totalScenes: savedScenes.length,
                    scenes: savedScenes
                };
                
                // 将数据转换为JSON字符串
                const jsonContent = JSON.stringify(exportData, null, 2);
                
                // 创建Blob对象
                const blob = new Blob([jsonContent], { type: 'application/json' });
                
                // 创建下载链接
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                const dateStr = new Date().toISOString().slice(0, 10);
                link.download = `沙盘场景备份_${dateStr}.json`;
                link.href = url;
                
                // 触发下载
                document.body.appendChild(link);
                link.click();
                
                // 清理
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification(`成功导出 ${savedScenes.length} 个场景`, 'success');
            }
            
            // 导入场景数据
            function importScenes() {
                // 创建文件选择输入框
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.json';
                fileInput.style.display = 'none';
                
                // 添加文件选择事件
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    // 验证文件类型和大小
                    if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
                        showNotification('请选择有效的JSON文件', 'error');
                        return;
                    }
                    
                    if (file.size > 10 * 1024 * 1024) { // 10MB 限制
                        showNotification('文件大小不能超过10MB', 'error');
                        return;
                    }
                    
                    const reader = new FileReader();
                    
                    reader.onload = function(event) {
                        try {
                            // 解析JSON数据
                            const importData = JSON.parse(event.target.result);
                            
                            // 验证导入数据结构
                            if (!importData.scenes || !Array.isArray(importData.scenes)) {
                                throw new Error('无效的备份文件格式');
                            }
                            
                            // 获取现有场景
                            const currentScenes = JSON.parse(localStorage.getItem('sandboxScenes') || '[]');
                            
                            // 计算导入的场景数量
                            const importedCount = importData.scenes.length;
                            
                            // 决定导入模式
                            let confirmMsg = `检测到 ${importedCount} 个场景\n\n`;
                            
                            // 检查是否有重复场景
                            const existingNames = new Set(currentScenes.map(s => s.name));
                            const duplicateNames = importData.scenes.filter(s => existingNames.has(s.name)).map(s => s.name);
                            
                            if (duplicateNames.length > 0) {
                                confirmMsg += `注意：发现 ${duplicateNames.length} 个同名场景，导入时将被重命名\n\n`;
                            }
                            
                            confirmMsg += '选择导入方式：\n';
                            confirmMsg += '1. 合并（保留现有场景，添加新场景）\n';
                            confirmMsg += '2. 替换（覆盖所有现有场景）\n\n';
                            confirmMsg += '请输入 1 或 2：';
                            
                            const importMode = prompt(confirmMsg, '1');
                            
                            if (importMode !== '1' && importMode !== '2') {
                                showNotification('导入已取消', 'info');
                                return;
                            }
                            
                            let finalScenes = [];
                            let newSceneCount = 0;
                            
                            if (importMode === '1') {
                                // 合并模式
                                finalScenes = [...currentScenes];
                                
                                // 处理重复名称，重命名导入的场景
                                importData.scenes.forEach(scene => {
                                    let importScene = { ...scene };
                                    
                                    // 为重复名称添加后缀
                                    let counter = 1;
                                    let originalName = importScene.name;
                                    while (finalScenes.some(s => s.name === importScene.name)) {
                                        importScene.name = `${originalName} (${counter})`;
                                        counter++;
                                    }
                                    
                                    // 生成新的ID和修改时间
                                    importScene.id = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                                    importScene.lastModified = Date.now();
                                    
                                    finalScenes.push(importScene);
                                    newSceneCount++;
                                });
                            } else {
                                // 替换模式
                                // 为所有导入的场景生成新ID
                                finalScenes = importData.scenes.map(scene => ({
                                    ...scene,
                                    id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                                    lastModified: Date.now()
                                }));
                                newSceneCount = finalScenes.length;
                            }
                            
                            // 应用最大场景数量限制
                            const maxSavedScenes = parseInt(localStorage.getItem('maxSavedScenes')) || 15;
                            if (finalScenes.length > maxSavedScenes) {
                                // 按时间排序（最新的在前）
                                finalScenes.sort((a, b) => b.timestamp - a.timestamp);
                                
                                // 只保留最近的
                                finalScenes = finalScenes.slice(0, maxSavedScenes);
                                
                                showNotification(`已达到最大保存数量(${maxSavedScenes})，已自动调整`, 'warning');
                            }
                            
                            // 保存到localStorage
                            localStorage.setItem('sandboxScenes', JSON.stringify(finalScenes));
                            
                            showNotification(`成功导入 ${newSceneCount} 个场景`, 'success');
                            
                            // 询问是否查看场景列表
                            if (confirm('导入成功！是否查看所有场景？')) {
                                showSceneList();
                            }
                            
                        } catch (error) {
                            console.error('导入失败:', error);
                            showNotification('导入失败：无效的JSON文件或格式错误', 'error');
                        }
                    };
                    
                    reader.onerror = function() {
                        showNotification('文件读取失败', 'error');
                    };
                    
                    // 开始读取文件
                    reader.readAsText(file);
                });
                
                // 触发文件选择
                document.body.appendChild(fileInput);
                fileInput.click();
                
                // 清理
                setTimeout(() => {
                    document.body.removeChild(fileInput);
                }, 100);
            }
            
            // 加载场景按钮点击事件
            document.querySelector('.load-btn').addEventListener('click', () => {
                // 显示场景列表
                showSceneList();
                
                // 播放点击音效
                playSound('click');
            });

            document.querySelector('.analyze-btn').addEventListener('click', () => {
                generateAIAnalysis();
                analysisPanel.classList.add('visible');
            });

            document.getElementById('close-analysis').addEventListener('click', () => {
                analysisPanel.classList.remove('visible');
            });

            // 生成AI解读 - 增强版
            function generateAIAnalysis() {
                const items = document.querySelectorAll('.sandbox-item');
                
                // 如果没有沙具，显示提示信息
                if (items.length === 0) {
                    analysisContent.innerHTML = "<p>你的沙盘还是空的。请开始放置沙具来创建你的内心场景，然后再次点击'解读'按钮。</p>";
                    return;
                }
                
                // 收集更详细的沙具信息
                const itemsData = Array.from(items).map(item => ({
                    type: item.dataset.type,
                    category: item.dataset.category,
                    variant: item.dataset.variant,
                    left: parseFloat(item.style.left),
                    top: parseFloat(item.style.top),
                    element: item
                }));
                
                // 模拟AI解读逻辑
                let analysis = "<div class='analysis-header'><h3>沙盘解读</h3></div>";
                analysis += "<p>基于你创建的沙盘场景，我注意到以下几点：</p>";
                
                // 统计各类型沙具数量
                const typeCounts = {};
                const categoryCounts = {};
                itemsData.forEach(item => {
                    typeCounts[item.type] = (typeCounts[item.type] || 0) + 1;
                    categoryCounts[item.category] = (categoryCounts[item.category] || 0) + 1;
                });
                
                // 分析位置关系
                const leftItems = itemsData.filter(item => item.left < 200);
                const rightItems = itemsData.filter(item => item.left >= 200);
                const topItems = itemsData.filter(item => item.top < 150);
                const bottomItems = itemsData.filter(item => item.top >= 150);
                
                // 分析沙具之间的距离关系
                const proximityPairs = findCloseItems(itemsData, 80);
                
                // 基础类别解读 - 更详细的描述
                if (typeCounts.character || categoryCounts.self) {
                    analysis += "<div class='analysis-section'><h4>自我认知</h4>";
                    analysis += "<p>你在场景中放置了代表'自我'的符号，这表明你正在关注自己的内心世界和身份认同。</p>";
                    
                    const selfItems = itemsData.filter(item => item.type === 'character' || item.category === 'self');
                    if (selfItems.length > 1) {
                        analysis += "<p>多个自我符号的存在可能反映了你内心不同面向的对话或冲突。</p>";
                    }
                    
                    if (selfItems.some(item => item.left < 200)) {
                        analysis += "<p>将自我符号放置在左侧，可能表明你在回顾过去的经历或自我认知。</p>";
                    } else if (selfItems.some(item => item.left >= 200)) {
                        analysis += "<p>将自我符号放置在右侧，可能暗示你对未来的期望或自我发展的关注。</p>";
                    }
                    analysis += "</div>";
                }
                
                if (typeCounts.connection || categoryCounts.relationship) {
                    analysis += "<div class='analysis-section'><h4>人际关系</h4>";
                    analysis += "<p>关系符号的存在显示了你对人际连接的重视，可能反映了你当前的社交状态或期望。</p>";
                    
                    const relationshipItems = itemsData.filter(item => item.type === 'connection' || item.category === 'relationship');
                    const selfItems = itemsData.filter(item => item.type === 'character' || item.category === 'self');
                    
                    if (hasCloseProximity(relationshipItems, selfItems, 100)) {
                        analysis += "<p>关系符号与自我符号的接近，表明你可能正在思考与自我相关的人际关系议题。</p>";
                    }
                    analysis += "</div>";
                }
                
                if (typeCounts.space || categoryCounts.environment) {
                    analysis += "<div class='analysis-section'><h4>环境感知</h4>";
                    analysis += "<p>环境元素的选择反映了你对周围世界的感知方式和归属感。</p>";
                    
                    const waterItems = itemsData.filter(item => item.variant && 
                        (item.variant.includes('河流') || item.variant.includes('海洋')));
                    const natureItems = itemsData.filter(item => item.variant && 
                        (item.variant.includes('树木') || item.variant.includes('森林') || item.variant.includes('山脉')));
                    
                    if (waterItems.length > 0) {
                        analysis += "<p>水元素的存在通常象征情感流动、潜意识或生命能量。</p>";
                    }
                    if (natureItems.length > 0) {
                        analysis += "<p>自然元素的丰富可能表明你对和谐、成长或回归本真的向往。</p>";
                    }
                    analysis += "</div>";
                }
                
                if (typeCounts.abstract || categoryCounts.emotion) {
                    analysis += "<div class='analysis-section emotion-analysis'><h4>情绪状态</h4>";
                    analysis += "<p>情绪符号揭示了你当前可能正在经历的情感状态或内心冲突。</p>";
                    
                    const positiveEmotions = itemsData.filter(item => item.variant && 
                        (item.variant.includes('彩虹') || item.variant.includes('星星') || item.variant.includes('花朵')));
                    const negativeEmotions = itemsData.filter(item => item.variant && 
                        (item.variant.includes('乌云') || item.variant.includes('风暴') || item.variant.includes('漩涡')));
                    
                    if (positiveEmotions.length > negativeEmotions.length) {
                        analysis += "<p>场景中积极情绪符号占主导，这可能反映你当前较为积极的心态或对美好事物的关注。</p>";
                    } else if (negativeEmotions.length > 0) {
                        analysis += "<p>负面情绪符号的存在表明你可能正在处理一些情绪挑战，这是正常且重要的自我探索过程。</p>";
                    }
                    
                    // 使用情绪分析系统进行深度分析
                    const emotionalState = emotionSystem.analyzeEmotionalState(itemsData);
                    const emotionFeedback = emotionSystem.generateEmotionFeedback(emotionalState);
                    const regulationSuggestions = emotionSystem.suggestEmotionRegulation(emotionalState);
                    
                    if (emotionalState.totalEmotions > 0) {
                        // 情绪基调对应的中文描述
                        const toneMap = {
                            'positive': '积极',
                            'negative': '消极',
                            'mixed': '混合',
                            'neutral': '中性'
                        };
                        
                        analysis += "<div class='emotion-details'>";
                        analysis += "<p><strong>情绪分析：</strong></p>";
                        analysis += "<ul>";
                        analysis += "<li>情绪元素占比: <strong>" + emotionalState.percentageOfTotal + "%</strong></li>";
                        analysis += "<li>主要情绪基调: <strong>" + (toneMap[emotionalState.emotionalTone] || emotionalState.emotionalTone) + "</strong></li>";
                        
                        if (emotionalState.dominantEmotion) {
                            analysis += "<li>主导情绪符号: <strong>" + emotionalState.dominantEmotion + "</strong></li>";
                        }
                        
                        // 情绪平衡状态
                        const balanceMap = {
                            'balanced': '平衡',
                            'moderately_balanced': '相对平衡',
                            'somewhat_unbalanced': '有些失衡',
                            'imbalanced': '显著失衡'
                        };
                        
                        analysis += "<li>情绪平衡状态: <strong>" + (balanceMap[emotionalState.balanceStatus] || emotionalState.balanceStatus) + "</strong></li>";
                        analysis += "</ul>";
                        analysis += "</div>";
                        
                        // 情绪反馈建议
                        if (emotionFeedback.length > 0) {
                            analysis += "<div class='emotion-feedback'>";
                            analysis += "<p><strong>情绪洞察：</strong></p>";
                            analysis += "<ul>";
                            emotionFeedback.forEach(feedback => {
                                analysis += "<li>" + feedback + "</li>";
                            });
                            analysis += "</ul>";
                            analysis += "</div>";
                        }
                        
                        // 情绪调节建议
                        if (regulationSuggestions.length > 0) {
                            analysis += "<div class='regulation-suggestions'>";
                            analysis += "<p><strong>情绪调节建议：</strong></p>";
                            analysis += "<ul>";
                            regulationSuggestions.forEach(suggestion => {
                                analysis += "<li><strong>" + suggestion.title + "</strong>: " + suggestion.description + "</li>";
                            });
                            analysis += "</ul>";
                            analysis += "</div>";
                        }
                    }
                    
                    analysis += "</div>";
                }
                
                if (typeCounts.boundary || categoryCounts.defense) {
                    analysis += "<div class='analysis-section'><h4>防御机制</h4>";
                    analysis += "<p>防御符号的出现可能表明你在某些方面感到需要保护或设置界限。</p>";
                    
                    const defenseItems = itemsData.filter(item => item.type === 'boundary' || item.category === 'defense');
                    const emotionItems = itemsData.filter(item => item.type === 'abstract' || item.category === 'emotion');
                    
                    if (hasCloseProximity(defenseItems, emotionItems, 80)) {
                        analysis += "<p>防御符号与情绪符号的接近，暗示你可能正在尝试保护自己免受某些情绪的影响。</p>";
                    }
                    analysis += "</div>";
                }
                
                if (typeCounts.change || categoryCounts.growth) {
                    analysis += "<div class='analysis-section'><h4>成长与转变</h4>";
                    analysis += "<p>成长符号的存在暗示你可能正在经历或期待某种转变、学习或个人发展。</p>";
                    
                    const growthItems = itemsData.filter(item => item.type === 'change' || item.category === 'growth');
                    if (growthItems.some(item => item.left >= 200)) {
                        analysis += "<p>将成长符号放置在右侧，可能表明你对未来的个人发展充满期待。</p>";
                    }
                    analysis += "</div>";
                }
                
                // 新增类别的解读
                if (categoryCounts.time) {
                    analysis += "<div class='analysis-section'><h4>时间感知</h4>";
                    analysis += "<p>时间相关的符号显示了你对时间流逝、过去、现在或未来的关注。</p>";
                    
                    const timeItems = itemsData.filter(item => item.category === 'time');
                    if (timeItems.some(item => item.left < 200)) {
                        analysis += "<p>时间符号出现在左侧，可能表明你正在反思过去的经历或有未完成的情结。</p>";
                    }
                    if (timeItems.some(item => item.left >= 200)) {
                        analysis += "<p>时间符号出现在右侧，可能暗示你对未来有期待、焦虑或规划。</p>";
                    }
                    analysis += "</div>";
                }
                
                if (categoryCounts.conflict) {
                    analysis += "<div class='analysis-section'><h4>内心冲突</h4>";
                    analysis += "<p>冲突符号的存在可能反映了你内心正在经历的矛盾、挣扎或挑战。</p>";
                    
                    const conflictItems = itemsData.filter(item => item.category === 'conflict');
                    const balanceItems = itemsData.filter(item => item.category === 'balance');
                    
                    if (balanceItems.length > 0) {
                        analysis += "<p>同时存在平衡符号，表明你正在尝试在冲突中寻找和谐或解决方案。</p>";
                    } else {
                        analysis += "<p>注意到冲突符号但缺乏平衡元素，这可能是一个探索如何解决这些冲突的好机会。</p>";
                    }
                    analysis += "</div>";
                }
                
                if (categoryCounts.balance) {
                    analysis += "<div class='analysis-section'><h4>寻求平衡</h4>";
                    analysis += "<p>平衡符号的存在表明你重视和谐、均衡或内心的稳定。</p>";
                    analysis += "</div>";
                }
                
                // 整体布局分析
                if (leftItems.length > rightItems.length * 2) {
                    analysis += "<div class='analysis-section'><h4>整体视角</h4>";
                    analysis += "<p>场景中左侧元素明显多于右侧，这可能表明你当前更关注过去的经历、记忆或已经完成的部分。</p>";
                    analysis += "</div>";
                } else if (rightItems.length > leftItems.length * 2) {
                    analysis += "<div class='analysis-section'><h4>整体视角</h4>";
                    analysis += "<p>场景中右侧元素明显多于左侧，这可能表明你更关注未来的可能性、目标或尚未实现的部分。</p>";
                    analysis += "</div>";
                }
                
                if (topItems.length > bottomItems.length * 2) {
                    analysis += "<div class='analysis-section'><h4>整体视角</h4>";
                    analysis += "<p>场景中上方元素较多，可能反映你更关注理想、精神层面或抽象概念。</p>";
                    analysis += "</div>";
                } else if (bottomItems.length > topItems.length * 2) {
                    analysis += "<div class='analysis-section'><h4>整体视角</h4>";
                    analysis += "<p>场景中下方元素较多，可能反映你更关注现实、具体问题或实际需求。</p>";
                    analysis += "</div>";
                }
                
                // 符号间关系分析
                if (proximityPairs.length > 0) {
                    analysis += "<div class='analysis-section'><h4>符号关系</h4>";
                    analysis += "<p>我注意到一些符号放置得比较接近，这可能表明它们之间存在某种内在联系或相互影响。</p>";
                    analysis += "</div>";
                }
                
                // 个性化建议和引导性问题
                analysis += "<div class='analysis-section'><h4>反思与探索</h4>";
                analysis += "<p>以下是一些可能帮助你进一步探索的问题：</p>";
                analysis += "<ul>";
                
                // 根据场景内容提供个性化问题
                if (itemsData.length < 5) {
                    analysis += "<li>如果可以添加更多元素，你会选择什么？它们代表什么？</li>";
                }
                
                if (categoryCounts.conflict && !categoryCounts.balance) {
                    analysis += "<li>你如何看待场景中的冲突元素？有没有可能的解决方案或调和方式？</li>";
                }
                
                if (typeCounts.character || categoryCounts.self) {
                    analysis += "<li>场景中的自我符号与其他元素的关系如何？这反映了你与周围世界的关系吗？</li>";
                }
                
                if (typeCounts.abstract || categoryCounts.emotion) {
                    analysis += "<li>你能识别出场景中主要的情绪基调吗？这与你当前的感受有何关联？</li>";
                }
                
                // 通用问题
                analysis += "<li>在创建这个场景的过程中，你有什么特别的感受或想法浮现？</li>";
                analysis += "<li>如果这个场景可以'讲述'一个故事，那会是什么样的故事？</li>";
                analysis += "</ul>";
                analysis += "</div>";
                
                analysis += "<div class='analysis-footer'>";
                analysis += "<p>记住，这只是一种引导性的解读，最准确和有意义的理解来自你自己的感受和思考。沙盘是你内心世界的镜子，通过观察和反思，你可以获得宝贵的自我认知。</p>";
                analysis += "</div>";
                
                analysisContent.innerHTML = analysis;
                
                // 添加简单的淡入动画
                analysisContent.style.opacity = '0';
                analysisContent.style.transition = 'opacity 0.5s ease-in-out';
                setTimeout(() => {
                    analysisContent.style.opacity = '1';
                }, 100);
            }
            
            // 辅助函数：查找距离接近的沙具对
            function findCloseItems(itemsData, maxDistance) {
                const pairs = [];
                for (let i = 0; i < itemsData.length; i++) {
                    for (let j = i + 1; j < itemsData.length; j++) {
                        const distance = calculateDistance(itemsData[i], itemsData[j]);
                        if (distance <= maxDistance) {
                            pairs.push({ item1: itemsData[i], item2: itemsData[j], distance: distance });
                        }
                    }
                }
                return pairs;
            }
            
            // 辅助函数：计算两个沙具之间的距离
            function calculateDistance(item1, item2) {
                const dx = item1.left - item2.left;
                const dy = item1.top - item2.top;
                return Math.sqrt(dx * dx + dy * dy);
            }
            
            // 情感识别与反馈系统
            const emotionSystem = {
                // 情绪分类映射
                emotionCategories: {
                    'positive': ['彩虹', '星星', '花朵'],
                    'negative': ['乌云', '风暴', '漩涡'],
                    'neutral': ['火焰'],
                    'intense': ['火焰', '风暴', '漩涡'],
                    'calm': ['彩虹', '星星', '花朵']
                },
                
                // 情绪强度映射
                emotionIntensities: {
                    '乌云': 0.3,
                    '火焰': 0.8,
                    '彩虹': 0.7,
                    '漩涡': 0.9,
                    '星星': 0.5,
                    '风暴': 0.9,
                    '花朵': 0.4
                },
                
                // 情绪之间的关系（相生相克）
                emotionRelationships: {
                    '乌云': { balances: ['火焰'], intensifiedBy: ['风暴'] },
                    '火焰': { balances: ['乌云'], intensifiedBy: ['漩涡'] },
                    '彩虹': { balances: ['风暴'], intensifiedBy: ['花朵'] },
                    '漩涡': { balances: ['星星'], intensifiedBy: ['风暴'] },
                    '星星': { balances: ['漩涡'], intensifiedBy: ['彩虹'] },
                    '风暴': { balances: ['花朵'], intensifiedBy: ['乌云'] },
                    '花朵': { balances: ['风暴'], intensifiedBy: ['星星'] }
                },
                
                // 分析场景中的情绪状态
                analyzeEmotionalState: function(itemsData) {
                    const emotions = itemsData.filter(item => item.category === 'emotion');
                    const totalItems = itemsData.length;
                    const emotionItems = emotions.length;
                    
                    // 基础情绪统计
                    const emotionCounts = {};
                    emotions.forEach(item => {
                        emotionCounts[item.variantName] = (emotionCounts[item.variantName] || 0) + 1;
                    });
                    
                    // 计算情绪基调
                    let positiveCount = 0;
                    let negativeCount = 0;
                    let totalIntensity = 0;
                    
                    emotions.forEach(item => {
                        const variant = item.variantName;
                        if (this.emotionCategories.positive.includes(variant)) positiveCount++;
                        if (this.emotionCategories.negative.includes(variant)) negativeCount++;
                        totalIntensity += this.emotionIntensities[variant] || 0.5;
                    });
                    
                    // 计算主导情绪
                    let dominantEmotion = null;
                    let maxCount = 0;
                    Object.entries(emotionCounts).forEach(([emotion, count]) => {
                        if (count > maxCount) {
                            maxCount = count;
                            dominantEmotion = emotion;
                        }
                    });
                    
                    // 分析情绪平衡状态
                    const balanceScore = this.calculateBalanceScore(emotions);
                    
                    return {
                        totalEmotions: emotionItems,
                        percentageOfTotal: totalItems > 0 ? (emotionItems / totalItems * 100).toFixed(1) : 0,
                        emotionCounts: emotionCounts,
                        dominantEmotion: dominantEmotion,
                        emotionalTone: this.determineEmotionalTone(positiveCount, negativeCount, emotionItems),
                        averageIntensity: emotions.length > 0 ? (totalIntensity / emotions.length).toFixed(2) : 0,
                        balanceScore: balanceScore,
                        balanceStatus: this.interpretBalanceScore(balanceScore)
                    };
                },
                
                // 计算情绪平衡分数
                calculateBalanceScore: function(emotions) {
                    let balanceScore = 0;
                    const emotionMap = {};
                    
                    // 统计各类情绪数量
                    emotions.forEach(item => {
                        emotionMap[item.variantName] = (emotionMap[item.variantName] || 0) + 1;
                    });
                    
                    // 分析情绪平衡关系
                    Object.entries(emotionMap).forEach(([emotion, count]) => {
                        const relationships = this.emotionRelationships[emotion];
                        if (relationships) {
                            // 检查平衡关系
                            relationships.balances.forEach(balancingEmotion => {
                                if (emotionMap[balancingEmotion]) {
                                    balanceScore += Math.min(count, emotionMap[balancingEmotion]) * 0.3;
                                }
                            });
                            
                            // 检查激化关系
                            relationships.intensifiedBy.forEach(intensifyingEmotion => {
                                if (emotionMap[intensifyingEmotion]) {
                                    balanceScore -= Math.min(count, emotionMap[intensifyingEmotion]) * 0.2;
                                }
                            });
                        }
                    });
                    
                    // 确保分数在0-1之间
                    return Math.max(0, Math.min(1, balanceScore));
                },
                
                // 确定情绪基调
                determineEmotionalTone: function(positive, negative, total) {
                    if (total === 0) return 'neutral';
                    
                    const positiveRatio = positive / total;
                    const negativeRatio = negative / total;
                    
                    if (positiveRatio > 0.6) return 'positive';
                    if (negativeRatio > 0.6) return 'negative';
                    return 'mixed';
                },
                
                // 解读平衡分数
                interpretBalanceScore: function(score) {
                    if (score > 0.7) return 'balanced';
                    if (score > 0.4) return 'moderately_balanced';
                    if (score > 0.2) return 'somewhat_unbalanced';
                    return 'imbalanced';
                },
                
                // 生成情绪反馈建议
                generateEmotionFeedback: function(emotionalState) {
                    const feedback = [];
                    
                    // 基于情绪基调提供反馈
                    switch (emotionalState.emotionalTone) {
                        case 'positive':
                            feedback.push('你的沙盘展现了积极的情绪基调，这很好！记得保持这种积极的能量。');
                            break;
                        case 'negative':
                            feedback.push('我注意到你的沙盘中包含较多的负面情绪元素，这可能反映了你当前的内心状态。请记住，表达这些感受是疗愈的第一步。');
                            break;
                        case 'mixed':
                            feedback.push('你的沙盘展示了复杂的情绪混合，这正是人类内心世界的真实反映。');
                            break;
                    }
                    
                    // 基于情绪平衡状态提供反馈
                    switch (emotionalState.balanceStatus) {
                        case 'balanced':
                            feedback.push('你的情绪表达达到了很好的平衡，这通常代表内心状态较为和谐。');
                            break;
                        case 'moderately_balanced':
                            feedback.push('你正在探索情绪的不同方面，尝试寻找平衡点。');
                            break;
                        case 'somewhat_unbalanced':
                            feedback.push('沙盘中的情绪似乎有些失衡，你可能正在经历内心的冲突或压力。');
                            feedback.push('你可以尝试添加一些代表平衡或平静的元素，看看是否能感受到变化。');
                            break;
                        case 'imbalanced':
                            feedback.push('我注意到沙盘中的情绪表达存在显著的不平衡，这可能反映了你当前面临的挑战。');
                            feedback.push('记住，这是一个安全的空间，你可以自由地表达和探索这些感受。');
                            break;
                    }
                    
                    // 如果有主导情绪，提供相关反馈
                    if (emotionalState.dominantEmotion) {
                        const dominantFeedback = this.getDominantEmotionFeedback(emotionalState.dominantEmotion);
                        if (dominantFeedback) {
                            feedback.push(dominantFeedback);
                        }
                    }
                    
                    return feedback;
                },
                
                // 获取主导情绪的特定反馈
                getDominantEmotionFeedback: function(emotion) {
                    const feedbackMap = {
                        '乌云': '乌云象征着可能存在的忧虑或悲伤。你是否愿意探索这些感受的来源？',
                        '火焰': '火焰代表热情或愤怒，这是一种强烈的能量。这种能量如何在你的生活中流动？',
                        '彩虹': '彩虹象征着希望和积极的转变。你最近是否经历了一些积极的变化？',
                        '漩涡': '漩涡可能反映了内心的混乱或强烈的情绪纠结。尝试深呼吸，给自己一些空间。',
                        '星星': '星星代表希望和指引。你生活中的"北极星"是什么？',
                        '风暴': '风暴象征着内心的动荡。请记住，风暴过后通常会迎来平静。',
                        '花朵': '花朵象征着成长和绽放。你在哪些方面感到自己正在成长？'
                    };
                    return feedbackMap[emotion] || null;
                },
                
                // 提供情绪调节建议
                suggestEmotionRegulation: function(emotionalState) {
                    const suggestions = [];
                    
                    if (emotionalState.emotionalTone === 'negative' || emotionalState.balanceStatus === 'imbalanced') {
                        suggestions.push({
                            title: '情绪释放',
                            description: '尝试写日记或进行艺术创作，帮助释放内心的情绪能量。'
                        });
                        suggestions.push({
                            title: '正念呼吸',
                            description: '花几分钟时间进行深呼吸练习，帮助平静思绪。'
                        });
                    }
                    
                    if (parseFloat(emotionalState.averageIntensity) > 0.7) {
                        suggestions.push({
                            title: '身体活动',
                            description: '适当的身体活动可以帮助释放紧张情绪，恢复内心平衡。'
                        });
                    }
                    
                    if (suggestions.length === 0) {
                        suggestions.push({
                            title: '保持觉察',
                            description: '继续保持对自己情绪的觉察，这是情绪智慧的重要部分。'
                        });
                    }
                    
                    return suggestions;
                }
            };
            
            // 辅助函数：检查两类沙具是否有接近的实例
            function hasCloseProximity(items1, items2, maxDistance) {
                for (const item1 of items1) {
                    for (const item2 of items2) {
                        if (calculateDistance(item1, item2) <= maxDistance) {
                            return true;
                        }
                    }
                }
                return false;
            }

            // 关闭漂浮提示卡
            document.getElementById('close-tip').addEventListener('click', () => {
                floatingTip.style.display = 'none';
            });

            // 点击其他区域隐藏面板
            document.addEventListener('click', (e) => {
                if (!radialMenu.contains(e.target) && !variantSelector.contains(e.target) && !itemControls.contains(e.target)) {
                    // 保持沙箱点击事件的逻辑
                }
            });

            // 初始化环形菜单
            createRadialMenu();
        });
    </script>
    
    <!-- 欢迎引导浮层 -->
    <div id="welcome-guide" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
        <div class="welcome-container bg-white rounded-xl shadow-2xl p-8 max-w-md mx-4 transform transition-all duration-300 hover:shadow-slate-900/30">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800 mb-2">欢迎使用箱庭疗法</h2>
                <p class="text-slate-600 mb-6">箱庭疗法是一种心理表达和治疗工具，通过在沙盘中放置物品，你可以自由地表达内心世界。</p>
                
                <div class="mb-6 text-left">
                    <div class="flex items-start mb-3">
                        <div class="w-8 h-8 flex items-center justify-center bg-blue-100 text-blue-600 rounded-full mr-3 mt-1">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                        <p class="text-sm text-slate-600">将沙具集中在左侧可能暗示对过去的关注，集中在右侧可能表示对未来的期望。</p>
                    </div>
                    <div class="flex items-start mb-3">
                        <div class="w-8 h-8 flex items-center justify-center bg-blue-100 text-blue-600 rounded-full mr-3 mt-1">
                            <i class="fas fa-tools"></i>
                        </div>
                        <p class="text-sm text-slate-600">使用右侧可以"挖"沙创造水域，中键拖动可以平移沙盘视角。</p>
                    </div>
                    <div class="flex items-start">
                        <div class="w-8 h-8 flex items-center justify-center bg-blue-100 text-blue-600 rounded-full mr-3 mt-1">
                            <i class="fas fa-brain"></i>
                        </div>
                        <p class="text-sm text-slate-600">摆完观点，点击"解读"按钮可以获得一些参考性的分析，但请记住，你的真实感受最重要。</p>
                    </div>
                </div>
            </div>
            
            <button id="start-sandbox-btn" class="w-full py-3 px-6 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                开始体验
            </button>
        </div>
    </div>

    <script>
        // 欢迎引导浮层逻辑
        document.getElementById('start-sandbox-btn').addEventListener('click', function() {
            const welcomeGuide = document.getElementById('welcome-guide');
            welcomeGuide.classList.add('opacity-0');
            setTimeout(() => {
                welcomeGuide.style.display = 'none';
            }, 300);
        });
    </script>
    
    <!-- 增强导航栏动画效果的CSS样式 -->
    <style>
        /* 全局CSS变量 - 便于主题定制 */
        :root {
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --primary-light: rgba(59, 130, 246, 0.1);
            --transition-speed: 300ms;
            --shadow-light: 0 4px 6px rgba(0, 0, 0, 0.05);
            --shadow-medium: 0 8px 24px rgba(0, 0, 0, 0.1);
            --shadow-heavy: 0 16px 48px rgba(0, 0, 0, 0.12);
            --border-radius: 12px;
        }
        
        /* 导航栏滚动效果 */
        .navbar.nav-scrolled {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: var(--shadow-medium);
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
        
        .navbar.nav-hidden {
            transform: translateY(-100%);
            transition: transform var(--transition-speed) ease;
        }
        
        /* 波纹效果样式 */
        .ripple-effect {
            position: absolute;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.5);
            transform: scale(0);
            animation: ripple-animation 0.6s cubic-bezier(0.215, 0.61, 0.355, 1);
            pointer-events: none;
            z-index: 1;
        }
        
        @keyframes ripple-animation {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
        
        /* 移动端菜单动画 */
        .mobile-menu {
            transform: translateX(100%);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        .mobile-menu.mobile-menu-open {
            transform: translateX(0);
            opacity: 1;
        }
        
        /* 下拉菜单动画 */
        #desktop-more-dropdown,
        #user-dropdown {
            transform: translateY(10px);
            opacity: 0;
            visibility: hidden;
            transition: transform 0.2s ease, opacity 0.2s ease, visibility 0.2s;
        }
        
        #desktop-more-dropdown.dropdown-animation,
        #user-dropdown.dropdown-animation {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }
        
        /* 导航链接过渡效果增强 */
        .nav-links a {
            position: relative;
            overflow: hidden;
        }
        
        /* 菜单按钮动画 */
        #menu-toggle {
            transition: transform 0.3s ease;
        }
        
        #menu-toggle.menu-active {
            transform: rotate(90deg);
        }
        
        /* 按钮悬停效果增强 */
        button {
            position: relative;
            overflow: hidden;
        }
        
        /* 登录/注册按钮增强效果 */
        .bg-gradient-to-r {
            transition: all 0.3s ease;
        }
        
        .bg-gradient-to-r:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        /* 徽标动画 */
        .w-10.h-10.rounded-full {
            transition: transform 0.3s ease;
        }
        
        .w-10.h-10.rounded-full:hover {
            transform: scale(1.05) rotate(2deg);
        }
        
        /* 页面加载动画 */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* 可访问性增强 */
        a:focus,
        button:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
        
        /* 深色模式适配 */
        @media (prefers-color-scheme: dark) {
            .ripple-effect {
                background-color: rgba(255, 255, 255, 0.2);
            }
        }
        
        /* 响应式设计增强 */
        @media (max-width: 768px) {
            /* 移动端导航栏调整 */
            #main-nav {
                padding-left: 1rem !important;
                padding-right: 1rem !important;
                padding-top: 0.75rem !important;
                padding-bottom: 0.75rem !important;
            }
            
            /* 移动端菜单完全覆盖 */
            #mobile-menu {
                width: 100%;
                max-width: none;
                height: 100vh;
                box-shadow: none;
                z-index: 999;
            }
            
            /* 移动端链接间距调整 */
            #mobile-menu a {
                padding-top: 0.875rem !important;
                padding-bottom: 0.875rem !important;
                font-size: 1rem;
            }
            
            /* 移动端按钮尺寸调整 */
            #auth-buttons button {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }
            
            /* 徽标和标题调整 */
            #main-nav .flex.items-center.space-x-2 {
                margin-left: -0.5rem;
            }
            
            #main-nav .text-xl {
                font-size: 1.125rem;
            }
        }
        
        @media (max-width: 480px) {
            /* 小屏幕特殊处理 */
            #main-nav {
                padding-left: 0.75rem !important;
                padding-right: 0.75rem !important;
            }
            
            /* 小屏幕菜单按钮更大 */
            #menu-toggle {
                padding: 0.5rem;
            }
            
            /* 小屏幕按钮组调整 */
            #auth-buttons {
                flex-direction: column;
                gap: 0.5rem;
                position: absolute;
                top: 100%;
                right: 0.75rem;
                left: 0.75rem;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                padding: 0.75rem;
                border-radius: 0.5rem;
                box-shadow: var(--shadow-light);
                z-index: 100;
            }
            
            #auth-buttons:not(.hidden) {
                display: flex;
            }
            
            /* 移动端下拉菜单位置调整 */
            #mobile-user-menu {
                padding: 0.5rem;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            /* 平板设备调整 */
            .nav-links {
                gap: 0.5rem;
            }
            
            .nav-links a {
                padding-left: 0.75rem;
                padding-right: 0.75rem;
                font-size: 0.875rem;
            }
            
            /* 平板下拉菜单宽度调整 */
            #desktop-more-dropdown,
            #user-dropdown {
                width: 18rem;
            }
        }
        
        /* 大屏幕优化 */
        @media (min-width: 1280px) {
            #main-nav {
                padding-left: 2rem !important;
                padding-right: 2rem !important;
            }
            
            .nav-links {
                gap: 1rem;
            }
        }
    </style>
    <!-- 沉浸式沙盘JavaScript -->
    <script src="immersive_sandbox.js"></script>
</body>
</html>